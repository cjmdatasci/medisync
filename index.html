<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RG MedSync</title>
<!-- React and ReactDOM -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<!-- Babel for JSX compilation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- Tailwind CSS (Required for styling to work) -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>

<style>
  /* Base custom overrides */
  *{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'Inter',sans-serif;}
  textarea{resize:vertical;}
  ::-webkit-scrollbar{width:7px;height:7px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:#B8C4D6;border-radius:6px;}
  
  /* Loading Spinner */
  .spin{display:inline-block;border-radius:50%;animation:spin .6s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ
const SUPA_URL = "https://lwmghkbqdwvqcadhocxa.supabase.co";
const SUPA_KEY = "sb_publishable_2vo76E53tWg9k3OHeT7DRA_AeVe0C6l";
const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const CHAPTERS = [
  {id:0,title:"0. Cover & Demographics",short:"Demographics"},
  {id:1,title:"1. Documents Perused",short:"Documents"},
  {id:2,title:"2. Occupational & Medical Hx",short:"Med History"},
  {id:3,title:"3. Hospital Records",short:"Hospital"},
  {id:4,title:"4. Injuries Sustained",short:"Injuries"},
  {id:5,title:"5. Current Complaints",short:"Complaints"},
  {id:6,title:"6. Clinical Evaluation",short:"Clinical Eval"},
  {id:7,title:"7. Diagnosis",short:"Diagnosis"},
  {id:8,title:"8. Further Management",short:"Management"},
  {id:9,title:"9. Disability & Impairment",short:"Disability"},
  {id:10,title:"10. Discussion",short:"Discussion"}
];

const CH3_PROMPTS = [
  {num:1, text:"Mechanism of accident and date of accident."},
  {num:2, text:"EMS assessment on scene ‚Äî presentation, complaints, exam findings, GCS, suspected diagnosis."},
  {num:3, text:"Transfer to hospital ‚Äî name and mode of transport (ambulance, helicopter, etc.)."},
  {num:4, text:"Date of presentation to hospital and which department."},
  {num:5, text:"Complaints and findings on initial assessment."},
  {num:6, text:"Immediate investigations / treatment rendered."},
  {num:7, text:"Diagnosis."},
  {num:8, text:"Admission, transfer to relevant department, and formal diagnosis."},
  {num:9, text:"Definitive management and treatment prescribed, including dates."},
  {num:10,text:"Post-operative treatment and rehabilitation."},
  {num:11,text:"Discharge and assistive devices / step-down treatment."},
  {num:12,text:"Follow-up and review."}
];

const EXAM_REGIONS_LIST = [
  "Cervical Spine","Thoracic Spine","Lumbar Spine",
  "Shoulder","Elbow, Wrist and Hand","Upper Limb",
  "Pelvis","Hip","Knee","Ankle","Foot",
  "Femur","Tibia and Fibula","Lower Limb"
];

const EXAM_REGIONS = {
  "Cervical Spine":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Spurling's Test"],
  "Thoracic Spine":["Inspection","Palpation","Range of Motion","Sensation","Reflexes"],
  "Lumbar Spine":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Straight Leg Raise (SLR)"],
  "Shoulder":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Neer's Test","Hawkins-Kennedy"],
  "Elbow, Wrist and Hand":["Inspection","Palpation","Range of Motion","Power (grip)","Sensation","Reflexes","Tinel's Test"],
  "Upper Limb":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Special Tests"],
  "Pelvis":["Inspection","Palpation","FABER Test","Compression/Distraction","Pelvic Stability"],
  "Hip":["Inspection","Palpation","Range of Motion","Power","Sensation","FABER Test","Trendelenburg Test"],
  "Knee":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Lachman's Test","McMurray's Test"],
  "Ankle":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Anterior Drawer Test"],
  "Foot":["Inspection","Palpation","Range of Motion","Power","Sensation","Arch assessment"],
  "Femur":["Inspection","Palpation","Length discrepancy","Alignment","Neurovascular status"],
  "Tibia and Fibula":["Inspection","Palpation","Alignment","Rotational assessment","Neurovascular status"],
  "Lower Limb":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Vascular assessment"]
};

const ADL_BASIC = ["Bowel control","Bladder control","Grooming","Toileting","Feeding","Transfer (chair to bed)","Indoor mobility","Dressing","Stairs","Bathing"];
const ADL_ADV   = ["Driving a car","Sexual function","Medical self-care","Money management","Writing & communication","Travelling","Shopping","Cooking","Housework","Moderate activities (pushing/lifting)","Vigorous activities (sport/heavy lifting)"];
const ADL_OPTS = ["N/A","None","Mild","Moderate","Severe"];

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ
function numToWords(n) {
  const ones = ["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const tens = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
  n = parseInt(n, 10);
  if(isNaN(n)) return String(n);
  if(n === 0) return "zero";
  if(n < 20) return ones[n];
  if(n < 100) return tens[Math.floor(n/10)] + (n%10 ? "-" + ones[n%10] : "");
  if(n < 1000) return ones[Math.floor(n/100)] + " hundred" + (n%100 ? " and " + numToWords(n%100) : "");
  return String(n);
}

function parseSAID(id) {
  const cleanId = (id || "").replace(/\s/g, "");
  if (cleanId.length !== 13 || !/^\d+$/.test(cleanId)) return null;
  const yy = cleanId.slice(0, 2);
  const mm = cleanId.slice(2, 4);
  const dd = cleanId.slice(4, 6);
  const currentYear = new Date().getFullYear() % 100;
  const fullYear = parseInt(yy) > currentYear ? "19" + yy : "20" + yy;
  const d = new Date(`${fullYear}-${mm}-${dd}`);
  if (isNaN(d.getTime())) return null;
  return `${fullYear}-${mm}-${dd}`;
}

function calcAge(dob, examDate) {
  if (!dob || !examDate) return "";
  const d1 = new Date(dob), d2 = new Date(examDate);
  if (isNaN(d1) || isNaN(d2)) return "";
  let age = d2.getFullYear() - d1.getFullYear();
  const m = d2.getMonth() - d1.getMonth();
  if (m < 0 || (m === 0 && d2.getDate() < d1.getDate())) age--;
  return age >= 0 ? String(age) : "";
}

function esc(s) {
  return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function newReport() {
  return {
    drName: "", quals: "", drPractice: "", drAddress: "", drPhone: "", drEmail: "", drFax: "", sigImg: "",
    ourRef: "", attRef: "", attorney: "", attContact: "",
    patientName: "", refNum: "", gender: "", dob: "", age: "", address: "", contact: "",
    doi: "", mechanism: "Motor Vehicle Accident", preOccupation: "", postOccupation: "",
    dateExam: "", placeExam: "RG Medlegal Rooms",
    ch2grade: "", ch2tertiary: "", ch2occ: "", ch2postOcc: "",
    ch2injuries: "None reported.", ch2surgery: "None reported.", ch2medical: "None reported.", ch2meds: "None reported.",
    ch1: "", ch3: "", ch3prompts: {}, ch4injuries: [], ch5: "",
    ch6pre: "", ch6cur: "", ch6general: "", ch6msk: {}, examRegions: {},
    ch6scarringImg: "", ch6scarring: "", ch6radiologyImg: "", ch6radiology: "",
    ch7: "", ch8ortho: "", ch8ref: "",
    adlBasic: {}, adlAdv: {}, ch9occ: "", ch9initTx: "", ch9initDx: "", ch9outDx: "",
    wpiRows: [{region:"", impairment:"", reference:"", wpi:""}], ch10: ""
  };
}

// ‚îÄ‚îÄ AI FUNCTION ‚îÄ‚îÄ
async function ai(text, prompt, key) {
  if(!key || !text.trim()) return text;
  const strictPrompt = `
    ${prompt}
    CRITICAL RULES:
    1. Number EVERY single sentence sequentially (e.g., 1.1, 1.2, a, b).
    2. Whenever a number is mentioned, write the digit followed by the word in brackets. Example: "2 (two) weeks", "1 (one) fracture".
    3. Use professional South African Medico-Legal English.
    4. Do not summarize or change clinical facts.
  `;
  try {
    const r = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-api-key": key, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
      body: JSON.stringify({ model: "claude-haiku-4-5-20251001", max_tokens: 2000, messages: [{ role: "user", content: `${strictPrompt}\n\nText:\n${text}` }] })
    });
    const d = await r.json(); return d?.content?.[0]?.text || text;
  } catch { return text; }
}

async function extractReportInfo(text, key) {
  if(!key) return null;
  try {
    const r = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-api-key": key, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
      body: JSON.stringify({ model: "claude-haiku-4-5-20251001", max_tokens: 800, messages: [{ role: "user", content: 'Extract from this referral and return ONLY valid JSON (no markdown):\n{"patientName":"","refNum":"","doi":"","atty":"","attContact":""}\n\nReport:\n' + text.slice(0, 3500) }] })
    });
    const d = await r.json();
    const match = (d?.content?.[0]?.text || "").match(/\{[\s\S]*\}/);
    if(match) return JSON.parse(match[0]);
  } catch {}
  return null;
}

// ‚îÄ‚îÄ COMPONENTS ‚îÄ‚îÄ
function ImageUploader({ label, value, onChange, hint }) {
  const ref = useRef();
  const handle = e => { const f = e.target.files?.[0]; if(!f) return; const rd = new FileReader(); rd.onload = ev => onChange(ev.target.result); rd.readAsDataURL(f); };
  return (
    <div className="mb-4">
      {label && <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">{label}</label>}
      <div className="border-2 border-dashed border-slate-300 rounded-xl p-4 text-center cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors" onClick={() => ref.current.click()}>
        <input ref={ref} type="file" accept="image/*" style={{display:"none"}} onChange={handle}/>
        {value ? <img src={value} className="max-w-[200px] max-h-[140px] rounded-md mx-auto" alt="uploaded"/> : <div><div className="text-3xl mb-1">üì∏</div><div className="text-xs text-slate-500">{hint || "Click to upload image"}</div></div>}
      </div>
      {value && <button className="mt-2 text-xs font-bold text-red-600 hover:text-red-800" onClick={(e) => { e.stopPropagation(); onChange(""); }}>Remove Image</button>}
    </div>
  );
}

function ReportUploader({ onExtract, apiKey }) {
  const ref = useRef(); const [busy, setBusy] = useState(false); const [msg, setMsg] = useState("");
  const handle = async e => {
    const f = e.target.files?.[0]; if(!f) return;
    setBusy(true); setMsg("");
    const text = await f.text().catch(()=>"");
    if (text && apiKey) {
      const info = await extractReportInfo(text, apiKey);
      if (info) { onExtract(info); setMsg("‚úì Information extracted"); } else setMsg("Could not extract.");
    } else setMsg("Set AI key in Account Settings");
    setBusy(false);
  };
  return (
    <div className="bg-indigo-50 border border-indigo-200 p-6 rounded-3xl shadow-sm mb-6">
      <div className="flex items-center justify-between mb-4">
         <div className="font-black text-indigo-900 uppercase tracking-widest text-xs flex items-center gap-2"><span className="text-lg">‚ú®</span> AI Referral Extraction</div>
      </div>
      <div className="border-2 border-dashed border-indigo-300 rounded-xl p-6 text-center cursor-pointer bg-white hover:bg-indigo-50 transition-colors" onClick={() => ref.current.click()}>
        <input ref={ref} type="file" accept=".txt,.csv" style={{display:"none"}} onChange={handle}/>
        <div><div className="text-3xl mb-2">üìÑ</div><div className="text-xs font-bold text-indigo-700">{busy?"Extracting...":"Upload .txt referral letter to auto-fill details"}</div></div>
      </div>
      {msg && <div className="text-xs mt-3 font-bold text-green-700">{msg}</div>}
    </div>
  );
}

function SmartTA({ value, onChange, placeholder, rows=5, label, apiKey }) {
  const [busy, setBusy] = useState(false);
  const runAI = async () => {
    if(!value.trim() || !apiKey) return;
    setBusy(true);
    onChange(await ai(value, "Correct grammar and format the text.", apiKey));
    setBusy(false);
  };
  return (
    <div className="mb-4">
      {label && <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">{label}</label>}
      <div className="relative">
        <textarea rows={rows} className="w-full bg-white border border-slate-200 rounded-xl p-3 pr-14 text-sm outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all" value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>
        <div className="absolute top-2 right-2 flex flex-col gap-1">
          {apiKey && <button className="w-8 h-8 flex items-center justify-center rounded-lg bg-purple-100 text-purple-700 border border-purple-200 hover:bg-purple-200 transition-colors" onClick={runAI} disabled={busy || !value.trim()} title="AI Format">{busy?<div className="spin" style={{width: '16px', height: '16px', borderWidth: '2px', borderColor: 'rgba(126, 34, 206, 0.2)', borderTopColor: '#7e22ce'}}></div>:"‚ú®"}</button>}
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ PREVIEW COMPONENT ‚îÄ‚îÄ
function Preview({ r, onBack }) {
  const fmt = iso => iso ? new Date(iso).toLocaleDateString("en-ZA", {day:"2-digit",month:"long",year:"numeric"}) : "";
  
  const tocHtml = `
    <div style="margin-bottom: 30px;">
      <h2 style="text-align:center; font-size:14pt; border:none; margin-bottom: 15px;">TABLE OF CONTENTS</h2>
      <ul style="list-style-type: none; padding-left: 0; line-height: 1.8;">
        ${CHAPTERS.filter(c=>c.id>0).map(c=>`<li><b>${c.title}</b></li>`).join("")}
      </ul>
    </div>
    <br clear="all" style="page-break-before:always" />
  `;

  const letterhead = `
    <div style="border-bottom: 2px solid #1558A0; padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end;">
      <div>
        <div style="font-size: 24pt; font-weight: bold; color: #1558A0;">${r.drName || "DR. NAME"}</div>
        <div style="font-size: 11pt; font-style: italic; color: #555;">${r.quals || "Qualifications"}</div>
        ${r.drPractice ? `<div style="font-size: 10pt; margin-top: 5px;">${r.drPractice}</div>` : ""}
        ${r.drAddress ? `<div style="font-size: 10pt;">${r.drAddress}</div>` : ""}
      </div>
      <div style="text-align: right;">
        <div style="font-weight: bold; color: #1558A0;">MEDICO-LEGAL REPORT</div>
        <div style="font-size: 10pt;">Tel: ${r.drPhone || "---"}</div>
        <div style="font-size: 10pt;">Email: ${r.drEmail || "---"}</div>
      </div>
    </div>
  `;

  const html = `
    ${letterhead}
    <h1 style="text-align:center; margin-bottom: 20px;">MEDICO-LEGAL ORTHOPAEDIC REPORT</h1>
    <table style="width:100%; border-collapse: collapse; margin-bottom: 30px;">
      <tr><td style="font-weight:bold; background:#f0f0f0; width:30%; padding: 5px; border: 1px solid #ccc;">Our Reference:</td><td style="padding: 5px; border: 1px solid #ccc;">${r.ourRef || "---"}</td><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Attorney Ref:</td><td style="padding: 5px; border: 1px solid #ccc;">${r.attRef || "---"}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Patient Name:</td><td style="font-weight:bold; text-decoration:underline; padding: 5px; border: 1px solid #ccc;">${r.patientName || "---"}</td><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">ID Number:</td><td style="padding: 5px; border: 1px solid #ccc;">${r.refNum || "---"}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Date of Birth:</td><td style="padding: 5px; border: 1px solid #ccc;">${fmt(r.dob)}</td><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Age at Assessment:</td><td style="padding: 5px; border: 1px solid #ccc;">${r.age ? `${r.age} (${numToWords(r.age)}) years` : "---"}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Date of Injury:</td><td style="padding: 5px; border: 1px solid #ccc;">${fmt(r.doi)}</td><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Date of Exam:</td><td style="padding: 5px; border: 1px solid #ccc;">${fmt(r.dateExam)}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0; padding: 5px; border: 1px solid #ccc;">Instructing Attorney:</td><td colspan="3" style="padding: 5px; border: 1px solid #ccc;">${r.attorney || "---"}</td></tr>
    </table>

    <div style="page-break-before: always;"></div>
    ${tocHtml}

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">1. DOCUMENTS PERUSED</h2>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch1 || "None."}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">2. OCCUPATIONAL AND MEDICAL HISTORY</h2>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch2occ || "None."}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">3. SUMMARY OF HOSPITAL RECORDS</h2>
    ${CH3_PROMPTS.map(p => r.ch3prompts?.[p.num] ? `<p><b>3.1.${p.num}</b> ${r.ch3prompts[p.num]}</p>` : "").join("")}
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch3 || ""}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">4. INJURIES SUSTAINED</h2>
    <div style="margin-bottom: 15pt;">${(r.ch4injuries || []).map((inj, i) => `<p>${i+1}. ${inj}</p>`).join("") || "None listed."}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">5. PRE-ACCIDENT & CURRENT COMPLAINTS</h2>
    <table style="width:100%; border-collapse: collapse; margin-bottom:15px;">
      <tr><th style="background:#f0f0f0; width:50%; border: 1px solid #ccc; padding: 5px;">Pre-Accident Complaints</th><th style="background:#f0f0f0; width:50%; border: 1px solid #ccc; padding: 5px;">Current Complaints</th></tr>
      <tr><td style="vertical-align:top; white-space:pre-wrap; border: 1px solid #ccc; padding: 5px;">${r.ch6pre || "None reported."}</td><td style="vertical-align:top; white-space:pre-wrap; border: 1px solid #ccc; padding: 5px;">${r.ch6cur || "None reported."}</td></tr>
    </table>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch5 || ""}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">6. CLINICAL EVALUATION</h2>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch6general || ""}</div>
    ${EXAM_REGIONS_LIST.filter(rg => r.examRegions?.[rg]).map((rg, ri) => `
      <h3 style="margin-top: 15pt;">6.2.${ri+1} ${rg}</h3>
      <div style="margin-bottom: 15pt;">
      ${EXAM_REGIONS[rg].map((f, fi) => r.ch6msk?.[rg]?.[f] ? `<p><b>6.2.${ri+1}.${fi+1} ${f}:</b> ${r.ch6msk[rg][f]}</p>` : "").join("")}
      </div>
    `).join("")}
    <h3 style="margin-top: 15pt;">6.3 Special Investigations</h3>
    ${r.ch6scarringImg ? `<img src="${r.ch6scarringImg}" style="max-height:200px; margin-bottom:10px;"/><br>` : ""}
    <p style="margin-bottom: 15pt;">${r.ch6scarring || ""}</p>
    ${r.ch6radiologyImg ? `<img src="${r.ch6radiologyImg}" style="max-height:200px; margin-bottom:10px;"/><br>` : ""}
    <p style="margin-bottom: 15pt;">${r.ch6radiology || ""}</p>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">7. DIAGNOSIS</h2>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch7 || "None."}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">8. FURTHER MANAGEMENT</h2>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch8ortho || "None."}</div>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">9. DISABILITY & IMPAIRMENT</h2>
    <h3 style="margin-top: 15pt;">9.3.3 Initial Treatment & Diagnosis</h3>
    <p><b>Initial Treatment:</b> ${r.ch9initTx || "---"}</p>
    <p><b>Initial Diagnosis:</b> ${r.ch9initDx || "---"}</p>
    <p><b>Outcome Diagnosis:</b> ${r.ch9outDx || "---"}</p>

    <h2 style="border-bottom: 2px solid #1C2B3A; padding-bottom: 4px; margin-top: 24pt;">10. DISCUSSION</h2>
    <div style="white-space:pre-wrap; margin-bottom: 15pt;">${r.ch10 || "None."}</div>

    <div style="margin-top: 50px; text-align: center;">
      ${r.sigImg ? `<img src="${r.sigImg}" style="height: 80px; margin-bottom: 10px;" />` : `<div style="font-weight:bold; margin-bottom: 10px;">_________________________</div>`}
      <div style="font-weight: bold; font-size: 12pt;">${r.drName || "DOCTOR NAME"}</div>
      <div style="font-style: italic;">${r.quals || "Qualifications"}</div>
      <div style="font-size: 9pt; color: #666; margin-top: 20px;">VALIDITY: This report remains valid for use in a court of law for 2 (two) years from date of first consultation.</div>
    </div>
  `;

  const downloadDoc = () => {
    const mhtml = `MIME-Version: 1.0\nContent-Type: multipart/related; boundary="NEXT.ITEM-BOUNDARY"\n\n--NEXT.ITEM-BOUNDARY\nContent-Type: text/html; charset="utf-8"\nContent-Location: report.html\n\n<!DOCTYPE html>\n<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">\n<head>\n<meta charset="utf-8">\n<title>Report</title>\n<!--[if gte mso 9]>\n<xml>\n<w:WordDocument><w:View>Print</w:View><w:Zoom>100</w:Zoom><w:DoNotOptimizeForBrowser/></w:WordDocument>\n</xml>\n<![endif]-->\n<style>\n@page WordSection1 { size: 595.3pt 841.9pt; margin: 72.0pt 72.0pt 72.0pt 72.0pt; mso-header-margin: 36.0pt; mso-footer-margin: 36.0pt; mso-paper-source: 0; }\ndiv.WordSection1 { page: WordSection1; }\nbody { font-family: 'Times New Roman', serif; font-size: 11pt; color: black; line-height: 1.5; }\ntable { width: 100%; border-collapse: collapse; }\ntd, th { border: 1px solid #ccc; padding: 5px; text-align: left; }\nh1, h2, h3, h4 { text-align: left; }\nimg { max-width: 300px; height: auto; }\n</style>\n</head>\n<body>\n<div class="WordSection1">\n${html}\n</div>\n</body>\n</html>\n--NEXT.ITEM-BOUNDARY--`;
    const blob = new Blob([mhtml], { type: 'application/msword;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `RGMedSync_${r.patientName.replace(/\s+/g,'_')}.doc`;
    a.click();
  };

  return (
    <div className="flex-1 flex flex-col h-screen overflow-hidden bg-slate-200">
      <div className="p-4 bg-white border-b border-slate-300 flex justify-between shadow-sm z-10">
        <button className="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-200 transition" onClick={onBack}>‚óÄ Back to Editor</button>
        <div className="flex gap-3">
          <button className="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 transition" onClick={downloadDoc}>‚¨á Export Word Doc</button>
          <button className="bg-slate-800 text-white px-5 py-2 rounded-lg font-bold shadow-md hover:bg-slate-900 transition" onClick={()=>window.print()}>üñ® Print PDF</button>
        </div>
      </div>
      <div className="flex-1 overflow-y-auto p-8">
        <div className="bg-white max-w-[850px] mx-auto p-[1in] shadow-xl text-[11pt] font-serif text-black leading-relaxed print:shadow-none print:p-0" dangerouslySetInnerHTML={{__html: html}}></div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ LOGIN COMPONENT ‚îÄ‚îÄ
function LoginScreen({ onLoginSuccess }) {
  const [email, setEmail] = useState("");
  const [pass, setPass] = useState("");
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState("");

  const doLogin = async e => {
    e.preventDefault();
    setErr(""); setBusy(true);
    const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
    if (error) setErr(error.message);
    else if (data.session) onLoginSuccess(data.session);
    setBusy(false);
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-50 p-6 font-sans">
      <div className="bg-white p-10 rounded-3xl shadow-2xl max-w-md w-full border border-slate-100 text-center relative overflow-hidden">
        <div className="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center text-3xl mx-auto mb-6 shadow-lg">ü©∫</div>
        <h1 className="text-3xl font-black text-slate-900 mb-2 uppercase tracking-tighter">RG <span className="text-blue-600">MedSync</span></h1>
        <p className="text-slate-500 font-bold uppercase text-[10px] tracking-widest mb-8">Secure Medico-Legal Portal</p>
        
        {err && <div className="bg-red-50 text-red-600 p-3 rounded-xl text-sm font-bold mb-6 border border-red-200">{err}</div>}
        
        <form onSubmit={doLogin} className="space-y-4 text-left">
          <div>
            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Email</label>
            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none transition" required />
          </div>
          <div>
            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Password</label>
            <input type="password" value={pass} onChange={e=>setPass(e.target.value)} className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none transition" required />
          </div>
          <button type="submit" disabled={busy} className="w-full bg-blue-600 text-white font-black uppercase tracking-widest text-sm py-4 rounded-xl shadow-xl hover:bg-blue-700 transition-all disabled:opacity-50 mt-4 flex items-center justify-center">
            {busy ? <div className="spin border-2 border-white/20 border-t-white mr-2" style={{width:16, height:16}}></div> : null}
            {busy ? "Authenticating..." : "Sign In"}
          </button>
        </form>
      </div>
    </div>
  );
}


// ‚îÄ‚îÄ MAIN APP COMPONENT ‚îÄ‚îÄ
function App() {
  const [session, setSession] = useState(null);
  const [reports, setReports] = useState([]);
  const [activeId, setActiveId] = useState(null);
  const [chapter, setChapter] = useState(0);
  const [view, setView] = useState("list");
  const [toast, setToast] = useState(null);
  const [apiKey, setApiKey] = useState(localStorage.getItem("rg_ai_key") || "");

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => setSession(session));
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_, s) => setSession(s));
    return () => subscription.unsubscribe();
  }, []);

  const fetchReports = async () => {
    const { data } = await supabase.from('reports').select('*').order('updated_at', { ascending: false });
    if(data) setReports(data.map(d => ({ dbId: d.id, _ts: d.updated_at, ...d.data })));
  };

  useEffect(() => {
    if(session) {
      fetchReports();
      const channel = supabase.channel('public:reports').on('postgres_changes', { event: '*', schema: 'public', table: 'reports' }, () => {
        fetchReports();
      }).subscribe();
      return () => supabase.removeChannel(channel);
    }
  }, [session]);

  const saveReport = async (rData) => {
    if(!session) return;
    const payload = { user_id: session.user.id, data: rData, updated_at: new Date().toISOString() };
    if (rData.dbId) {
      await supabase.from('reports').update(payload).eq('id', rData.dbId);
    } else {
      const { data } = await supabase.from('reports').insert(payload).select().single();
      if(data) rData.dbId = data.id;
    }
  };

  const updateR = (fn) => {
    setReports(prev => prev.map(r => {
      if(r.dbId !== activeId) return r;
      const updated = { ...fn(r) };
      saveReport(updated);
      return updated;
    }));
  };

  const createReport = async () => {
    const r = newReport();
    const payload = { user_id: session.user.id, data: r, updated_at: new Date().toISOString() };
    const { data } = await supabase.from('reports').insert(payload).select().single();
    if(data) {
      setActiveId(data.id);
      setChapter(0);
      setView("editor");
    }
  };

  const r = reports.find(x => x.dbId === activeId);

  if(!session) return <LoginScreen onLoginSuccess={setSession}/>;

  if(view === "list") return (
    <div className="flex flex-col h-screen bg-slate-50">
      <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md">
        <div className="flex items-center gap-3">
          <div className="bg-blue-600 p-2 rounded-xl shadow-lg text-lg">ü©∫</div>
          <div className="font-black text-xl tracking-tighter uppercase">RG <em className="text-blue-400 not-italic">MedSync</em></div>
        </div>
        <div className="flex gap-3">
          <button className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-xl text-xs font-black uppercase tracking-widest shadow-lg transition flex items-center gap-2" onClick={createReport}>
            <span className="text-lg">‚ûï</span> New Report
          </button>
          <button className="bg-slate-800 text-slate-300 px-5 py-2 rounded-xl text-xs font-black uppercase hover:bg-slate-700 transition" onClick={() => supabase.auth.signOut()}>Logout</button>
        </div>
      </header>

      <div className="flex-1 overflow-y-auto p-8 lg:p-12">
        <div className="max-w-6xl mx-auto">
          <div className="flex justify-between items-end mb-8">
            <div>
              <h2 className="text-3xl font-black text-slate-900 uppercase">Collab Workspace</h2>
              <p className="text-slate-500 font-bold uppercase text-xs tracking-widest mt-1">Shared Medico-Legal Registry</p>
            </div>
          </div>
          
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 mb-10 flex flex-col md:flex-row items-center gap-4">
             <label className="text-xs font-black uppercase tracking-widest text-slate-500">Set AI Key (Local Only): </label>
             <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem("rg_ai_key", e.target.value)}} className="flex-1 bg-slate-50 border border-slate-200 rounded-lg p-3 outline-none focus:ring-2 focus:ring-blue-500 transition" placeholder="sk-ant-..."/>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {reports.map(rpt => (
              <div key={rpt.dbId} className="bg-white p-6 rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer" onClick={()=>{setActiveId(rpt.dbId); setChapter(0); setView("editor");}}>
                <div className="flex justify-between items-center mb-4">
                  <span className="text-[10px] font-black text-blue-600 bg-blue-50 px-3 py-1 rounded-full uppercase tracking-widest">ID: {rpt.dbId.slice(0,6)}</span>
                  <span className="text-slate-400">üìÑ</span>
                </div>
                <h3 className="text-xl font-black text-slate-900 mb-1 truncate">{rpt.patientName || "Untitled Report"}</h3>
                <div className="text-xs text-slate-500 font-medium truncate mb-6">{rpt.ref || "No Reference Set"}</div>
                <div className="border-t border-slate-100 pt-4 flex justify-between items-center text-[10px] font-black text-slate-400 uppercase tracking-widest">
                  <span>{new Date(rpt._ts).toLocaleDateString()}</span>
                  <span className="text-blue-500">‚ñ∂</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
      {toast && <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm z-50">{toast}</div>}
    </div>
  );

  if(view === "preview") return <Preview r={r} onBack={() => setView("editor")} />;

  // EDITOR VIEW
  return (
    <div className="flex flex-col h-screen bg-slate-50 overflow-hidden">
      <header className="bg-slate-900 text-white p-4 flex justify-between items-center shadow-md z-50">
        <div className="flex items-center gap-3">
          <div className="bg-blue-600 p-2 rounded-xl shadow-lg text-lg">ü©∫</div>
          <div className="font-black text-lg tracking-tighter uppercase hidden sm:block">RG <em className="text-blue-400 not-italic">MedSync</em></div>
          <div className="ml-4 flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
            <div className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
            <span className="text-[9px] font-bold uppercase tracking-widest text-slate-300">Auto-Saving</span>
          </div>
        </div>
        <div className="flex gap-3">
          <button className="bg-slate-800 text-slate-300 px-4 py-2 rounded-xl text-[10px] font-black uppercase hover:bg-slate-700 transition" onClick={() => setView("list")}>‚óÄ All Reports</button>
          <button className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-xl text-[10px] font-black uppercase shadow-lg transition flex items-center gap-2" onClick={() => setView("preview")}>
            <span className="text-sm">üëÅ</span> Compile & Preview
          </button>
        </div>
      </header>
      
      <div className="flex flex-1 overflow-hidden">
        {/* SIDEBAR */}
        <div className="w-[280px] bg-slate-900 border-r border-slate-800 flex flex-col text-white shadow-xl z-40 hidden lg:flex">
          <div className="p-6 border-b border-slate-800">
            <div className="font-bold text-sm truncate">{r?.patientName || "New Report"}</div>
            <div className="text-[10px] text-slate-400 uppercase tracking-widest mt-1 truncate">{r?.ref || "No Reference"}</div>
          </div>
          <div className="flex-1 overflow-y-auto p-4 space-y-1">
            {CHAPTERS.map(c => (
              <button key={c.id} className={`w-full text-left p-3 rounded-xl transition-all flex items-center gap-3 text-xs font-bold ${chapter === c.id ? "bg-blue-600 text-white shadow-lg" : "text-slate-400 hover:bg-slate-800 hover:text-white"}`} onClick={() => setChapter(c.id)}>
                <span className={`w-6 h-6 rounded-lg flex items-center justify-center shrink-0 ${chapter === c.id ? "bg-white/20" : "bg-slate-800"}`}>{c.id}</span>
                <span className="truncate">{c.short}</span>
              </button>
            ))}
          </div>
        </div>

        {/* CONTENT */}
        <div className="flex-1 overflow-y-auto bg-slate-50 p-6 lg:p-12 pb-32">
           <div className="max-w-4xl mx-auto">
             <h2 className="text-2xl font-black text-slate-900 uppercase tracking-tight mb-8 pb-4 border-b border-slate-200">{CHAPTERS[chapter].title}</h2>

             {/* CH 0: DEMOGRAPHICS */}
             {chapter === 0 && (
               <div className="space-y-6">
                 <ReportUploader apiKey={apiKey} onExtract={(info) => updateR(p => {
                   const next = {...p, ...info};
                   if(info.refNum) {
                     next.dob = parseSAID(info.refNum) || next.dob;
                     next.age = calcAge(next.dob, next.dateExam) || next.age;
                   }
                   return next;
                 })} />
                 <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                   <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">Patient Details</div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                     <div className="md:col-span-2">
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Patient Name</label>
                       <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.patientName} onChange={e=>updateR(p=>({...p, patientName:e.target.value}))}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">ID Number (Auto DOB)</label>
                       <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.refNum} onChange={e=>{
                         const val = e.target.value; const dob = parseSAID(val); const age = calcAge(dob||r.dob, r.dateExam);
                         updateR(p=>({...p, refNum:val, dob:dob||p.dob, age:age||p.age}));
                       }}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Date of Birth</label>
                       <input type="date" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.dob} onChange={e=>updateR(p=>({...p, dob:e.target.value, age:calcAge(e.target.value, p.dateExam)}))}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Age at Assessment</label>
                       <input className="w-full bg-slate-100 border border-slate-200 rounded-xl p-3 font-bold text-slate-500 cursor-not-allowed" value={r?.age} readOnly/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Date of Injury</label>
                       <input type="date" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.doi} onChange={e=>updateR(p=>({...p, doi:e.target.value}))}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Date of Examination</label>
                       <input type="date" className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.dateExam} onChange={e=>updateR(p=>({...p, dateExam:e.target.value, age:calcAge(p.dob, e.target.value)}))}/>
                     </div>
                   </div>
                 </div>

                 <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                   <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">Practice & Attorney</div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mb-6">
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Doctor Name</label>
                       <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.drName} onChange={e=>updateR(p=>({...p, drName:e.target.value}))}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Qualifications</label>
                       <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.quals} onChange={e=>updateR(p=>({...p, quals:e.target.value}))}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Our Reference</label>
                       <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.ourRef} onChange={e=>updateR(p=>({...p, ourRef:e.target.value}))}/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Instructing Attorney</label>
                       <input className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:ring-2 focus:ring-blue-500 font-bold" value={r?.atty} onChange={e=>updateR(p=>({...p, atty:e.target.value}))}/>
                     </div>
                   </div>
                   <ImageUploader label="Upload Doctor Signature (Used in Final Export)" value={r?.sigImg} onChange={v=>updateR(p=>({...p, sigImg:v}))} />
                 </div>
               </div>
             )}

             {/* CH 6: CLINICAL EVAL */}
             {chapter === 6 && (
               <div className="space-y-6">
                 <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                   <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">6.1 Pre-Accident & Current Complaints</div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                     <SmartTA label="Pre-Accident Complaints" value={r?.ch6pre} onChange={v=>updateR(p=>({...p, ch6pre:v}))} rows={5} apiKey={apiKey} />
                     <SmartTA label="Current Complaints" value={r?.ch6cur} onChange={v=>updateR(p=>({...p, ch6cur:v}))} rows={5} apiKey={apiKey} />
                   </div>
                   <SmartTA label="General Examination Notes" value={r?.ch6general} onChange={v=>updateR(p=>({...p, ch6general:v}))} rows={4} apiKey={apiKey} />
                 </div>
                 
                 <div className="bg-slate-900 p-8 rounded-[2rem] shadow-xl text-white">
                   <div className="font-black uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-700">6.2 Musculoskeletal Regions</div>
                   <div className="flex flex-wrap gap-2 mb-8">
                     {EXAM_REGIONS_LIST.map(reg => (
                       <button key={reg} onClick={()=>updateR(p=>({...p, examRegions:{...p.examRegions, [reg]:!p.examRegions[reg]}}))} className={`px-4 py-2 rounded-xl text-[10px] font-black uppercase transition-all ${r?.examRegions?.[reg] ? "bg-blue-600 shadow-lg" : "bg-slate-800 text-slate-400 hover:bg-slate-700"}`}>
                         {r?.examRegions?.[reg] ? "‚úì " : ""}{reg}
                       </button>
                     ))}
                   </div>
                   <div className="space-y-4">
                     {EXAM_REGIONS_LIST.filter(reg => r?.examRegions?.[reg]).map(reg => (
                       <div key={reg} className="p-6 bg-slate-800 rounded-2xl border border-slate-700">
                         <div className="font-black text-blue-400 uppercase tracking-widest text-xs mb-4">{reg}</div>
                         <div className="space-y-3">
                           {EXAM_REGIONS[reg].map(fld => (
                             <div key={fld}>
                               <label className="block text-[9px] font-black text-slate-300 uppercase tracking-widest mb-1">{fld}</label>
                               <input className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 outline-none focus:border-blue-500 text-sm text-white" value={r?.ch6msk?.[reg]?.[fld] || ""} onChange={e=>updateR(p=>({...p, ch6msk:{...p.ch6msk, [reg]:{...(p.ch6msk?.[reg]||{}), [fld]:e.target.value}}}))}/>
                             </div>
                           ))}
                         </div>
                       </div>
                     ))}
                   </div>
                 </div>

                 <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200 grid grid-cols-1 md:grid-cols-2 gap-8">
                   <div>
                     <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">6.3.1 Scarring & Deformity</div>
                     <ImageUploader value={r?.ch6scarringImg} onChange={v=>updateR(p=>({...p, ch6scarringImg:v}))}/>
                     <SmartTA value={r?.ch6scarring} onChange={v=>updateR(p=>({...p, ch6scarring:v}))} rows={4} apiKey={apiKey} placeholder="Describe scarring..."/>
                   </div>
                   <div>
                     <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">6.3.2 Radiology</div>
                     <ImageUploader value={r?.ch6radiologyImg} onChange={v=>updateR(p=>({...p, ch6radiologyImg:v}))}/>
                     <SmartTA value={r?.ch6radiology} onChange={v=>updateR(p=>({...p, ch6radiology:v}))} rows={4} apiKey={apiKey} placeholder="Radiological findings..."/>
                   </div>
                 </div>
               </div>
             )}

             {/* CH 9: IMPAIRMENT */}
             {chapter === 9 && (
               <div className="space-y-6">
                 <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                   <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">9.3.3 Treatment & Outcomes</div>
                   <div className="mb-4">
                     <div className="flex justify-between items-center mb-2">
                       <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Initial Treatment</label>
                       <button className="text-[10px] font-black text-blue-600 uppercase hover:text-blue-800" onClick={()=>updateR(p=>({...p, ch9initTx: p.ch5 || "Pulled from Chapter 5"}))}>Pull from Chapter 5</button>
                     </div>
                     <textarea rows={3} value={r?.ch9initTx} onChange={e=>updateR(p=>({...p, ch9initTx:e.target.value}))} className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-blue-500 text-sm"/>
                   </div>
                   <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Initial Diagnosis</label>
                       <textarea rows={3} value={r?.ch9initDx} onChange={e=>updateR(p=>({...p, ch9initDx:e.target.value}))} className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-blue-500 text-sm"/>
                     </div>
                     <div>
                       <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Outcome Diagnosis</label>
                       <textarea rows={3} value={r?.ch9outDx} onChange={e=>updateR(p=>({...p, ch9outDx:e.target.value}))} className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 outline-none focus:border-blue-500 text-sm"/>
                     </div>
                   </div>
                 </div>
                 <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                   <div className="font-black text-slate-900 uppercase tracking-widest text-sm mb-6 pb-2 border-b border-slate-100">Whole Person Impairment (WPI)</div>
                   <div className="space-y-3 mb-6">
                     {r?.wpiRows?.map((row, i) => (
                       <div key={i} className="flex gap-3 items-center">
                         <input placeholder="Region" value={row.region} onChange={e=>{const nr=[...r.wpiRows]; nr[i].region=e.target.value; updateR(p=>({...p, wpiRows:nr}))}} className="flex-1 bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm outline-none focus:border-blue-500"/>
                         <input placeholder="Impairment" value={row.impairment} onChange={e=>{const nr=[...r.wpiRows]; nr[i].impairment=e.target.value; updateR(p=>({...p, wpiRows:nr}))}} className="flex-1 bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm outline-none focus:border-blue-500"/>
                         <input placeholder="WPI %" value={row.wpi} onChange={e=>{const nr=[...r.wpiRows]; nr[i].wpi=e.target.value; updateR(p=>({...p, wpiRows:nr}))}} className="w-24 bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm outline-none focus:border-blue-500 text-center font-bold"/>
                         <button className="w-10 h-10 flex items-center justify-center bg-red-100 text-red-600 rounded-lg font-bold hover:bg-red-200 transition" onClick={()=>{const nr=r.wpiRows.filter((_,x)=>x!==i); updateR(p=>({...p, wpiRows:nr}))}}>‚úï</button>
                       </div>
                     ))}
                   </div>
                   <button className="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-800 transition shadow-md" onClick={()=>updateR(p=>({...p, wpiRows:[...(p.wpiRows||[]), {region:"", impairment:"", wpi:""}]}))}>‚ûï Add Row</button>
                 </div>
               </div>
             )}

             {/* STANDARD DICTATION FOR OTHER CHAPTERS */}
             {(chapter !== 0 && chapter !== 6 && chapter !== 9) && (
               <div className="bg-white p-8 rounded-[2rem] shadow-sm border border-slate-200">
                 <SmartTA label={`${CHAPTERS[chapter].title} Content`} value={r?.[`ch${chapter}`] || ""} onChange={v=>updateR(p=>({...p, [`ch${chapter}`]:v}))} rows={15} apiKey={apiKey}/>
               </div>
             )}
           </div>
        </div>
      </div>
      {toast && <div className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm z-50">{toast}</div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>

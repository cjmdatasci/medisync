<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>RG MedSync</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#F3F5F8;
  --surface:#FFFFFF;
  --sidebar-bg:#1C2B3A;
  --topbar-bg:#FFFFFF;
  --border:#DDE3ED;
  --border-strong:#B8C4D6;
  --divider:#EDF0F5;
  --primary:#1558A0;
  --primary-hover:#0F4A8A;
  --primary-light:#EBF3FB;
  --primary-border:#93C4E8;
  --primary-text:#1558A0;
  --sb-accent:#60A5FA;
  --sb-accent-bg:rgba(96,165,250,.12);
  --success:#0D7A4E;
  --success-bg:#D1FAE5;
  --warning:#92400E;
  --danger:#B91C1C;
  --danger-bg:#FEE2E2;
  --purple:#7C3AED;
  --purple-light:#EDE9FE;
  --purple-border:#C4B5FD;
  --ink:#0F1923;
  --body:#2D3B4E;
  --muted:#596779;
  --subtle:#8393A5;
  --sb-text:#CBD5E1;
  --sb-muted:#64748B;
  --sidebar-w:260px;
  --topbar-h:64px;
  --radius-sm:6px;
  --radius:10px;
  --radius-lg:16px;
  --shadow-xs:0 1px 2px rgba(15,25,35,.06);
  --shadow-sm:0 1px 4px rgba(15,25,35,.08);
  --shadow-lg:0 8px 32px rgba(15,25,35,.14);
}
html,body,#root{height:100%;background:var(--bg);font-family:'Inter',sans-serif;font-size:14px;color:var(--body);}
button,input,select,textarea{font-family:'Inter',sans-serif;}
textarea{resize:vertical;}
::-webkit-scrollbar{width:7px;height:7px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border-strong);border-radius:6px;}
a{text-decoration:none;color:var(--primary);}
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}
.topbar{height:var(--topbar-h);background:var(--topbar-bg);display:flex;align-items:center;padding:0 24px;gap:16px;box-shadow:var(--shadow-xs);border-bottom:2px solid var(--primary);z-index:200;}
.t-logo{display:flex;align-items:center;gap:12px;}
.t-logo-mark{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,var(--primary) 0%,#1E88D4 100%);display:flex;align-items:center;justify-content:center;font-size:18px;color:#fff;}
.t-logo-text{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--ink);}
.t-logo-text em{color:var(--primary);font-style:normal;}
.status-pill{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;}
.status-pill.saving{color:var(--warning);background:var(--warning-bg);}
.status-pill.saved{color:var(--success);background:var(--success-bg);}
.status-dot{width:6px;height:6px;border-radius:50%;background:currentColor;}
.status-dot.blink{animation:sdot 1.2s infinite;}
@keyframes sdot{0%,100%{opacity:1;}50%{opacity:.2;}}
.btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border-radius:var(--radius-sm);border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;}
.btn-p{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(21,88,160,.2);}
.btn-p:hover{background:var(--primary-hover);}
.btn-s{background:#fff;color:var(--body);border:1.5px solid var(--border);}
.btn-s:hover{background:var(--bg);border-color:var(--border-strong);}
.btn-d{background:var(--danger-bg);color:var(--danger);}
.btn-sm{padding:7px 12px;font-size:12px;}
.body-wrap{display:flex;flex:1;overflow:hidden;}
.sidebar{width:var(--sidebar-w);background:var(--sidebar-bg);display:flex;flex-direction:column;border-right:1px solid rgba(0,0,0,.2);}
.sb-rpt{padding:20px 16px;border-bottom:1px solid rgba(255,255,255,.06);}
.sb-rpt-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:#fff;margin-bottom:4px;}
.sb-rpt-meta{font-size:11px;color:var(--sb-muted);}
.sb-nav{flex:1;overflow-y:auto;padding:12px 8px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:12px;border-radius:var(--radius-sm);font-size:13px;color:var(--sb-text);background:none;border:none;width:100%;text-align:left;cursor:pointer;margin-bottom:2px;}
.nav-item:hover{background:rgba(255,255,255,.06);color:#fff;}
.nav-item.active{color:var(--sb-accent);background:var(--sb-accent-bg);font-weight:600;box-shadow:inset 3px 0 0 var(--sb-accent);}
.nav-num{width:22px;height:22px;border-radius:6px;background:rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:var(--sb-muted);}
.nav-item.active .nav-num{background:rgba(56,189,248,.2);color:var(--sb-accent);}
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.content{flex:1;overflow-y:auto;padding:32px 40px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;margin-bottom:20px;box-shadow:var(--shadow-sm);}
.card-h{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--divider);}
.card-ico{width:36px;height:36px;border-radius:8px;background:var(--primary-light);color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:18px;}
.card-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--ink);}
.field{margin-bottom:16px;}
.field label{display:block;font-size:12px;font-weight:600;color:var(--body);margin-bottom:8px;}
.field input,.field select,.field textarea{width:100%;background:#fff;border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:12px;font-size:14px;color:var(--ink);outline:none;transition:border-color .15s;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;}
.ta-wrap{position:relative;}
.ta-tools{position:absolute;top:10px;right:10px;display:flex;flex-direction:column;gap:6px;}
.mic{width:36px;height:36px;border-radius:8px;border:1.5px solid var(--border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;}
.mic.on{background:var(--danger);color:#fff;border-color:transparent;animation:pulse 1.5s infinite;}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(185,28,28,.4);}70%{box-shadow:0 0 0 10px rgba(185,28,28,0);}}
.aibtn{width:36px;height:36px;border-radius:8px;border:1.5px solid var(--purple-border);background:var(--purple-light);color:var(--purple);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;}
.spin{display:inline-block;width:16px;height:16px;border:2px solid rgba(0,0,0,.1);border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.login-root{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#EFF6FF 0%,#F0FDFA 100%);}
.login-card{background:#fff;padding:40px;border-radius:24px;box-shadow:var(--shadow-lg);width:100%;max-width:420px;}
.preview-bg{flex:1;overflow-y:auto;background:#E8ECF2;padding:40px;}
.preview-page{background:#fff;color:#000;max-width:850px;margin:0 auto;padding:1in;box-shadow:var(--shadow-lg);font-family:'Times New Roman',serif;font-size:11pt;line-height:1.6;}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:var(--sidebar-bg);color:#fff;padding:12px 20px;border-radius:8px;font-weight:600;z-index:999;box-shadow:var(--shadow-lg);}
table.adl-tbl{width:100%;border-collapse:collapse;font-size:13px;}
table.adl-tbl th{background:#F8FAFC;text-align:left;padding:10px;border:1px solid var(--border);}
table.adl-tbl td{padding:10px;border:1px solid var(--border);}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ
const SUPA_URL = "https://lwmghkbqdwvqcadhocxa.supabase.co";
const SUPA_KEY = "sb_publishable_2vo76E53tWg9k3OHeT7DRA_AeVe0C6l";
const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

// ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ
const CHAPTERS = [
  {id:0,title:"0. Cover & Demographics",short:"Demographics"},
  {id:1,title:"1. Documents Perused",short:"Documents"},
  {id:2,title:"2. Occupational & Medical Hx",short:"Med History"},
  {id:3,title:"3. Hospital Records",short:"Hospital"},
  {id:4,title:"4. Injuries Sustained",short:"Injuries"},
  {id:5,title:"5. Current Complaints",short:"Complaints"},
  {id:6,title:"6. Clinical Evaluation",short:"Clinical Eval"},
  {id:7,title:"7. Diagnosis",short:"Diagnosis"},
  {id:8,title:"8. Further Management",short:"Management"},
  {id:9,title:"9. Disability & Impairment",short:"Disability"},
  {id:10,title:"10. Discussion",short:"Discussion"}
];

const CH3_PROMPTS = [
  {num:1, text:"Mechanism of accident and date of accident."},
  {num:2, text:"EMS assessment on scene ‚Äî presentation, complaints, exam findings, GCS, suspected diagnosis."},
  {num:3, text:"Transfer to hospital ‚Äî name and mode of transport (ambulance, helicopter, etc.)."},
  {num:4, text:"Date of presentation to hospital and which department."},
  {num:5, text:"Complaints and findings on initial assessment."},
  {num:6, text:"Immediate investigations / treatment rendered."},
  {num:7, text:"Diagnosis."},
  {num:8, text:"Admission, transfer to relevant department, and formal diagnosis."},
  {num:9, text:"Definitive management and treatment prescribed, including dates."},
  {num:10,text:"Post-operative treatment and rehabilitation."},
  {num:11,text:"Discharge and assistive devices / step-down treatment."},
  {num:12,text:"Follow-up and review."}
];

const EXAM_REGIONS_LIST = [
  "Cervical Spine","Thoracic Spine","Lumbar Spine",
  "Shoulder","Elbow, Wrist and Hand","Upper Limb",
  "Pelvis","Hip","Knee","Ankle","Foot",
  "Femur","Tibia and Fibula","Lower Limb"
];

const EXAM_REGIONS = {
  "Cervical Spine":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Spurling's Test"],
  "Thoracic Spine":["Inspection","Palpation","Range of Motion","Sensation","Reflexes"],
  "Lumbar Spine":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Straight Leg Raise (SLR)"],
  "Shoulder":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Neer's Test","Hawkins-Kennedy"],
  "Elbow, Wrist and Hand":["Inspection","Palpation","Range of Motion","Power (grip)","Sensation","Reflexes","Tinel's Test"],
  "Upper Limb":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Special Tests"],
  "Pelvis":["Inspection","Palpation","FABER Test","Compression/Distraction","Pelvic Stability"],
  "Hip":["Inspection","Palpation","Range of Motion","Power","Sensation","FABER Test","Trendelenburg Test"],
  "Knee":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Lachman's Test","McMurray's Test"],
  "Ankle":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Anterior Drawer Test"],
  "Foot":["Inspection","Palpation","Range of Motion","Power","Sensation","Arch assessment"],
  "Femur":["Inspection","Palpation","Length discrepancy","Alignment","Neurovascular status"],
  "Tibia and Fibula":["Inspection","Palpation","Alignment","Rotational assessment","Neurovascular status"],
  "Lower Limb":["Inspection","Palpation","Range of Motion","Power","Sensation","Reflexes","Vascular assessment"]
};

const ADL_BASIC = ["Bowel control","Bladder control","Grooming","Toileting","Feeding","Transfer (chair to bed)","Indoor mobility","Dressing","Stairs","Bathing"];
const ADL_ADV   = ["Driving a car","Sexual function","Medical self-care","Money management","Writing & communication","Travelling","Shopping","Cooking","Housework","Moderate activities (pushing/lifting)","Vigorous activities (sport/heavy lifting)"];
const ADL_OPTS = ["N/A","None","Mild","Moderate","Severe"];

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ
function numToWords(n) {
  const ones = ["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"];
  const tens = ["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"];
  n = parseInt(n, 10);
  if(isNaN(n)) return String(n);
  if(n === 0) return "zero";
  if(n < 20) return ones[n];
  if(n < 100) return tens[Math.floor(n/10)] + (n%10 ? "-" + ones[n%10] : "");
  if(n < 1000) return ones[Math.floor(n/100)] + " hundred" + (n%100 ? " and " + numToWords(n%100) : "");
  return String(n);
}

function parseSAID(id) {
  const cleanId = (id || "").replace(/\s/g, "");
  if (cleanId.length !== 13 || !/^\d+$/.test(cleanId)) return null;
  const yy = cleanId.slice(0, 2);
  const mm = cleanId.slice(2, 4);
  const dd = cleanId.slice(4, 6);
  const currentYear = new Date().getFullYear() % 100;
  const fullYear = parseInt(yy) > currentYear ? "19" + yy : "20" + yy;
  const d = new Date(`${fullYear}-${mm}-${dd}`);
  if (isNaN(d.getTime())) return null;
  return `${fullYear}-${mm}-${dd}`;
}

function calcAge(dob, examDate) {
  if (!dob || !examDate) return "";
  const d1 = new Date(dob), d2 = new Date(examDate);
  if (isNaN(d1) || isNaN(d2)) return "";
  let age = d2.getFullYear() - d1.getFullYear();
  const m = d2.getMonth() - d1.getMonth();
  if (m < 0 || (m === 0 && d2.getDate() < d1.getDate())) age--;
  return age >= 0 ? String(age) : "";
}

function esc(s) {
  return String(s || "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

function newReport() {
  return {
    drName: "", quals: "", drPractice: "", drAddress: "", drPhone: "", drEmail: "", drFax: "", sigImg: "",
    ourRef: "", attRef: "", attorney: "", attContact: "",
    patientName: "", refNum: "", gender: "", dob: "", age: "", address: "", contact: "",
    doi: "", mechanism: "Motor Vehicle Accident", preOccupation: "", postOccupation: "",
    dateExam: "", placeExam: "RG Medlegal Rooms",
    ch2grade: "", ch2tertiary: "", ch2occ: "", ch2postOcc: "",
    ch2injuries: "None reported.", ch2surgery: "None reported.", ch2medical: "None reported.", ch2meds: "None reported.",
    ch1: "", ch3: "", ch3prompts: {}, ch4injuries: [], ch5: "",
    ch6pre: "", ch6cur: "", ch6general: "", ch6msk: {}, examRegions: {},
    ch6scarringImg: "", ch6scarring: "", ch6radiologyImg: "", ch6radiology: "",
    ch7: "", ch8ortho: "", ch8ref: "",
    adlBasic: {}, adlAdv: {}, ch9occ: "", ch9initTx: "", ch9initDx: "", ch9outDx: "",
    wpiRows: [{region:"", impairment:"", reference:"", wpi:""}], ch10: ""
  };
}

// ‚îÄ‚îÄ AI FUNCTION ‚îÄ‚îÄ
async function ai(text, prompt, key) {
  if(!key || !text.trim()) return text;
  const strictPrompt = `
    ${prompt}
    CRITICAL RULES:
    1. Number EVERY single sentence sequentially (e.g., 1.1, 1.2, a, b).
    2. Whenever a number is mentioned, write the digit followed by the word in brackets. Example: "2 (two) weeks", "1 (one) fracture".
    3. Use professional South African Medico-Legal English.
    4. Do not summarize or change clinical facts.
  `;
  try {
    const r = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-api-key": key, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
      body: JSON.stringify({ model: "claude-haiku-4-5-20251001", max_tokens: 2000, messages: [{ role: "user", content: `${strictPrompt}\n\nText:\n${text}` }] })
    });
    const d = await r.json(); return d?.content?.[0]?.text || text;
  } catch { return text; }
}

async function extractReportInfo(text, key) {
  if(!key) return null;
  try {
    const r = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-api-key": key, "anthropic-version": "2023-06-01", "anthropic-dangerous-direct-browser-access": "true" },
      body: JSON.stringify({ model: "claude-haiku-4-5-20251001", max_tokens: 800, messages: [{ role: "user", content: 'Extract from this referral and return ONLY valid JSON (no markdown):\n{"patientName":"","refNum":"","doi":"","atty":"","attContact":""}\n\nReport:\n' + text.slice(0, 3500) }] })
    });
    const d = await r.json();
    const match = (d?.content?.[0]?.text || "").match(/\{[\s\S]*\}/);
    if(match) return JSON.parse(match[0]);
  } catch {}
  return null;
}

// ‚îÄ‚îÄ COMPONENTS ‚îÄ‚îÄ
function ImageUploader({ label, value, onChange, hint }) {
  const ref = useRef();
  const handle = e => { const f = e.target.files?.[0]; if(!f) return; const rd = new FileReader(); rd.onload = ev => onChange(ev.target.result); rd.readAsDataURL(f); };
  return (
    <div className="field">
      {label && <label>{label}</label>}
      <div style={{border:"2px dashed var(--border-strong)",borderRadius:8,padding:16,textAlign:"center",cursor:"pointer",background:"var(--bg)"}} onClick={() => ref.current.click()}>
        <input ref={ref} type="file" accept="image/*" style={{display:"none"}} onChange={handle}/>
        {value ? <img src={value} style={{maxWidth:200,maxHeight:140,borderRadius:6}} alt="uploaded"/> : <div><div style={{fontSize:26}}>üì∏</div><div style={{fontSize:12,color:"var(--muted)"}}>{hint || "Click to upload image"}</div></div>}
      </div>
      {value && <button className="btn btn-d btn-sm" style={{marginTop:6}} onClick={(e) => { e.stopPropagation(); onChange(""); }}>Remove</button>}
    </div>
  );
}

function ReportUploader({ onExtract, apiKey }) {
  const ref = useRef(); const [busy, setBusy] = useState(false); const [msg, setMsg] = useState("");
  const handle = async e => {
    const f = e.target.files?.[0]; if(!f) return;
    setBusy(true); setMsg("");
    const text = await f.text().catch(()=>"");
    if (text && apiKey) {
      const info = await extractReportInfo(text, apiKey);
      if (info) { onExtract(info); setMsg("‚úì Information extracted"); } else setMsg("Could not extract.");
    } else setMsg("Set AI key in Account Settings");
    setBusy(false);
  };
  return (
    <div className="card" style={{background:"var(--primary-light)", borderColor:"var(--primary-border)"}}>
      <div className="card-h"><div className="card-ico">üìÑ</div><div><div className="card-title">Auto-Extract from Referral</div></div></div>
      <div style={{border:"2px dashed var(--primary)",borderRadius:8,padding:16,textAlign:"center",cursor:"pointer",background:"#fff"}} onClick={() => ref.current.click()}>
        <input ref={ref} type="file" accept=".txt,.csv" style={{display:"none"}} onChange={handle}/>
        <div><div style={{fontSize:26}}>ü™Ñ</div><div style={{fontSize:12,fontWeight:600,color:"var(--primary)"}}>{busy?"Extracting...":"Upload .txt referral letter"}</div></div>
      </div>
      {msg && <div style={{fontSize:12,marginTop:6,color:"var(--success)",fontWeight:600}}>{msg}</div>}
    </div>
  );
}

function SmartTA({ value, onChange, placeholder, rows=5, label, apiKey }) {
  const [busy, setBusy] = useState(false);
  const runAI = async () => {
    if(!value.trim() || !apiKey) return;
    setBusy(true);
    onChange(await ai(value, "Correct grammar and format the text.", apiKey));
    setBusy(false);
  };
  return (
    <div className="field">
      {label && <label>{label}</label>}
      <div className="ta-wrap">
        <textarea rows={rows} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>
        <div className="ta-tools">
          {apiKey && <button className="aibtn" onClick={runAI} disabled={busy || !value.trim()} title="AI Format">{busy?<div className="spin"></div>:"‚ú®"}</button>}
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ PREVIEW COMPONENT ‚îÄ‚îÄ
function Preview({ r, onBack }) {
  const fmt = iso => iso ? new Date(iso).toLocaleDateString("en-ZA", {day:"2-digit",month:"long",year:"numeric"}) : "";
  
  const tocHtml = `
    <h2 style="text-align:center; font-size:14pt; border:none;">TABLE OF CONTENTS</h2>
    <table style="width:100%; border:none;">
      ${CHAPTERS.filter(c=>c.id>0).map(c=>`<tr><td style="border:none; padding:4px 0; font-weight:bold; font-size:11pt;">${c.title}</td></tr>`).join("")}
    </table>
    <hr style="margin:20px 0;" />
  `;

  const letterhead = `
    <div style="border-bottom: 2px solid #1558A0; padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end;">
      <div>
        <div style="font-size: 24pt; font-weight: bold; color: #1558A0;">${r.drName || "DR. NAME"}</div>
        <div style="font-size: 11pt; font-style: italic; color: #555;">${r.quals || "Qualifications"}</div>
        ${r.drPractice ? `<div style="font-size: 10pt; margin-top: 5px;">${r.drPractice}</div>` : ""}
        ${r.drAddress ? `<div style="font-size: 10pt;">${r.drAddress}</div>` : ""}
      </div>
      <div style="text-align: right;">
        <div style="font-weight: bold; color: #1558A0;">MEDICO-LEGAL REPORT</div>
        <div style="font-size: 10pt;">Tel: ${r.drPhone || "---"}</div>
        <div style="font-size: 10pt;">Email: ${r.drEmail || "---"}</div>
      </div>
    </div>
  `;

  const html = `
    ${letterhead}
    <h1 style="text-align:center; margin-bottom: 20px;">MEDICO-LEGAL ORTHOPAEDIC REPORT</h1>
    <table style="width:100%; border-collapse: collapse; margin-bottom: 30px;">
      <tr><td style="font-weight:bold; background:#f0f0f0; width:30%;">Our Reference:</td><td>${r.ourRef || "---"}</td><td style="font-weight:bold; background:#f0f0f0;">Attorney Ref:</td><td>${r.attRef || "---"}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0;">Patient Name:</td><td style="font-weight:bold; text-decoration:underline;">${r.patientName || "---"}</td><td style="font-weight:bold; background:#f0f0f0;">ID Number:</td><td>${r.refNum || "---"}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0;">Date of Birth:</td><td>${fmt(r.dob)}</td><td style="font-weight:bold; background:#f0f0f0;">Age at Assessment:</td><td>${r.age ? `${r.age} (${numToWords(r.age)}) years` : "---"}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0;">Date of Injury:</td><td>${fmt(r.doi)}</td><td style="font-weight:bold; background:#f0f0f0;">Date of Exam:</td><td>${fmt(r.dateExam)}</td></tr>
      <tr><td style="font-weight:bold; background:#f0f0f0;">Instructing Attorney:</td><td colspan="3">${r.attorney || "---"}</td></tr>
    </table>

    <div style="page-break-before: always;"></div>
    ${tocHtml}

    <h2>1. DOCUMENTS PERUSED</h2>
    <div style="white-space:pre-wrap;">${r.ch1 || "None."}</div>

    <h2>2. OCCUPATIONAL AND MEDICAL HISTORY</h2>
    <div style="white-space:pre-wrap;">${r.ch2occ || "None."}</div>

    <h2>3. SUMMARY OF HOSPITAL RECORDS</h2>
    ${CH3_PROMPTS.map(p => r.ch3prompts?.[p.num] ? `<p><b>3.1.${p.num}</b> ${r.ch3prompts[p.num]}</p>` : "").join("")}
    <div style="white-space:pre-wrap;">${r.ch3 || ""}</div>

    <h2>4. INJURIES SUSTAINED</h2>
    ${(r.ch4injuries || []).map((inj, i) => `<p>${i+1}. ${inj}</p>`).join("") || "None listed."}

    <h2>5. PRE-ACCIDENT & CURRENT COMPLAINTS</h2>
    <table style="width:100%; border-collapse: collapse; margin-bottom:15px;">
      <tr><th style="background:#f0f0f0; width:50%;">Pre-Accident Complaints</th><th style="background:#f0f0f0; width:50%;">Current Complaints</th></tr>
      <tr><td style="vertical-align:top; white-space:pre-wrap;">${r.ch6pre || "None reported."}</td><td style="vertical-align:top; white-space:pre-wrap;">${r.ch6cur || "None reported."}</td></tr>
    </table>
    <div style="white-space:pre-wrap;">${r.ch5 || ""}</div>

    <h2>6. CLINICAL EVALUATION</h2>
    <div style="white-space:pre-wrap;">${r.ch6general || ""}</div>
    ${EXAM_REGIONS_LIST.filter(rg => r.examRegions?.[rg]).map((rg, ri) => `
      <h3>6.2.${ri+1} ${rg}</h3>
      ${EXAM_REGIONS[rg].map((f, fi) => r.ch6msk?.[rg]?.[f] ? `<p><b>6.2.${ri+1}.${fi+1} ${f}:</b> ${r.ch6msk[rg][f]}</p>` : "").join("")}
    `).join("")}
    <h3>6.3 Special Investigations</h3>
    ${r.ch6scarringImg ? `<img src="${r.ch6scarringImg}" style="max-height:200px; margin-bottom:10px;"/><br>` : ""}
    <p>${r.ch6scarring || ""}</p>
    ${r.ch6radiologyImg ? `<img src="${r.ch6radiologyImg}" style="max-height:200px; margin-bottom:10px;"/><br>` : ""}
    <p>${r.ch6radiology || ""}</p>

    <h2>7. DIAGNOSIS</h2>
    <div style="white-space:pre-wrap;">${r.ch7 || "None."}</div>

    <h2>8. FURTHER MANAGEMENT</h2>
    <div style="white-space:pre-wrap;">${r.ch8ortho || "None."}</div>

    <h2>9. DISABILITY & IMPAIRMENT</h2>
    <h3>9.3.3 Initial Treatment & Diagnosis</h3>
    <p><b>Initial Treatment:</b> ${r.ch9initTx || "---"}</p>
    <p><b>Initial Diagnosis:</b> ${r.ch9initDx || "---"}</p>
    <p><b>Outcome Diagnosis:</b> ${r.ch9outDx || "---"}</p>

    <h2>10. DISCUSSION</h2>
    <div style="white-space:pre-wrap;">${r.ch10 || "None."}</div>

    <div style="margin-top: 50px; text-align: center;">
      ${r.sigImg ? `<img src="${r.sigImg}" style="height: 80px; margin-bottom: 10px;" />` : `<div style="font-weight:bold; margin-bottom: 10px;">_________________________</div>`}
      <div style="font-weight: bold; font-size: 12pt;">${r.drName || "DOCTOR NAME"}</div>
      <div style="font-style: italic;">${r.quals || "Qualifications"}</div>
      <div style="font-size: 9pt; color: #666; margin-top: 20px;">VALIDITY: This report remains valid for use in a court of law for 2 (two) years from date of first consultation.</div>
    </div>
  `;

  const downloadDoc = () => {
    const mhtml = `MIME-Version: 1.0\nContent-Type: multipart/related; boundary="NEXT.ITEM-BOUNDARY"\n\n--NEXT.ITEM-BOUNDARY\nContent-Type: text/html; charset="utf-8"\nContent-Location: report.html\n\n<!DOCTYPE html>\n<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">\n<head>\n<meta charset="utf-8">\n<title>Report</title>\n<!--[if gte mso 9]>\n<xml>\n<w:WordDocument><w:View>Print</w:View><w:Zoom>100</w:Zoom><w:DoNotOptimizeForBrowser/></w:WordDocument>\n</xml>\n<![endif]-->\n<style>\n@page WordSection1 { size: 595.3pt 841.9pt; margin: 72.0pt 72.0pt 72.0pt 72.0pt; mso-header-margin: 36.0pt; mso-footer-margin: 36.0pt; mso-paper-source: 0; }\ndiv.WordSection1 { page: WordSection1; }\nbody { font-family: 'Times New Roman', serif; font-size: 11pt; color: black; line-height: 1.5; }\ntable { width: 100%; border-collapse: collapse; }\ntd, th { border: 1px solid #ccc; padding: 5px; text-align: left; }\nh1, h2, h3, h4 { text-align: left; }\nimg { max-width: 300px; height: auto; }\n</style>\n</head>\n<body>\n<div class="WordSection1">\n${html}\n</div>\n</body>\n</html>\n--NEXT.ITEM-BOUNDARY--`;
    const blob = new Blob([mhtml], { type: 'application/msword;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `RGMedSync_${r.patientName.replace(/\s+/g,'_')}.doc`;
    a.click();
  };

  return (
    <div style={{flex:1, display:"flex", flexDirection:"column", overflow:"hidden"}}>
      <div style={{padding:"15px 30px", background:"#fff", borderBottom:"1px solid #ddd", display:"flex", justifyContent:"space-between"}}>
        <button className="btn btn-s" onClick={onBack}>‚óÄ Back to Editor</button>
        <div>
          <button className="btn btn-p" onClick={downloadDoc} style={{marginRight:"10px"}}>‚¨á Export Word Doc</button>
          <button className="btn btn-s" onClick={()=>window.print()}>üñ® Print PDF</button>
        </div>
      </div>
      <div className="preview-bg">
        <div className="preview-page" dangerouslySetInnerHTML={{__html: html}}></div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ MAIN APP COMPONENT ‚îÄ‚îÄ
function App() {
  const [session, setSession] = useState(null);
  const [reports, setReports] = useState([]);
  const [activeId, setActiveId] = useState(null);
  const [chapter, setChapter] = useState(0);
  const [view, setView] = useState("list");
  const [toast, setToast] = useState(null);
  const [apiKey, setApiKey] = useState(localStorage.getItem("rg_ai_key") || "");

  useEffect(() => {
    supabase.auth.getSession().then(({ data: { session } }) => setSession(session));
    const { data: { subscription } } = supabase.auth.onAuthStateChange((_, s) => setSession(s));
    return () => subscription.unsubscribe();
  }, []);

  const fetchReports = async () => {
    const { data } = await supabase.from('reports').select('*').order('updated_at', { ascending: false });
    if(data) setReports(data.map(d => ({ dbId: d.id, _ts: d.updated_at, ...d.data })));
  };

  useEffect(() => {
    if(session) {
      fetchReports();
      const channel = supabase.channel('public:reports').on('postgres_changes', { event: '*', schema: 'public', table: 'reports' }, () => {
        fetchReports();
      }).subscribe();
      return () => supabase.removeChannel(channel);
    }
  }, [session]);

  const saveReport = async (rData) => {
    if(!session) return;
    const payload = { user_id: session.user.id, data: rData, updated_at: new Date().toISOString() };
    if (rData.dbId) {
      await supabase.from('reports').update(payload).eq('id', rData.dbId);
    } else {
      const { data } = await supabase.from('reports').insert(payload).select().single();
      if(data) rData.dbId = data.id;
    }
  };

  const updateR = (fn) => {
    setReports(prev => prev.map(r => {
      if(r.dbId !== activeId) return r;
      const updated = { ...fn(r) };
      saveReport(updated);
      return updated;
    }));
  };

  const createReport = async () => {
    const r = newReport();
    const payload = { user_id: session.user.id, data: r, updated_at: new Date().toISOString() };
    const { data } = await supabase.from('reports').insert(payload).select().single();
    if(data) {
      setActiveId(data.id);
      setChapter(0);
      setView("editor");
    }
  };

  const r = reports.find(x => x.dbId === activeId);

  if(!session) return <LoginScreen onLoginSuccess={setSession}/>;

  if(view === "list") return (
    <div className="app">
      <header className="topbar">
        <div className="t-logo"><div className="t-logo-mark">üî¨</div><div className="t-logo-text">RG <em>MedSync</em></div></div>
        <div className="t-space"></div>
        <button className="btn btn-p" onClick={createReport}>‚ûï New Report</button>
        <button className="btn btn-s" onClick={() => supabase.auth.signOut()}>Logout</button>
      </header>
      <div className="content">
        <h2 style={{fontSize:"24px", marginBottom:"20px"}}>Collab Workspace</h2>
        <div style={{marginBottom:"20px"}}>
           <label style={{fontSize:"12px", fontWeight:"bold"}}>Set Anthropic AI Key (Stored Locally): </label>
           <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem("rg_ai_key", e.target.value)}} style={{padding:"8px", borderRadius:"6px", border:"1px solid #ccc", marginLeft:"10px", width:"300px"}} placeholder="sk-ant-..."/>
        </div>
        <div style={{display:"grid", gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))", gap:"20px"}}>
          {reports.map(rpt => (
            <div key={rpt.dbId} className="card" style={{cursor:"pointer", padding:"20px"}} onClick={()=>{setActiveId(rpt.dbId); setChapter(0); setView("editor");}}>
              <div style={{fontSize:"10px", fontWeight:"bold", color:"#1558A0", marginBottom:"10px"}}>ID: {rpt.dbId}</div>
              <h3 style={{fontSize:"18px", marginBottom:"5px"}}>{rpt.patientName || "Untitled"}</h3>
              <div style={{fontSize:"12px", color:"#666"}}>{rpt.ref || "No Ref"}</div>
              <div style={{fontSize:"10px", color:"#999", marginTop:"15px"}}>Updated: {new Date(rpt._ts).toLocaleString()}</div>
            </div>
          ))}
        </div>
      </div>
      {toast && <div className="toast">{toast}</div>}
    </div>
  );

  if(view === "preview") return <Preview r={r} onBack={() => setView("editor")} />;

  // EDITOR VIEW
  return (
    <div className="app">
      <header className="topbar">
        <div className="t-logo"><div className="t-logo-mark">üî¨</div><div className="t-logo-text">RG <em>MedSync</em></div></div>
        <div className="t-space"></div>
        <div className="status-pill saved"><div className="status-dot"></div> Auto-Saving Active</div>
        <button className="btn btn-s" onClick={() => setView("list")}>‚óÄ All Reports</button>
        <button className="btn btn-p" onClick={() => setView("preview")}>üëÅ Compile & Preview</button>
      </header>
      
      <div className="body-wrap">
        <div className="sidebar">
          <div style={{padding:"20px", color:"#fff", borderBottom:"1px solid #333"}}>
            <div style={{fontWeight:"bold", fontSize:"14px"}}>{r?.patientName || "New Report"}</div>
            <div style={{fontSize:"11px", color:"#aaa"}}>{r?.ref || "No Ref"}</div>
          </div>
          <div style={{flex:1, overflowY:"auto", padding:"10px"}}>
            {CHAPTERS.map(c => (
              <button key={c.id} className={`nav-item ${chapter === c.id ? "active" : ""}`} onClick={() => setChapter(c.id)}>
                <span className="nav-num">{c.id}</span> {c.short}
              </button>
            ))}
          </div>
        </div>

        <div className="content" style={{background:"#F8FAFC"}}>
           <h2 style={{fontSize:"22px", marginBottom:"20px", color:"#1C2B3A"}}>{CHAPTERS[chapter].title}</h2>

           {/* CH 0: DEMOGRAPHICS */}
           {chapter === 0 && (
             <div className="space-y-6">
               <ReportUploader apiKey={apiKey} onExtract={(info) => updateR(p => {
                 const next = {...p, ...info};
                 if(info.refNum) {
                   next.dob = parseSAID(info.refNum) || next.dob;
                   next.age = calcAge(next.dob, next.dateExam) || next.age;
                 }
                 return next;
               })} />
               <div className="card">
                 <div className="card-title" style={{marginBottom:"15px"}}>Patient Details</div>
                 <div className="g2">
                   <div className="field"><label>Patient Name</label><input value={r?.patientName} onChange={e=>updateR(p=>({...p, patientName:e.target.value}))}/></div>
                   <div className="field"><label>ID Number (Auto DOB)</label><input value={r?.refNum} onChange={e=>{
                     const val = e.target.value; const dob = parseSAID(val); const age = calcAge(dob||r.dob, r.dateExam);
                     updateR(p=>({...p, refNum:val, dob:dob||p.dob, age:age||p.age}));
                   }}/></div>
                   <div className="field"><label>Date of Birth</label><input type="date" value={r?.dob} onChange={e=>updateR(p=>({...p, dob:e.target.value, age:calcAge(e.target.value, p.dateExam)}))}/></div>
                   <div className="field"><label>Age at Assessment</label><input value={r?.age} readOnly style={{background:"#eee"}}/></div>
                   <div className="field"><label>Date of Injury</label><input type="date" value={r?.doi} onChange={e=>updateR(p=>({...p, doi:e.target.value}))}/></div>
                   <div className="field"><label>Date of Examination</label><input type="date" value={r?.dateExam} onChange={e=>updateR(p=>({...p, dateExam:e.target.value, age:calcAge(p.dob, e.target.value)}))}/></div>
                 </div>
               </div>
               <div className="card">
                 <div className="card-title" style={{marginBottom:"15px"}}>Practice & Attorney Details</div>
                 <div className="g2">
                   <div className="field"><label>Doctor Name</label><input value={r?.drName} onChange={e=>updateR(p=>({...p, drName:e.target.value}))}/></div>
                   <div className="field"><label>Qualifications</label><input value={r?.quals} onChange={e=>updateR(p=>({...p, quals:e.target.value}))}/></div>
                   <div className="field"><label>Our Reference</label><input value={r?.ourRef} onChange={e=>updateR(p=>({...p, ourRef:e.target.value}))}/></div>
                   <div className="field"><label>Attorney</label><input value={r?.atty} onChange={e=>updateR(p=>({...p, atty:e.target.value}))}/></div>
                 </div>
                 <ImageUploader label="Doctor Signature" value={r?.sigImg} onChange={v=>updateR(p=>({...p, sigImg:v}))} hint="Upload signature for final report" />
               </div>
             </div>
           )}

           {/* CH 6: CLINICAL EVAL */}
           {chapter === 6 && (
             <div className="space-y-6">
               <div className="card">
                 <div className="card-title" style={{marginBottom:"15px"}}>6.1 Pre-Accident & Current Complaints</div>
                 <div className="g2">
                   <SmartTA label="Pre-Accident Complaints" value={r?.ch6pre} onChange={v=>updateR(p=>({...p, ch6pre:v}))} rows={4} apiKey={apiKey} />
                   <SmartTA label="Current Complaints" value={r?.ch6cur} onChange={v=>updateR(p=>({...p, ch6cur:v}))} rows={4} apiKey={apiKey} />
                 </div>
                 <SmartTA label="General Examination Notes" value={r?.ch6general} onChange={v=>updateR(p=>({...p, ch6general:v}))} rows={4} apiKey={apiKey} />
               </div>
               <div className="card">
                 <div className="card-title" style={{marginBottom:"15px"}}>6.2 Musculoskeletal Regions</div>
                 <div style={{display:"flex", flexWrap:"wrap", gap:"8px", marginBottom:"20px"}}>
                   {EXAM_REGIONS_LIST.map(reg => (
                     <button key={reg} onClick={()=>updateR(p=>({...p, examRegions:{...p.examRegions, [reg]:!p.examRegions[reg]}}))} className="btn btn-s" style={{background: r?.examRegions?.[reg] ? "var(--primary)" : "#fff", color: r?.examRegions?.[reg] ? "#fff" : "#333"}}>{reg}</button>
                   ))}
                 </div>
                 {EXAM_REGIONS_LIST.filter(reg => r?.examRegions?.[reg]).map(reg => (
                   <div key={reg} style={{marginBottom:"20px", padding:"15px", border:"1px solid #ccc", borderRadius:"8px"}}>
                     <div style={{fontWeight:"bold", color:"#1558A0", marginBottom:"10px"}}>{reg}</div>
                     {EXAM_REGIONS[reg].map(fld => (
                       <div key={fld} className="field"><label>{fld}</label><input value={r?.ch6msk?.[reg]?.[fld] || ""} onChange={e=>updateR(p=>({...p, ch6msk:{...p.ch6msk, [reg]:{...(p.ch6msk?.[reg]||{}), [fld]:e.target.value}}}))}/></div>
                     ))}
                   </div>
                 ))}
               </div>
               <div className="card g2">
                 <div>
                   <div className="card-title" style={{marginBottom:"10px"}}>6.3.1 Scarring & Deformity</div>
                   <ImageUploader value={r?.ch6scarringImg} onChange={v=>updateR(p=>({...p, ch6scarringImg:v}))}/>
                   <SmartTA value={r?.ch6scarring} onChange={v=>updateR(p=>({...p, ch6scarring:v}))} rows={3} apiKey={apiKey}/>
                 </div>
                 <div>
                   <div className="card-title" style={{marginBottom:"10px"}}>6.3.2 Radiology</div>
                   <ImageUploader value={r?.ch6radiologyImg} onChange={v=>updateR(p=>({...p, ch6radiologyImg:v}))}/>
                   <SmartTA value={r?.ch6radiology} onChange={v=>updateR(p=>({...p, ch6radiology:v}))} rows={3} apiKey={apiKey}/>
                 </div>
               </div>
             </div>
           )}

           {/* CH 9: IMPAIRMENT */}
           {chapter === 9 && (
             <div className="space-y-6">
               <div className="card">
                 <div className="card-title" style={{marginBottom:"15px"}}>9.3.3 Treatment & Outcomes</div>
                 <div className="field">
                   <label style={{display:"flex", justifyContent:"space-between"}}>
                     <span>Initial Treatment</span>
                     <span style={{color:"#1558A0", cursor:"pointer"}} onClick={()=>updateR(p=>({...p, ch9initTx: p.ch5 || "Pulled from Chapter 5"}))}>Pull from Chapter 5</span>
                   </label>
                   <textarea rows={3} value={r?.ch9initTx} onChange={e=>updateR(p=>({...p, ch9initTx:e.target.value}))} className="w-full bg-white border border-slate-300 rounded-lg p-3"/>
                 </div>
                 <div className="g2">
                   <div className="field"><label>Initial Diagnosis</label><textarea rows={3} value={r?.ch9initDx} onChange={e=>updateR(p=>({...p, ch9initDx:e.target.value}))} className="w-full bg-white border border-slate-300 rounded-lg p-3"/></div>
                   <div className="field"><label>Outcome Diagnosis</label><textarea rows={3} value={r?.ch9outDx} onChange={e=>updateR(p=>({...p, ch9outDx:e.target.value}))} className="w-full bg-white border border-slate-300 rounded-lg p-3"/></div>
                 </div>
               </div>
               <div className="card">
                 <div className="card-title" style={{marginBottom:"15px"}}>Whole Person Impairment (WPI)</div>
                 {r?.wpiRows?.map((row, i) => (
                   <div key={i} className="g3" style={{marginBottom:"10px"}}>
                     <input placeholder="Region" value={row.region} onChange={e=>{const nr=[...r.wpiRows]; nr[i].region=e.target.value; updateR(p=>({...p, wpiRows:nr}))}} className="w-full border rounded p-2"/>
                     <input placeholder="Impairment" value={row.impairment} onChange={e=>{const nr=[...r.wpiRows]; nr[i].impairment=e.target.value; updateR(p=>({...p, wpiRows:nr}))}} className="w-full border rounded p-2"/>
                     <div style={{display:"flex", gap:"5px"}}>
                       <input placeholder="WPI %" value={row.wpi} onChange={e=>{const nr=[...r.wpiRows]; nr[i].wpi=e.target.value; updateR(p=>({...p, wpiRows:nr}))}} className="w-full border rounded p-2"/>
                       <button className="btn btn-d" onClick={()=>{const nr=r.wpiRows.filter((_,x)=>x!==i); updateR(p=>({...p, wpiRows:nr}))}}>X</button>
                     </div>
                   </div>
                 ))}
                 <button className="btn btn-s" onClick={()=>updateR(p=>({...p, wpiRows:[...(p.wpiRows||[]), {region:"", impairment:"", wpi:""}]}))}>+ Add Row</button>
               </div>
             </div>
           )}

           {/* STANDARD DICTATION FOR OTHER CHAPTERS */}
           {(chapter !== 0 && chapter !== 6 && chapter !== 9) && (
             <div className="card">
               <SmartTA label={`${CHAPTERS[chapter].title} Content`} value={r?.[`ch${chapter}`] || ""} onChange={v=>updateR(p=>({...p, [`ch${chapter}`]:v}))} rows={12} apiKey={apiKey} aiPrompt="Correct grammar and format the text. NUMBER EVERY SINGLE SENTENCE (1.1, 1.2, etc.). For any numbers mentioned, write them as digit and word in brackets, e.g. 2 (two). Do not change facts."/>
             </div>
           )}

        </div>
      </div>
      {toast && <div className="toast">{toast}</div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MediSync Ortho</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#07090f;
  --surface:#0d1117;
  --panel:#111827;
  --raised:#161d2e;
  --rim:#1e2a40;
  --line:#243050;
  --teal:#00e5d8;
  --teal-dim:#00b5aa;
  --teal-glow:rgba(0,229,216,.14);
  --teal-ghost:rgba(0,229,216,.05);
  --gold:#f5a623;
  --red:#ff4d6d;
  --red-glow:rgba(255,77,109,.12);
  --green:#00e676;
  --green-glow:rgba(0,230,118,.1);
  --purple:#9d7eff;
  --t1:#e8f0ff;
  --t2:#7d8fb3;
  --t3:#3d4f70;
  --t4:#1e2a40;
  --glass:rgba(255,255,255,.025);
  --glass-b:rgba(255,255,255,.05);
  --sidebar-w:252px;
  --topbar-h:58px;
}
html,body,#root{height:100%;background:var(--bg);}
body{font-family:'DM Sans',sans-serif;font-size:14px;color:var(--t1);-webkit-font-smoothing:antialiased;}
button,input,select,textarea{font-family:'DM Sans',sans-serif;}
textarea{resize:vertical;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--rim);border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:var(--line);}
a{text-decoration:none;color:inherit;}

/* â”€â”€â”€ AMBIENT GLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.glow-tr{position:fixed;top:-300px;right:-200px;width:700px;height:700px;
  background:radial-gradient(circle,rgba(0,229,216,.055) 0%,transparent 65%);pointer-events:none;z-index:0;}
.glow-bl{position:fixed;bottom:-300px;left:-200px;width:600px;height:600px;
  background:radial-gradient(circle,rgba(157,126,255,.04) 0%,transparent 65%);pointer-events:none;z-index:0;}

/* â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden;position:relative;z-index:1;}

/* â”€â”€â”€ TOPBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{
  height:var(--topbar-h);
  background:rgba(13,17,23,.85);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid var(--glass-b);
  display:flex;align-items:center;padding:0 20px;gap:12px;
  flex-shrink:0;z-index:200;position:relative;
}
.topbar::after{
  content:"";position:absolute;bottom:-1px;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent 0%,var(--teal-dim) 40%,var(--teal-dim) 60%,transparent 100%);
  opacity:.18;
}
.t-logo{display:flex;align-items:center;gap:10px;}
.t-logo-mark{
  width:36px;height:36px;border-radius:9px;
  background:linear-gradient(135deg,var(--teal) 0%,var(--teal-dim) 100%);
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 0 18px rgba(0,229,216,.28),inset 0 1px 0 rgba(255,255,255,.18);
}
.t-logo-text{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;letter-spacing:.2px;color:var(--t1);}
.t-logo-text em{color:var(--teal);font-style:normal;}
.t-logo-sub{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--t3);margin-top:1px;}
.t-sep{width:1px;height:18px;background:var(--rim);margin:0 4px;}
.t-space{flex:1;}

/* topbar status pill */
.status-pill{
  display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:20px;
  font-size:11px;font-weight:600;letter-spacing:.4px;border:1px solid transparent;
  transition:all .3s;
}
.status-pill.idle{color:var(--t3);background:transparent;border-color:transparent;}
.status-pill.saving{color:var(--gold);background:rgba(245,166,35,.08);border-color:rgba(245,166,35,.2);}
.status-pill.saved{color:var(--teal-dim);background:var(--teal-ghost);border-color:rgba(0,229,216,.15);}
.status-pill.error{color:var(--red);background:var(--red-glow);border-color:rgba(255,77,109,.25);}
.status-dot{width:5px;height:5px;border-radius:50%;background:currentColor;}
.status-dot.blink{animation:sdot 1.2s ease infinite;}
@keyframes sdot{0%,100%{opacity:1;}50%{opacity:.15;}}

/* topbar buttons */
.tb-btn{
  display:flex;align-items:center;gap:6px;
  padding:7px 14px;border-radius:8px;font-size:12px;font-weight:600;
  letter-spacing:.3px;cursor:pointer;border:none;transition:all .15s;white-space:nowrap;
}
.tb-ghost{background:transparent;color:var(--t2);border:1px solid var(--rim);}
.tb-ghost:hover{border-color:var(--teal-dim);color:var(--teal);background:var(--teal-ghost);}
.tb-primary{background:var(--teal);color:#07090f;font-weight:700;box-shadow:0 0 18px rgba(0,229,216,.22);}
.tb-primary:hover{background:#00cfca;box-shadow:0 0 26px rgba(0,229,216,.38);}
.tb-icon{
  width:34px;height:34px;border-radius:8px;border:1px solid var(--rim);
  background:transparent;color:var(--t2);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:15px;
  transition:all .15s;flex-shrink:0;
}
.tb-icon:hover{border-color:var(--teal-dim);color:var(--teal);background:var(--teal-ghost);}

/* hamburger */
.hamburger{
  width:34px;height:34px;border-radius:8px;border:1px solid var(--rim);
  background:transparent;cursor:pointer;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:4px;transition:all .15s;flex-shrink:0;
}
.hamburger:hover{border-color:var(--teal-dim);background:var(--teal-ghost);}
.hamburger span{display:block;width:14px;height:1.5px;background:var(--t2);border-radius:2px;transition:background .15s;}
.hamburger:hover span{background:var(--teal);}

/* â”€â”€â”€ BODY WRAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.body-wrap{display:flex;flex:1;overflow:hidden;}

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{
  width:var(--sidebar-w);min-width:var(--sidebar-w);
  background:rgba(11,15,22,.7);
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  border-right:1px solid var(--glass-b);
  display:flex;flex-direction:column;
  transition:width .22s ease,min-width .22s ease;overflow:hidden;
}
.sidebar.closed{width:0;min-width:0;}

/* report info block */
.sb-rpt{
  padding:16px 16px 14px;border-bottom:1px solid var(--glass-b);
  position:relative;
}
.sb-rpt::before{
  content:"";position:absolute;top:0;left:16px;right:16px;height:1px;
  background:linear-gradient(90deg,transparent,var(--teal-dim),transparent);opacity:.3;
}
.sb-rpt-name{
  font-family:'Syne',sans-serif;font-size:12px;font-weight:700;
  color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;
}
.sb-rpt-meta{font-size:10px;color:var(--t3);letter-spacing:.3px;}
.sb-prog{margin-top:11px;}
.sb-prog-track{height:2px;background:var(--rim);border-radius:2px;position:relative;}
.sb-prog-fill{
  height:100%;border-radius:2px;
  background:linear-gradient(90deg,var(--teal-dim),var(--teal));
  transition:width .5s ease;position:relative;
}
.sb-prog-fill::after{
  content:"";position:absolute;right:-3px;top:-3px;
  width:8px;height:8px;border-radius:50%;background:var(--teal);
  box-shadow:0 0 8px var(--teal);
}
.sb-prog-pct{font-size:9px;color:var(--teal);text-align:right;margin-top:5px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:.5px;}

/* nav */
.sb-nav{flex:1;overflow-y:auto;padding:6px 8px;}
.sb-nav-label{font-size:9px;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--t4);padding:10px 8px 4px;}
.nav-item{
  display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:8px;
  font-size:13px;color:var(--t3);background:none;border:1px solid transparent;
  width:100%;text-align:left;cursor:pointer;transition:all .12s;margin-bottom:1px;
  white-space:nowrap;position:relative;
}
.nav-item:hover{color:var(--t1);background:var(--glass);border-color:var(--glass-b);}
.nav-item.active{
  color:var(--teal);background:var(--teal-ghost);
  border-color:rgba(0,229,216,.12);font-weight:500;
}
.nav-item.active::before{
  content:"";position:absolute;left:0;top:25%;height:50%;
  width:2px;background:var(--teal);border-radius:2px;
  box-shadow:0 0 6px var(--teal);
}
.nav-num{
  width:20px;height:20px;border-radius:5px;background:var(--raised);
  display:flex;align-items:center;justify-content:center;
  font-size:9px;font-weight:700;flex-shrink:0;color:var(--t3);
  font-family:'Syne',sans-serif;
}
.nav-item.active .nav-num{background:rgba(0,229,216,.15);color:var(--teal);}
.nav-tick{
  width:15px;height:15px;border-radius:50%;background:var(--green);
  display:flex;align-items:center;justify-content:center;
  font-size:8px;color:#07090f;font-weight:900;margin-left:auto;flex-shrink:0;
  box-shadow:0 0 7px rgba(0,230,118,.4);
}

/* â”€â”€â”€ ACCOUNT PANEL (bottom of sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sb-account{
  border-top:1px solid var(--glass-b);
  background:rgba(0,0,0,.2);
  flex-shrink:0;
}
.sb-acc-btn{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;width:100%;background:none;border:none;
  cursor:pointer;transition:background .15s;text-align:left;
}
.sb-acc-btn:hover{background:var(--glass);}
.acc-avatar{
  width:32px;height:32px;border-radius:8px;flex-shrink:0;
  background:linear-gradient(135deg,var(--purple),var(--teal-dim));
  display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-size:12px;font-weight:800;color:#fff;
  box-shadow:0 0 12px rgba(157,126,255,.25);
}
.acc-info{flex:1;min-width:0;}
.acc-email{font-size:11px;font-weight:600;color:var(--t1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.acc-role{font-size:9px;color:var(--t3);letter-spacing:.5px;text-transform:uppercase;margin-top:1px;}
.acc-chevron{font-size:10px;color:var(--t3);flex-shrink:0;transition:transform .2s;}
.acc-chevron.open{transform:rotate(180deg);}

/* account dropdown */
.acc-dropdown{
  background:var(--raised);border-top:1px solid var(--line);
  animation:acc-in .15s ease;overflow:hidden;
}
@keyframes acc-in{from{opacity:0;max-height:0;}to{opacity:1;max-height:400px;}}
.acc-item{
  display:flex;align-items:center;gap:10px;
  padding:11px 16px;font-size:13px;color:var(--t2);
  cursor:pointer;background:none;border:none;width:100%;text-align:left;
  border-top:1px solid var(--glass-b);transition:all .12s;
}
.acc-item:first-child{border-top:none;}
.acc-item:hover{color:var(--t1);background:var(--glass);}
.acc-item.red{color:var(--red);}
.acc-item.red:hover{background:var(--red-glow);}
.acc-item-ico{
  width:26px;height:26px;border-radius:6px;background:var(--panel);
  display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;
}

/* â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}

.ch-bar{
  background:rgba(11,15,22,.6);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--glass-b);
  padding:15px 28px;display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.ch-left{display:flex;align-items:center;gap:12px;}
.ch-badge{
  width:40px;height:40px;border-radius:10px;flex-shrink:0;
  background:var(--teal-ghost);border:1px solid rgba(0,229,216,.15);
  display:flex;align-items:center;justify-content:center;font-size:17px;
}
.ch-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--t1);}
.ch-sub{font-size:11px;color:var(--t3);margin-top:1px;letter-spacing:.3px;}
.ch-nav{display:flex;gap:7px;}

.content{flex:1;overflow-y:auto;padding:24px 28px;}

/* â”€â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{
  background:var(--glass);border:1px solid var(--glass-b);
  border-radius:14px;padding:22px;margin-bottom:16px;
  position:relative;overflow:hidden;transition:border-color .2s;
}
.card::before{
  content:"";position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.015) 0%,transparent 50%);
  pointer-events:none;border-radius:inherit;
}
.card:focus-within{border-color:rgba(0,229,216,.1);}
.card-h{display:flex;align-items:center;gap:10px;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid var(--glass-b);}
.card-ico{
  width:34px;height:34px;border-radius:8px;
  background:var(--teal-ghost);border:1px solid rgba(0,229,216,.12);
  display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;
}
.card-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--t1);}
.card-desc{font-size:11px;color:var(--t3);margin-top:2px;}

/* â”€â”€â”€ FORMS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.field{margin-bottom:15px;}
.field label{
  display:block;font-size:10px;font-weight:700;
  letter-spacing:1px;text-transform:uppercase;color:var(--t3);margin-bottom:6px;
}
.field input,.field select,.field textarea{
  width:100%;background:var(--panel);border:1px solid var(--rim);
  border-radius:8px;color:var(--t1);padding:10px 13px;font-size:14px;outline:none;
  transition:border-color .15s,box-shadow .15s;
}
.field input:focus,.field select:focus,.field textarea:focus{
  border-color:var(--teal-dim);
  box-shadow:0 0 0 3px var(--teal-glow);
  background:var(--raised);
}
.field input::placeholder,.field textarea::placeholder{color:var(--t4);}
.field select option{background:var(--panel);}
.field textarea{min-height:90px;line-height:1.6;}
.fhint{font-size:11px;color:var(--t3);margin-top:4px;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}

/* â”€â”€â”€ SMART TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ta-wrap{position:relative;}
.ta-wrap textarea{padding-right:92px;}
.ta-tools{position:absolute;top:8px;right:8px;display:flex;flex-direction:column;gap:5px;}
.mic{
  width:34px;height:34px;border-radius:7px;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:15px;
  transition:all .15s;
}
.mic.off{background:var(--raised);color:var(--t3);border:1px solid var(--rim);}
.mic.off:hover{border-color:var(--teal-dim);color:var(--teal);background:var(--teal-ghost);}
.mic.on{background:var(--red);color:#fff;animation:rec 1.3s ease infinite;}
@keyframes rec{0%,100%{box-shadow:0 0 0 0 rgba(255,77,109,.5);}60%{box-shadow:0 0 0 7px rgba(255,77,109,0);}}
.aibtn{
  width:34px;height:34px;border-radius:7px;border:1px solid rgba(157,126,255,.25);
  background:rgba(157,126,255,.08);color:var(--purple);cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:13px;
  transition:all .15s;
}
.aibtn:hover{background:rgba(157,126,255,.18);border-color:var(--purple);}
.aibtn:disabled{opacity:.3;cursor:wait;}

/* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn{
  display:inline-flex;align-items:center;gap:6px;
  padding:9px 16px;border-radius:8px;border:none;
  font-size:13px;font-weight:600;cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.btn-p{background:var(--teal);color:#07090f;font-weight:700;box-shadow:0 0 18px rgba(0,229,216,.2);}
.btn-p:hover{background:#00cfca;box-shadow:0 0 24px rgba(0,229,216,.36);}
.btn-s{background:var(--raised);color:var(--t2);border:1px solid var(--rim);}
.btn-s:hover{border-color:var(--teal-dim);color:var(--teal);background:var(--teal-ghost);}
.btn-g{background:transparent;color:var(--t2);border:1px solid transparent;padding:8px 12px;}
.btn-g:hover{background:var(--glass);border-color:var(--glass-b);color:var(--t1);}
.btn-d{background:var(--red-glow);color:var(--red);border:1px solid rgba(255,77,109,.18);}
.btn-d:hover{background:var(--red);color:#fff;}
.btn-sm{padding:6px 11px;font-size:12px;}
.btn-lg{padding:12px 22px;font-size:15px;}
.btn:disabled{opacity:.4;cursor:not-allowed;}

/* â”€â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.login-root{
  min-height:100vh;display:flex;align-items:center;justify-content:center;
  background:var(--bg);padding:20px;position:relative;overflow:hidden;z-index:1;
}
.login-ring{
  position:absolute;border-radius:50%;border:1px solid rgba(0,229,216,.05);
  animation:ring-pulse 6s ease infinite;
}
@keyframes ring-pulse{0%,100%{opacity:.5;}50%{opacity:1;}}
.login-card{
  background:var(--surface);border:1px solid var(--rim);border-radius:20px;
  padding:40px 44px;width:100%;max-width:420px;
  box-shadow:0 24px 80px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,.03);
  position:relative;z-index:1;
}
.login-card::before{
  content:"";position:absolute;top:0;left:20px;right:20px;height:1px;border-radius:20px;
  background:linear-gradient(90deg,transparent,var(--teal-dim),transparent);opacity:.5;
}
.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;}
.login-mark{
  width:46px;height:46px;border-radius:12px;
  background:linear-gradient(135deg,var(--teal),var(--teal-dim));
  display:flex;align-items:center;justify-content:center;font-size:22px;
  box-shadow:0 0 24px rgba(0,229,216,.35);
}
.login-appname{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--t1);}
.login-appname em{color:var(--teal);font-style:normal;}
.login-apptag{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--t3);margin-top:2px;}
.login-heading{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:var(--t1);margin-bottom:4px;}
.login-sub{font-size:14px;color:var(--t3);margin-bottom:28px;}
.login-err{
  background:var(--red-glow);border:1px solid rgba(255,77,109,.25);
  color:var(--red);border-radius:8px;padding:10px 13px;font-size:13px;margin-bottom:14px;
}
.login-ok{
  background:var(--green-glow);border:1px solid rgba(0,230,118,.2);
  color:var(--green);border-radius:8px;padding:10px 13px;font-size:13px;margin-bottom:14px;
}
.login-forgot{font-size:12px;color:var(--teal-dim);cursor:pointer;float:right;margin-top:-12px;margin-bottom:16px;}
.login-forgot:hover{color:var(--teal);}
.login-invite-hint{
  margin-top:20px;padding:13px 14px;background:rgba(0,0,0,.35);
  border-radius:8px;border:1px solid var(--rim);
}
.login-invite-label{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:4px;}
.login-invite-hint p{font-size:12px;color:var(--t3);line-height:1.5;}
.login-invite-hint strong{color:var(--t2);}

/* â”€â”€â”€ ACCOUNT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.overlay{
  position:fixed;inset:0;z-index:900;
  background:rgba(0,0,0,.75);backdrop-filter:blur(10px);
  display:flex;align-items:center;justify-content:center;padding:20px;
  animation:fade-in .15s ease;
}
@keyframes fade-in{from{opacity:0;}to{opacity:1;}}
.modal{
  background:var(--surface);border:1px solid var(--rim);border-radius:16px;
  width:100%;max-width:460px;box-shadow:0 24px 80px rgba(0,0,0,.7);
  overflow:hidden;position:relative;animation:modal-up .18s ease;
}
@keyframes modal-up{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.modal::before{
  content:"";position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--teal-dim),transparent);opacity:.4;
}
.modal-head{
  padding:20px 24px 16px;border-bottom:1px solid var(--glass-b);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-title{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--t1);}
.modal-body{padding:20px 24px;}
.modal-foot{padding:14px 24px;border-top:1px solid var(--glass-b);display:flex;gap:8px;justify-content:flex-end;}

/* account modal specifics */
.acc-hero{
  display:flex;align-items:center;gap:14px;padding:16px;
  background:var(--raised);border:1px solid var(--line);border-radius:10px;margin-bottom:18px;
}
.acc-hero-av{
  width:52px;height:52px;border-radius:12px;flex-shrink:0;
  background:linear-gradient(135deg,var(--purple),var(--teal-dim));
  display:flex;align-items:center;justify-content:center;
  font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:#fff;
  box-shadow:0 0 20px rgba(157,126,255,.25);
}
.acc-hero-email{font-size:14px;font-weight:600;color:var(--t1);margin-bottom:3px;}
.acc-hero-meta{font-size:11px;color:var(--t3);}
.acc-section{font-size:9px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin:14px 0 7px;}
.acc-stat{
  display:flex;align-items:center;justify-content:space-between;
  padding:11px 13px;background:var(--raised);border:1px solid var(--line);
  border-radius:8px;margin-bottom:6px;
}
.acc-stat-k{font-size:12px;color:var(--t3);}
.acc-stat-v{font-family:'Syne',sans-serif;font-size:14px;font-weight:600;color:var(--t1);}
.api-row{
  display:flex;align-items:center;gap:8px;padding:10px 12px;
  background:var(--raised);border:1px solid var(--line);border-radius:8px;
}
.api-val{flex:1;font-family:monospace;font-size:12px;color:var(--t2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.api-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;}
.api-badge.on{background:rgba(0,229,216,.1);color:var(--teal);border:1px solid rgba(0,229,216,.2);}
.api-badge.off{background:var(--glass);color:var(--t3);border:1px solid var(--glass-b);}

/* â”€â”€â”€ REPORT LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.list-page{flex:1;overflow-y:auto;padding:28px 32px;}
.list-head{max-width:720px;margin:0 auto 22px;}
.list-head-title{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;color:var(--t1);margin-bottom:4px;}
.list-head-title em{color:var(--teal);font-style:normal;}
.list-head-sub{font-size:13px;color:var(--t3);}
.search-row{max-width:720px;margin:0 auto 18px;position:relative;}
.search-ico{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--t3);}
.searchbox{
  width:100%;padding:11px 14px 11px 39px;
  background:var(--panel);border:1px solid var(--rim);border-radius:9px;
  font-size:14px;color:var(--t1);outline:none;transition:border-color .15s;
}
.searchbox:focus{border-color:var(--teal-dim);box-shadow:0 0 0 3px var(--teal-glow);}
.searchbox::placeholder{color:var(--t4);}
.rpt-list{max-width:720px;margin:0 auto;}

.rpt-card{
  background:var(--glass);border:1px solid var(--glass-b);border-radius:13px;
  padding:17px 20px;margin-bottom:9px;cursor:pointer;
  display:flex;align-items:center;gap:14px;
  transition:all .18s ease;position:relative;overflow:hidden;
}
.rpt-card::before{
  content:"";position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.015),transparent);
  pointer-events:none;
}
.rpt-card:hover{
  border-color:rgba(0,229,216,.18);background:var(--glass);
  transform:translateY(-1px);
  box-shadow:0 8px 28px rgba(0,0,0,.3),0 0 0 1px rgba(0,229,216,.07);
}
.rpt-ico{
  width:44px;height:44px;border-radius:11px;flex-shrink:0;
  background:linear-gradient(135deg,var(--teal-ghost),rgba(0,229,216,.03));
  border:1px solid rgba(0,229,216,.1);
  display:flex;align-items:center;justify-content:center;font-size:20px;
}
.rpt-info{flex:1;min-width:0;}
.rpt-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--t1);margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-meta{font-size:11px;color:var(--t3);}
.rpt-prog{display:flex;align-items:center;gap:8px;margin-top:7px;}
.rpt-track{flex:1;height:2px;background:var(--rim);border-radius:2px;}
.rpt-fill{height:100%;background:linear-gradient(90deg,var(--teal-dim),var(--teal));border-radius:2px;transition:width .3s;}
.rpt-pct{font-size:10px;color:var(--teal);font-weight:700;min-width:28px;text-align:right;font-family:'Syne',sans-serif;}

/* â”€â”€â”€ CHAPTER CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.prompt-block{
  background:var(--raised);border:1px solid var(--glass-b);
  border-left:2px solid var(--teal);
  border-radius:0 8px 8px 0;padding:13px 15px;margin-bottom:13px;
}
.prompt-lbl{font-size:9px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--teal);margin-bottom:3px;}
.prompt-guide{font-size:12px;color:var(--t3);margin-bottom:10px;line-height:1.55;}

.region-grid{display:grid;grid-template-columns:188px 1fr;gap:16px;}
.region-btn{
  padding:9px 12px;border-radius:7px;font-size:12px;
  border:1px solid var(--rim);background:var(--raised);color:var(--t3);
  cursor:pointer;text-align:left;transition:all .13s;width:100%;margin-bottom:3px;display:block;
}
.region-btn:hover{border-color:var(--teal-dim);color:var(--teal);background:var(--teal-ghost);}
.region-btn.active{background:var(--teal);color:#07090f;border-color:var(--teal);font-weight:600;}
.region-fld{font-size:9px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--teal-dim);margin:12px 0 5px;}
.region-fld:first-child{margin-top:0;}

.inj-item{
  display:flex;align-items:center;gap:11px;padding:10px 14px;
  background:var(--raised);border:1px solid var(--line);border-radius:8px;margin-bottom:7px;
  transition:border-color .13s;
}
.inj-item:hover{border-color:var(--teal-dim);}
.inj-dot{width:7px;height:7px;border-radius:50%;background:var(--teal);flex-shrink:0;box-shadow:0 0 6px var(--teal);}
.inj-txt{flex:1;font-size:13px;color:var(--t1);}

.std-box{
  background:var(--raised);border:1px solid var(--line);border-radius:8px;
  padding:14px;font-size:13px;color:var(--t3);line-height:1.7;
}
.std-lbl{
  font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--t4);margin-bottom:7px;display:flex;align-items:center;gap:6px;
}
.std-lbl::before{content:"";display:block;width:14px;height:1px;background:var(--teal-dim);}

/* â”€â”€â”€ ADL TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.adl-tbl{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;border-radius:10px;overflow:hidden;border:1px solid var(--line);}
.adl-tbl th{background:var(--deep,#060b14);color:var(--t3);padding:9px 12px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;text-align:center;border-bottom:1px solid var(--line);}
.adl-tbl th:first-child{text-align:left;}
.adl-tbl td{padding:9px 12px;border-bottom:1px solid rgba(30,42,64,.6);vertical-align:middle;}
.adl-tbl tr:nth-child(odd) td{background:var(--panel);}
.adl-tbl tr:nth-child(even) td{background:var(--raised);}
.adl-tbl tr:hover td{background:var(--teal-ghost);}
.adl-tbl tr:last-child td{border-bottom:none;}
.adl-r{display:flex;justify-content:center;}
.adl-r label{cursor:pointer;padding:3px 5px;border-radius:4px;display:flex;align-items:center;gap:3px;color:var(--t3);}
.adl-r label:hover{color:var(--teal);}
.adl-r input[type=radio]{accent-color:var(--teal);width:14px;height:14px;}

/* â”€â”€â”€ WPI TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.wpi-tbl{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;border-radius:10px;overflow:hidden;border:1px solid var(--line);}
.wpi-tbl th{background:var(--surface);color:var(--t3);padding:9px 12px;font-size:9px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;border-bottom:1px solid var(--line);}
.wpi-tbl td{padding:7px 9px;border-bottom:1px solid rgba(30,42,64,.5);background:var(--panel);}
.wpi-tbl tr:last-child td{background:var(--surface);border-bottom:none;}
.wpi-tbl input{width:100%;background:transparent;border:1px solid var(--rim);border-radius:6px;padding:5px 8px;font-size:12px;color:var(--t1);outline:none;}
.wpi-tbl input:focus{border-color:var(--teal-dim);box-shadow:0 0 0 2px var(--teal-glow);}
.wpi-tbl tr:last-child input{border-color:rgba(255,255,255,.08);color:var(--t2);}
.wpi-total{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--teal);text-shadow:0 0 16px rgba(0,229,216,.3);}

/* â”€â”€â”€ PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.preview-bg{flex:1;overflow-y:auto;background:#12121e;padding:32px;}
.preview-page{
  background:#fff;color:#111;max-width:800px;margin:0 auto;
  padding:60px 72px;font-size:11pt;line-height:1.7;
  box-shadow:0 24px 80px rgba(0,0,0,.7);border-radius:4px;
}
.preview-page h1{font-family:'DM Serif Display',serif;font-size:16pt;text-align:center;margin-bottom:4px;}
.preview-page h2{font-family:'DM Sans',sans-serif;font-size:11.5pt;font-weight:700;margin:22px 0 8px;border-bottom:2px solid #1a2234;padding-bottom:4px;}
.preview-page h3{font-family:'DM Sans',sans-serif;font-size:11pt;font-weight:600;margin:14px 0 5px;}
.preview-page h4{font-family:'DM Sans',sans-serif;font-size:10.5pt;font-weight:600;margin:10px 0 4px;}
.preview-page p,.preview-page .bt{font-family:'DM Sans',sans-serif;font-size:10.5pt;margin-bottom:8px;}
.preview-page table{width:100%;border-collapse:collapse;margin:10px 0;font-family:'DM Sans',sans-serif;font-size:9.5pt;}
.preview-page table th{background:#1a2234;color:#fff;padding:6px 10px;border:1px solid #ccc;}
.preview-page table td{padding:5px 10px;border:1px solid #ccc;}
.preview-page table tr:nth-child(even) td{background:#f8f9fa;}
.preview-fabs{position:fixed;bottom:28px;right:28px;display:flex;gap:10px;}
.fab{
  width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 4px 20px rgba(0,0,0,.5);transition:all .15s;
}
.fab:hover{transform:translateY(-2px);}

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty{text-align:center;padding:80px 32px;max-width:360px;margin:0 auto;}
.empty-ico{font-size:52px;margin-bottom:18px;}
.empty-t{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:var(--t1);margin-bottom:8px;}
.empty-s{font-size:14px;color:var(--t3);line-height:1.6;margin-bottom:24px;}

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  background:var(--raised);border:1px solid var(--rim);color:var(--t1);
  border-radius:9px;padding:11px 18px;font-size:13px;z-index:999;
  box-shadow:0 8px 32px rgba(0,0,0,.5);
  animation:toast-up .18s ease;
}
@keyframes toast-up{from{opacity:0;transform:translateX(-50%) translateY(8px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,229,216,.15);border-top-color:var(--teal);border-radius:50%;animation:spinning .6s linear infinite;}
@keyframes spinning{to{transform:rotate(360deg);}}
.loading-full{height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;background:var(--bg);position:relative;z-index:1;}
.loading-full .spin{width:36px;height:36px;border-width:3px;}

@media print{.no-print{display:none!important;}.preview-page{box-shadow:none;padding:0;}}
@media(max-width:640px){
  .ch-bar,.content{padding-left:16px;padding-right:16px;}
  .region-grid{grid-template-columns:1fr;}
  .g2,.g3{grid-template-columns:1fr;}
  .preview-page{padding:32px 24px;}
  .login-card{padding:28px 22px;}
}
</style>
</head>
<body>
<div class="glow-tr"></div>
<div class="glow-bl"></div>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// â”€â”€ SUPABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPA_URL = "https://lwmghkbqdwvqcadhocxa.supabase.co";
const SUPA_KEY = "sb_publishable_2vo76E53tWg9k3OHeT7DRA_AeVe0C6l";
const supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

// â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CHAPTERS = [
  {id:0,title:"Cover / Demographics",short:"Demographics",icon:"ğŸ‘¤"},
  {id:1,title:"Documents Perused",short:"Documents",icon:"ğŸ“"},
  {id:2,title:"Occupational & Medical Hx",short:"Med History",icon:"ğŸ¥"},
  {id:3,title:"Hospital Records",short:"Hospital",icon:"ğŸ“‹"},
  {id:4,title:"Injuries Sustained",short:"Injuries",icon:"ğŸ¦´"},
  {id:5,title:"Current Complaints",short:"Complaints",icon:"ğŸ’¬"},
  {id:6,title:"Clinical Evaluation",short:"Clinical Eval",icon:"ğŸ”"},
  {id:7,title:"Diagnosis",short:"Diagnosis",icon:"ğŸ“Š"},
  {id:8,title:"Further Management",short:"Management",icon:"ğŸ’Š"},
  {id:9,title:"Disability & Impairment",short:"Disability",icon:"ğŸ“"},
  {id:10,title:"Discussion",short:"Discussion",icon:"ğŸ“"},
];
const CH3_PROMPTS = [
  {letter:"a",text:"Mechanism of accident and date of accident."},
  {letter:"b",text:"EMS assessment on scene â€” presentation, complaints, exam findings, GCS, suspected diagnosis."},
  {letter:"c",text:"Transfer to hospital â€” name and mode of transport (ambulance, helicopter, etc.)."},
  {letter:"d",text:"Date of presentation to hospital and which department."},
  {letter:"e",text:"Complaints and findings on initial assessment."},
  {letter:"f",text:"Immediate investigations / treatment rendered."},
  {letter:"g",text:"Diagnosis."},
  {letter:"h",text:"Admission, transfer to relevant department, and formal diagnosis."},
  {letter:"i",text:"Definitive management and treatment prescribed, including dates."},
  {letter:"j",text:"Post-operative treatment and rehabilitation."},
  {letter:"k",text:"Discharge and assistive devices / step-down treatment."},
  {letter:"l",text:"Follow-up and review."},
];
const EXAM_REGIONS = {
  "Cervical Spine":["Inspection","Palpation","Range of Motion (Flexion / Extension / Rotation / Lateral Flexion)","Power (myotomes C5â€“T1)","Sensation (dermatomes)","Reflexes (biceps C5, triceps C7, brachioradialis C6)","Spurling's Test","Lhermitte's Sign"],
  "Shoulder":["Inspection","Palpation","Range of Motion (Flexion / Abduction / External & Internal Rotation)","Power","Sensation","Reflexes","Neer's Test","Hawkins-Kennedy Test","Job's Test (Empty Can)","Apprehension Test","O'Brien's Test"],
  "Elbow":["Inspection","Palpation","Range of Motion (Flexion / Extension / Pronation / Supination)","Power","Sensation","Reflexes","Valgus / Varus Stress","Tinel's Sign (Cubital Tunnel)"],
  "Wrist & Hand":["Inspection","Palpation","Range of Motion (Flexion / Extension / Radial & Ulnar Deviation)","Power (grip)","Sensation","Reflexes","Tinel's (Carpal Tunnel)","Phalen's Test","Finkelstein's Test"],
  "Lumbar Spine":["Inspection","Palpation","Range of Motion (Flexion / Extension / Lateral Flexion / Rotation)","Power (myotomes L1â€“S1)","Sensation (dermatomes)","Reflexes (knee L4, ankle S1)","Straight Leg Raise (SLR)","Crossed SLR","Femoral Nerve Stretch"],
  "Hip":["Inspection","Palpation","Range of Motion (Flexion / Extension / Abduction / Adduction / IR & ER)","Power","Sensation","FABER Test","FADIR Test","Thomas Test","Trendelenburg Test"],
  "Knee":["Inspection","Palpation","Range of Motion (Flexion / Extension)","Power (quadriceps / hamstrings)","Sensation","Reflexes (patellar)","Lachman's Test","Anterior / Posterior Drawer","McMurray's Test","Valgus / Varus Stress"],
  "Ankle & Foot":["Inspection","Palpation","Range of Motion (Dorsiflexion / Plantar Flexion / Inversion / Eversion)","Power (big toe, ankle)","Sensation","Reflexes (Achilles)","Anterior Drawer Test","Talar Tilt Test","Thompson's Test"],
};
const ADL_BASIC = ["Bowel control","Bladder control","Grooming","Toileting","Feeding","Transfer (chair to bed)","Indoor mobility","Dressing","Stairs","Bathing"];
const ADL_ADV   = ["Driving a car","Sexual function","Medical self-care","Money management","Writing & communication","Travelling","Shopping","Cooking","Housework","Moderate activities (pushing/lifting)","Vigorous activities (sport/heavy lifting)"];
const ADL_OPTS_B = ["No Effect","Mild","Moderate","Severe"];
const ADL_OPTS_A = ["N/A","No Effect","Mild","Moderate","Severe"];

function newReport(){
  return {
    created:new Date().toISOString(),updated:new Date().toISOString(),
    drName:"",quals:"",ourRef:"",attRef:"",attorney:"",attContact:"",
    patientName:"",refNum:"",gender:"",dob:"",age:"",address:"",contact:"",
    doi:"",mechanism:"Motor Vehicle Accident",preOccupation:"",postOccupation:"",
    dateExam:"",placeExam:"RG Medlegal Rooms, Kings Court Centre, Walmer Heights, Gqeberha, 6070",
    ch2grade:"",ch2tertiary:"",ch2occ:"",ch2postOcc:"",
    ch2injuries:"None reported.",ch2surgery:"None reported.",ch2medical:"None reported.",ch2meds:"None reported.",
    ch1:"",ch3:"",ch3prompts:{},ch4injuries:[],ch5:"",
    ch6general:"",ch6msk:{},ch6scarring:"",ch6radiology:"",
    ch7:"",ch8ortho:"",ch8ref:"",
    adlBasic:{},adlAdv:{},ch9occ:"",
    wpiRows:[{region:"",impairment:"",reference:"",wpi:""}],
    examRegions:{},ch10:"",
  };
}

// â”€â”€ VOICE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useVoice(){
  const [active,setActive]=useState(false);
  const [ok]=useState(()=>'webkitSpeechRecognition' in window||'SpeechRecognition' in window);
  const rec=useRef(null);const cb=useRef(null);
  const start=useCallback((fn)=>{
    if(!ok){alert("Voice not supported in this browser.");return;}
    cb.current=fn;
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    const r=new SR();r.lang="en-ZA";r.continuous=true;r.interimResults=false;
    r.onresult=e=>{const t=Array.from(e.results).map(r=>r[0].transcript).join(" ");cb.current&&cb.current(t);};
    r.onerror=()=>setActive(false);r.onend=()=>setActive(false);
    r.start();rec.current=r;setActive(true);
  },[ok]);
  const stop=useCallback(()=>{rec.current&&(rec.current.stop(),rec.current=null);setActive(false);},[]);
  return {active,ok,start,stop};
}

// â”€â”€ AI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function ai(text,prompt,key){
  if(!key||!text.trim())return text;
  try{
    const r=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":key,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({model:"claude-haiku-4-5-20251001",max_tokens:2000,messages:[{role:"user",content:`${prompt}\n\nText:\n${text}`}]})
    });
    const d=await r.json();return d?.content?.[0]?.text||text;
  }catch{return text;}
}

// â”€â”€ SMART TEXTAREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SmartTA({value,onChange,placeholder,rows=5,label,hint,apiKey,aiPrompt}){
  const voice=useVoice();
  const [busy,setBusy]=useState(false);
  const val=useRef(value);
  useEffect(()=>{val.current=value;},[value]);
  const toggleMic=()=>{
    if(voice.active){voice.stop();return;}
    voice.start(t=>onChange((val.current?val.current+" ":"")+t));
  };
  const runAI=async()=>{
    if(!value.trim()||!apiKey)return;
    setBusy(true);
    onChange(await ai(value,aiPrompt||"Correct grammar and formatting for a South African medico-legal orthopaedic report. Return only the corrected text."));
    setBusy(false);
  };
  return (
    <div className="field">
      {label&&<label>{label}</label>}
      <div className="ta-wrap">
        <textarea rows={rows} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>
        <div className="ta-tools">
          {voice.ok&&<button className={`mic ${voice.active?"on":"off"}`} onClick={toggleMic} title={voice.active?"Stop recording":"Voice (SA English)"}>{voice.active?"â¹":"ğŸ¤"}</button>}
          {apiKey&&<button className="aibtn" onClick={runAI} disabled={busy||!value.trim()} title="AI: clean & format">{busy?<span className="spin"/>:"âœ¨"}</button>}
        </div>
      </div>
      {hint&&<div className="fhint">{hint}</div>}
    </div>
  );
}

// â”€â”€ CHAPTER 0 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Ch0({r,setR}){
  const f=k=>e=>setR(p=>({...p,[k]:e.target.value}));
  return(<>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ¢</div><div><div className="card-title">Practice Details</div><div className="card-desc">Doctor and reference information</div></div></div>
      <div className="g2">
        <div className="field"><label>Doctor Name</label><input value={r.drName} onChange={f("drName")} placeholder="Dr Sayed M Mia"/></div>
        <div className="field"><label>Qualifications</label><input value={r.quals} onChange={f("quals")} placeholder="FC Ortho (SA)"/></div>
      </div>
      <div className="g2">
        <div className="field"><label>Our Reference</label><input value={r.ourRef} onChange={f("ourRef")} placeholder="RGML/SMM/szb/26453"/></div>
        <div className="field"><label>Attorney Reference</label><input value={r.attRef} onChange={f("attRef")} placeholder="TIMOTHY/MS_BURO"/></div>
      </div>
      <div className="g2">
        <div className="field"><label>Instructing Attorney</label><input value={r.attorney} onChange={f("attorney")} placeholder="David Rossouw Attorneys"/></div>
        <div className="field"><label>Attorney Contact</label><input value={r.attContact} onChange={f("attContact")} placeholder="041 030 0107"/></div>
      </div>
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ‘¤</div><div><div className="card-title">Patient Details</div></div></div>
      <div className="field"><label>Full Name</label><input value={r.patientName} onChange={f("patientName")} placeholder="MOHAMUD SAID BURO"/></div>
      <div className="g2">
        <div className="field"><label>ID / Reference Number</label><input value={r.refNum} onChange={f("refNum")}/></div>
        <div className="field"><label>Gender</label><select value={r.gender} onChange={f("gender")}><option value="">Select...</option><option>Male</option><option>Female</option><option>Other</option></select></div>
      </div>
      <div className="g3">
        <div className="field"><label>Date of Birth</label><input type="date" value={r.dob} onChange={f("dob")}/></div>
        <div className="field"><label>Age</label><input value={r.age} onChange={f("age")} placeholder="47"/></div>
        <div className="field"><label>Contact Number</label><input value={r.contact} onChange={f("contact")}/></div>
      </div>
      <div className="field"><label>Residential Address</label><input value={r.address} onChange={f("address")}/></div>
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸš—</div><div><div className="card-title">Accident & Examination</div></div></div>
      <div className="g2">
        <div className="field"><label>Date of Injury</label><input type="date" value={r.doi} onChange={f("doi")}/></div>
        <div className="field"><label>Mechanism of Injury</label><input value={r.mechanism} onChange={f("mechanism")}/></div>
      </div>
      <div className="g2">
        <div className="field"><label>Pre-Accident Occupation</label><input value={r.preOccupation} onChange={f("preOccupation")}/></div>
        <div className="field"><label>Post-Accident Occupation</label><input value={r.postOccupation} onChange={f("postOccupation")}/></div>
      </div>
      <div className="g2">
        <div className="field"><label>Date of Examination</label><input type="date" value={r.dateExam} onChange={f("dateExam")}/></div>
        <div className="field"><label>Place of Examination</label><input value={r.placeExam} onChange={f("placeExam")}/></div>
      </div>
    </div>
  </>);
}
function Ch1({r,setR,apiKey}){return<div className="card"><div className="card-h"><div className="card-ico">ğŸ“</div><div><div className="card-title">Documents Perused</div><div className="card-desc">List all documents reviewed, one per line</div></div></div><SmartTA value={r.ch1} onChange={v=>setR(p=>({...p,ch1:v}))} rows={10} apiKey={apiKey} placeholder={"1. Instruction Letter\n2. Refugee Status of Client\n3. Accident Report\n4. Ambulance Voucher\n5. Hospital Records\n6. Patient Questionnaire"}/></div>;}
function Ch2({r,setR,apiKey}){
  const f=k=>e=>setR(p=>({...p,[k]:e.target.value}));
  return(<>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ’¼</div><div><div className="card-title">2.1 Occupational History</div></div></div>
      <div className="g2">
        <div className="field"><label>Highest Grade Passed</label><input value={r.ch2grade} onChange={f("ch2grade")} placeholder="Grade 7"/></div>
        <div className="field"><label>Tertiary Education</label><input value={r.ch2tertiary} onChange={f("ch2tertiary")} placeholder="None"/></div>
      </div>
      <SmartTA label="Pre-Accident Occupation (Detail)" value={r.ch2occ} onChange={v=>setR(p=>({...p,ch2occ:v}))} rows={4} apiKey={apiKey} placeholder="At the time of the accident, the patient was employed as..."/>
      <SmartTA label="Post-Accident Occupation (Detail)" value={r.ch2postOcc||""} onChange={v=>setR(p=>({...p,ch2postOcc:v}))} rows={4} apiKey={apiKey} placeholder="Following the accident, the patient..."/>
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ¥</div><div><div className="card-title">2.2 Past Medical & Surgical History</div></div></div>
      <div className="g2">
        <div className="field"><label>Previous Injuries</label><input value={r.ch2injuries} onChange={f("ch2injuries")} placeholder="None reported."/></div>
        <div className="field"><label>Surgical History</label><input value={r.ch2surgery} onChange={f("ch2surgery")} placeholder="None reported."/></div>
      </div>
      <div className="g2">
        <div className="field"><label>Medical History</label><input value={r.ch2medical} onChange={f("ch2medical")} placeholder="None reported."/></div>
        <div className="field"><label>Chronic Medication</label><input value={r.ch2meds} onChange={f("ch2meds")} placeholder="None reported."/></div>
      </div>
    </div>
  </>);
}
function Ch3({r,setR,apiKey}){
  const sp=(l,v)=>setR(p=>({...p,ch3prompts:{...p.ch3prompts,[l]:v}}));
  return(<>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ“‹</div><div><div className="card-title">3.1 Management and Diagnosis</div><div className="card-desc">Follow each prompt â€” dictate or type</div></div></div>
      {CH3_PROMPTS.map(p=>(
        <div className="prompt-block" key={p.letter}>
          <div className="prompt-lbl">Section {p.letter.toUpperCase()}</div>
          <div className="prompt-guide">{p.text}</div>
          <SmartTA value={r.ch3prompts?.[p.letter]||""} onChange={v=>sp(p.letter,v)} rows={3} apiKey={apiKey} placeholder={`Dictate section ${p.letter.toUpperCase()}...`}/>
        </div>
      ))}
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ”„</div><div><div className="card-title">3.2 Post-Trauma Follow-Up</div></div></div>
      <SmartTA value={r.ch3} onChange={v=>setR(p=>({...p,ch3:v}))} rows={5} apiKey={apiKey} placeholder="The patient attended multiple follow-up appointments..."/>
    </div>
  </>);
}
function Ch4({r,setR}){
  const [ni,setNi]=useState("");
  const add=()=>{if(!ni.trim())return;setR(p=>({...p,ch4injuries:[...(p.ch4injuries||[]),ni.trim()]}));setNi("");};
  const rm=i=>setR(p=>({...p,ch4injuries:p.ch4injuries.filter((_,x)=>x!==i)}));
  return(
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ¦´</div><div><div className="card-title">Injuries Sustained</div><div className="card-desc">List each injury extracted from hospital records</div></div></div>
      <div style={{marginBottom:14}}>
        {!(r.ch4injuries||[]).length&&<div style={{padding:"20px",textAlign:"center",color:"var(--t3)",fontSize:13,background:"var(--raised)",borderRadius:8,border:"1px dashed var(--line)"}}>No injuries added yet â€” add below</div>}
        {(r.ch4injuries||[]).map((inj,i)=>(
          <div className="inj-item" key={i}>
            <div className="inj-dot"/>
            <div className="inj-txt">{inj}</div>
            <button className="btn btn-g btn-sm" style={{color:"var(--red)"}} onClick={()=>rm(i)}>âœ•</button>
          </div>
        ))}
      </div>
      <div style={{display:"flex",gap:9}}>
        <input style={{flex:1,background:"var(--panel)",border:"1px solid var(--rim)",borderRadius:8,padding:"10px 13px",fontSize:14,color:"var(--t1)",outline:"none"}}
          value={ni} onChange={e=>setNi(e.target.value)} onKeyDown={e=>e.key==="Enter"&&add()} placeholder="e.g. Right foot fractures of the distal metatarsal bones"/>
        <button className="btn btn-p" onClick={add}>+ Add</button>
      </div>
    </div>
  );
}
function Ch5({r,setR,apiKey}){return<div className="card"><div className="card-h"><div className="card-ico">ğŸ’¬</div><div><div className="card-title">Current Complaints</div><div className="card-desc">As reported by the patient during examination</div></div></div><SmartTA value={r.ch5} onChange={v=>setR(p=>({...p,ch5:v}))} rows={12} apiKey={apiKey} placeholder={"Pre-accident symptoms:\nThe patient reports no history of injury...\n\nCurrent complaints:\nAccording to the patient he experiences a stabbing pain..."}/></div>;}
function Ch6({r,setR,apiKey}){
  const [sel,setSel]=useState(null);
  const active=Object.keys(r.examRegions||{}).filter(k=>r.examRegions[k]);
  const add=rg=>{setR(p=>({...p,examRegions:{...p.examRegions,[rg]:true}}));setSel(rg);};
  const rm=rg=>{const n={...r.examRegions};delete n[rg];setR(p=>({...p,examRegions:n}));if(sel===rg)setSel(null);};
  const upd=(rg,fld,v)=>setR(p=>({...p,ch6msk:{...p.ch6msk,[rg]:{...(p.ch6msk?.[rg]||{}),[fld]:v}}}));
  return(<>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ§</div><div><div className="card-title">6.1 General Examination</div></div></div>
      <SmartTA value={r.ch6general||""} onChange={v=>setR(p=>({...p,ch6general:v}))} rows={6} apiKey={apiKey} placeholder={"Gait: ...\nGeneral impression: Well-kempt.\nAssistive devices: None.\nHome language: ...\nDexterity: Right-handed."}/>
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ”</div><div><div className="card-title">6.2 Musculoskeletal Examination</div><div className="card-desc">Select a region to load guided examination prompts</div></div></div>
      <div className="region-grid">
        <div>
          {Object.keys(EXAM_REGIONS).map(rg=>(
            <button key={rg} className={`region-btn${sel===rg?" active":""}`}
              style={active.includes(rg)&&sel!==rg?{borderColor:"rgba(0,229,216,.3)",color:"var(--teal-dim)"}:{}}
              onClick={()=>active.includes(rg)?setSel(rg):add(rg)}>
              {active.includes(rg)?"âœ“ ":""}{rg}
            </button>
          ))}
        </div>
        <div style={{minWidth:0}}>
          {!sel&&<div style={{padding:"36px 20px",textAlign:"center",color:"var(--t3)",background:"var(--raised)",borderRadius:10,border:"1px dashed var(--line)"}}><div style={{fontSize:30,marginBottom:10}}>ğŸ¦´</div><div style={{fontWeight:600,marginBottom:4,color:"var(--t2)"}}>Select a region</div><div style={{fontSize:12}}>Click any region on the left to begin</div></div>}
          {sel&&(<div>
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:14}}>
              <div style={{fontFamily:"'Syne',sans-serif",fontSize:15,fontWeight:700,color:"var(--teal)"}}>{sel}</div>
              <button className="btn btn-d btn-sm" onClick={()=>rm(sel)}>Remove</button>
            </div>
            {EXAM_REGIONS[sel].map(fld=>(
              <div key={fld}>
                <div className="region-fld">ğŸ“Œ {fld}</div>
                <SmartTA value={r.ch6msk?.[sel]?.[fld]||""} onChange={v=>upd(sel,fld,v)} rows={2} apiKey={apiKey} placeholder={`Enter ${fld.toLowerCase()} findings...`}/>
              </div>
            ))}
          </div>)}
        </div>
      </div>
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ“¸</div><div><div className="card-title">6.3 Evidence of Injury & Special Investigations</div></div></div>
      <div style={{marginBottom:18}}>
        <div style={{fontSize:13,fontWeight:600,color:"var(--t1)",marginBottom:8}}>6.3.1 Scarring / Disfigurement / Deformity</div>
        <SmartTA value={r.ch6scarring||""} onChange={v=>setR(p=>({...p,ch6scarring:v}))} rows={3} apiKey={apiKey} placeholder="Description of visible scarring, deformity, or disfigurement..."/>
      </div>
      <div>
        <div style={{fontSize:13,fontWeight:600,color:"var(--t1)",marginBottom:8}}>6.3.2 Radiological Examination</div>
        <SmartTA value={r.ch6radiology||""} onChange={v=>setR(p=>({...p,ch6radiology:v}))} rows={8} apiKey={apiKey} placeholder={"Exam Date:\nX-RAY [REGION]\nBones: ...\nSoft tissue: Normal\nOther: Normal"}/>
      </div>
    </div>
  </>);
}
function Ch7({r,setR,apiKey}){return<div className="card"><div className="card-h"><div className="card-ico">ğŸ“Š</div><div><div className="card-title">Diagnosis</div><div className="card-desc">Following thorough review of records and examination</div></div></div><SmartTA value={r.ch7} onChange={v=>setR(p=>({...p,ch7:v}))} rows={12} apiKey={apiKey} placeholder={"1. Soft tissue injury of the right leg treated conservatively.\n2. Right foot fractures resulting in:\n   a. Pain and swelling...\n   b. Tender bony deformity at the mid-foot..."}/></div>;}
function Ch8({r,setR,apiKey}){return(<>
  <div className="card"><div className="card-h"><div className="card-ico">ğŸ”§</div><div><div className="card-title">8.1 Orthopaedic Treatment</div></div></div><SmartTA value={r.ch8ortho} onChange={v=>setR(p=>({...p,ch8ortho:v}))} rows={8} apiKey={apiKey} placeholder={"Right foot and ankle:\na) Referral to podiatrist for specialised footwear.\nb) NSAIDs and analgesics â€” approx R500/month.\nc) Physiotherapy at R600 per session.\nd) Occupational therapy at R600 per session."}/></div>
  <div className="card"><div className="card-h"><div className="card-ico">ğŸ‘¥</div><div><div className="card-title">8.2 Referrals</div></div></div><SmartTA value={r.ch8ref} onChange={v=>setR(p=>({...p,ch8ref:v}))} rows={5} apiKey={apiKey} placeholder={"1. Podiatrist\n2. Physiotherapist\n3. Occupational Therapist\n4. Industrial Psychologist"}/></div>
  <div className="card"><div className="card-h"><div className="card-ico">â„¹ï¸</div><div><div className="card-title">8.3 Burden of Treatment</div><div className="card-desc">Standard paragraph â€” auto-included</div></div></div><div className="std-box"><div className="std-lbl">Auto-included in report</div>Side effects from regular use of NSAIDs and analgesics include but are not limited to allergic reactions, peptic ulcer disease, heartburn, gastritis, kidney and liver damage, excessive bleeding, heart problems, and toxicity. Careful monitoring is essential as one can become dependent and/or suffer harmful side effects. Additionally, the burden of cost, drug dependence, regional availability of medication, and compliance could become a stressor in the patient's life.</div></div>
  <div className="card"><div className="card-h"><div className="card-ico">ğŸ’°</div><div><div className="card-title">8.4 Additional Expenses</div><div className="card-desc">Standard paragraph â€” auto-included</div></div></div><div className="std-box"><div className="std-lbl">Auto-included in report</div>Other specialist consultation rates and further treatment costs are to be determined by the relevant specialist. Transportation costs are to be determined by the Occupational Therapist. Medical inflation rates need to be taken into consideration as determined annually.</div></div>
</>);}
function Ch9({r,setR,apiKey}){
  const sa=(t,a,v)=>{const k=t==="b"?"adlBasic":"adlAdv";setR(p=>({...p,[k]:{...p[k],[a]:v}}));};
  const uw=(i,f,v)=>{const rows=[...(r.wpiRows||[])];rows[i]={...rows[i],[f]:v};setR(p=>({...p,wpiRows:rows}));};
  const addRow=()=>setR(p=>({...p,wpiRows:[...(p.wpiRows||[]),{region:"",impairment:"",reference:"",wpi:""}]}));
  const rmRow=i=>setR(p=>({...p,wpiRows:p.wpiRows.filter((_,x)=>x!==i)}));
  const totalWpi=(r.wpiRows||[]).reduce((a,row)=>a+(parseFloat(row.wpi)||0),0).toFixed(0);
  const adlBlock=(items,opts,t)=>(
    <table className="adl-tbl">
      <thead><tr><th style={{textAlign:"left",width:"36%"}}>Activity</th>{opts.map(o=><th key={o}>{o}</th>)}</tr></thead>
      <tbody>{items.map(act=>(
        <tr key={act}><td style={{fontWeight:500,fontSize:12}}>{act}</td>
          {opts.map(opt=><td key={opt}><div className="adl-r"><label><input type="radio" name={`${t}_${act}`} value={opt} checked={(r[t==="b"?"adlBasic":"adlAdv"]?.[act]||"")===opt} onChange={()=>sa(t,act,opt)}/></label></div></td>)}
        </tr>
      ))}</tbody>
    </table>
  );
  return(<>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸƒ</div><div><div className="card-title">9.1 Activities of Daily Living</div><div className="card-desc">As reported by the patient</div></div></div>
      <div style={{marginBottom:22}}><div style={{fontSize:12,fontWeight:600,color:"var(--t2)",marginBottom:10,textTransform:"uppercase",letterSpacing:".5px"}}>Basic ADL</div><div style={{overflowX:"auto"}}>{adlBlock(ADL_BASIC,ADL_OPTS_B,"b")}</div></div>
      <div><div style={{fontSize:12,fontWeight:600,color:"var(--t2)",marginBottom:10,textTransform:"uppercase",letterSpacing:".5px"}}>Advanced ADL</div><div style={{overflowX:"auto"}}>{adlBlock(ADL_ADV,ADL_OPTS_A,"a")}</div></div>
    </div>
    <div className="card"><div className="card-h"><div className="card-ico">ğŸ§‘â€ğŸ’¼</div><div><div className="card-title">9.2 Occupational Effects and Limitations</div></div></div><SmartTA value={r.ch9occ||""} onChange={v=>setR(p=>({...p,ch9occ:v}))} rows={8} apiKey={apiKey} placeholder={"The patient was employed as a general worker at the time of the accident.\nRecuperation period was approximately 1 year..."}/></div>
    <div className="card">
      <div className="card-h"><div className="card-ico">âš–ï¸</div><div><div className="card-title">9.3 Narrative Test</div><div className="card-desc">Standard RAF section â€” edit in exported document</div></div></div>
      <div className="std-box"><div className="std-lbl">Standard RAF text</div>The Road Accident Fund (RAF) Amendment Regulations of 2008 prescribes the use of the Narrative Test to determine the seriousness of an individual's injuries if the WPI is less than 30% in accordance with the AMA Guides. Criteria: <strong style={{color:"var(--t2)"}}>5.1 Serious long-term impairment or loss of a body function. 5.2 Permanent serious disfigurement. 5.3 Severe long-term mental/behavioural disturbance. 5.4 Loss of a foetus.</strong></div>
    </div>
    <div className="card">
      <div className="card-h"><div className="card-ico">ğŸ“</div><div><div className="card-title">9.5 Whole Person Impairment (WPI)</div><div className="card-desc">AMA GuidesÂ® 6th Edition</div></div></div>
      <div style={{overflowX:"auto",marginBottom:12}}>
        <table className="wpi-tbl" style={{minWidth:580}}>
          <thead><tr><th>Region</th><th>Impairment Description</th><th>Reference</th><th style={{width:80}}>WPI %</th><th style={{width:36}}></th></tr></thead>
          <tbody>
            {(r.wpiRows||[]).map((row,i)=>(
              <tr key={i}>
                <td><input value={row.region} onChange={e=>uw(i,"region",e.target.value)} placeholder="Lower Extremities"/></td>
                <td><input value={row.impairment} onChange={e=>uw(i,"impairment",e.target.value)} placeholder="Right foot fractures..."/></td>
                <td><input value={row.reference} onChange={e=>uw(i,"reference",e.target.value)} placeholder="P501-505, T16-2"/></td>
                <td><input value={row.wpi} onChange={e=>uw(i,"wpi",e.target.value)} placeholder="8%"/></td>
                <td><button className="btn btn-g btn-sm" style={{color:"var(--red)",padding:"4px 6px"}} onClick={()=>rmRow(i)}>âœ•</button></td>
              </tr>
            ))}
            <tr><td colSpan={3} style={{fontWeight:700,fontSize:13,color:"var(--t2)"}}>Combined WPI</td><td><span className="wpi-total">{totalWpi}%</span></td><td></td></tr>
          </tbody>
        </table>
      </div>
      <button className="btn btn-s btn-sm" onClick={addRow}>+ Add Row</button>
    </div>
  </>);
}
function Ch10({r,setR,apiKey}){return<div className="card"><div className="card-h"><div className="card-ico">ğŸ“</div><div><div className="card-title">Discussion</div><div className="card-desc">Professional opinion and summary findings</div></div></div><SmartTA value={r.ch10||""} onChange={v=>setR(p=>({...p,ch10:v}))} rows={14} apiKey={apiKey} placeholder={"Mr. [Name] was involved in a motor vehicle accident on [date].\n\nHe sustained [injuries] and continues to suffer from the sequelae of his injury.\n\nTherefore, it is my professional opinion that his injuries are serious and qualify under 5.1 Serious long-term impairment or loss of a body function.\n\nHis Whole Person Impairment (WPI) is [X]% in accordance with the AMA GuidesÂ® 6th Edition.\n\nFrom an orthopaedic perspective, the injury will have no effect on his life expectancy."}/></div>;}

// â”€â”€ PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Preview({r,onBack}){
  const fmt=iso=>{if(!iso)return "";try{return new Date(iso).toLocaleDateString("en-ZA",{day:"2-digit",month:"long",year:"numeric"});}catch{return iso;}};
  const adlTbl=(title,items,opts,t)=>{
    const k=t==="b"?"adlBasic":"adlAdv";
    return`<h3>${title}</h3><table><thead><tr><th style="text-align:left">Activity</th>${opts.map(o=>`<th>${o}</th>`).join("")}</tr></thead><tbody>`+items.map(act=>`<tr><td>${act}</td>${opts.map(opt=>`<td style="text-align:center">${r[k]?.[act]===opt?"âœ“":""}</td>`).join("")}</tr>`).join("")+"</tbody></table>";
  };
  const injuries=(r.ch4injuries||[]).map((inj,i)=>`<p>${i+1}. ${inj}</p>`).join("");
  const prompts=CH3_PROMPTS.map(p=>{const v=r.ch3prompts?.[p.letter];return v?`<p><strong>${p.letter.toUpperCase()}.</strong> ${v}</p>`:""}).filter(Boolean).join("");
  const msk=Object.keys(r.examRegions||{}).filter(k=>r.examRegions[k]).map(rg=>{
    const c=EXAM_REGIONS[rg].map(f=>{const v=r.ch6msk?.[rg]?.[f];return v?`<p><strong>${f}:</strong> ${v}</p>`:""}).filter(Boolean).join("");
    return c?`<h3>${rg}</h3>${c}`:"";
  }).filter(Boolean).join("");
  const wpiRows=(r.wpiRows||[]).map(row=>`<tr><td>${row.region}</td><td>${row.impairment}</td><td>${row.reference}</td><td>${row.wpi}</td></tr>`).join("");
  const wpiTotal=(r.wpiRows||[]).reduce((a,row)=>a+(parseFloat(row.wpi)||0),0).toFixed(0);
  const html=`
    <h1>MEDICO-LEGAL REPORT</h1>
    <p style="text-align:center"><strong>Our Reference:</strong> ${r.ourRef||""} &nbsp;|&nbsp; <strong>Attorney Reference:</strong> ${r.attRef||""}</p><br/>
    <table><tbody>
      <tr><td><strong>Patient Full Name:</strong></td><td>${r.patientName||""}</td><td><strong>ID/Reference:</strong></td><td>${r.refNum||""}</td></tr>
      <tr><td><strong>Gender:</strong></td><td>${r.gender||""}</td><td><strong>Date of Birth:</strong></td><td>${fmt(r.dob)}</td></tr>
      <tr><td><strong>Current Age:</strong></td><td>${r.age||""}</td><td><strong>Contact:</strong></td><td>${r.contact||""}</td></tr>
      <tr><td><strong>Address:</strong></td><td colspan="3">${r.address||""}</td></tr>
      <tr><td><strong>Date of Injury:</strong></td><td>${fmt(r.doi)}</td><td><strong>Mechanism:</strong></td><td>${r.mechanism||""}</td></tr>
      <tr><td><strong>Pre-Accident Occupation:</strong></td><td>${r.preOccupation||""}</td><td><strong>Post-Accident Occupation:</strong></td><td>${r.postOccupation||""}</td></tr>
      <tr><td><strong>Date of Examination:</strong></td><td>${fmt(r.dateExam)}</td><td><strong>Place:</strong></td><td>${r.placeExam||""}</td></tr>
      <tr><td><strong>Instructing Attorney:</strong></td><td>${r.attorney||""}</td><td><strong>Contact:</strong></td><td>${r.attContact||""}</td></tr>
    </tbody></table>
    <h2>1. DOCUMENTS PERUSED</h2><div class="bt">${(r.ch1||"").replace(/\n/g,"<br/>")}</div>
    <h2>2. OCCUPATIONAL AND MEDICAL HISTORY</h2>
    <h3>2.1 Occupational History</h3>
    <p><strong>Highest grade passed:</strong> ${r.ch2grade||""} &nbsp;&nbsp; <strong>Tertiary education:</strong> ${r.ch2tertiary||""}</p>
    <p><strong>Pre-accident occupation:</strong> ${(r.ch2occ||"").replace(/\n/g,"<br/>")}</p>
    <p><strong>Post-accident occupation:</strong> ${(r.ch2postOcc||"").replace(/\n/g,"<br/>")}</p>
    <h3>2.2 Past Medical and Surgical History</h3>
    <p><strong>Previous injuries:</strong> ${r.ch2injuries||""} &nbsp;&nbsp; <strong>Surgical history:</strong> ${r.ch2surgery||""}</p>
    <p><strong>Medical history:</strong> ${r.ch2medical||""} &nbsp;&nbsp; <strong>Chronic medication:</strong> ${r.ch2meds||""}</p>
    <h2>3. SUMMARY OF THE HOSPITAL RECORDS</h2>
    <h3>3.1 Management and Diagnosis</h3>${prompts}
    <h3>3.2 Post-Trauma Follow-Up and Treatment</h3><div class="bt">${(r.ch3||"").replace(/\n/g,"<br/>")}</div>
    <h2>4. INJURIES SUSTAINED</h2>${injuries||"<p>No injuries listed.</p>"}
    <h2>5. CURRENT COMPLAINTS</h2><div class="bt">${(r.ch5||"").replace(/\n/g,"<br/>")}</div>
    <h2>6. CLINICAL EVALUATION</h2>
    <h3>6.1 General Examination</h3><div class="bt">${(r.ch6general||"").replace(/\n/g,"<br/>")}</div>
    <h3>6.2 Musculoskeletal Examination</h3>${msk||"<p>No examination findings entered.</p>"}
    <h3>6.3 Evidence of Injury &amp; Special Investigations</h3>
    <h4>6.3.1 Scarring and Disfigurement/Deformity</h4><div class="bt">${(r.ch6scarring||"").replace(/\n/g,"<br/>")}</div>
    <h4>6.3.2 Radiological Examination</h4><div class="bt">${(r.ch6radiology||"").replace(/\n/g,"<br/>")}</div>
    <h2>7. DIAGNOSIS</h2>
    <p>Following a thorough review of the patient's available records, the patient interview, clinical examination, and special investigation findings, I diagnose the patient as follows:</p>
    <div class="bt">${(r.ch7||"").replace(/\n/g,"<br/>")}</div>
    <h2>8. FURTHER MANAGEMENT</h2>
    <h3>8.1 Orthopaedic Treatment</h3><div class="bt">${(r.ch8ortho||"").replace(/\n/g,"<br/>")}</div>
    <h3>8.2 Referrals</h3><div class="bt">${(r.ch8ref||"").replace(/\n/g,"<br/>")}</div>
    <h3>8.3 Burden of Treatment</h3>
    <p>Side effects from regular use of NSAIDs and analgesics include but are not limited to allergic reactions, peptic ulcer disease, heartburn, gastritis, kidney and liver damage, excessive bleeding, heart problems, and toxicity. Careful monitoring is essential. The burden of cost, drug dependence, regional availability of medication, and compliance could become a stressor in the patient's life.</p>
    <h3>8.4 Additional Expenses</h3>
    <p>Other specialist consultation rates and further treatment costs are to be determined by the relevant specialist. Transportation costs are to be determined by the Occupational Therapist. Medical inflation rates need to be taken into consideration annually.</p>
    <h2>9. DISABILITY &amp; IMPAIRMENT</h2>
    <h3>9.1 Activities of Daily Living â€” As Reported by the Patient</h3>
    ${adlTbl("Basic Activities of Daily Living",ADL_BASIC,ADL_OPTS_B,"b")}
    ${adlTbl("Advanced Activities of Daily Living",ADL_ADV,ADL_OPTS_A,"a")}
    <h3>9.2 Occupational Effects and Limitations</h3><div class="bt">${(r.ch9occ||"").replace(/\n/g,"<br/>")}</div>
    <h3>9.3 Applying the Narrative Test</h3>
    <p>The Road Accident Fund (RAF) Amendment Regulations of 2008 prescribes the use of the Narrative Test as a medical instrument to determine the seriousness of an individual's injuries if the WPI is less than 30% in accordance with the AMA Guides, and if the medical practitioner regards the injuries as serious. Criteria considered: <strong>5.1 Serious long-term impairment or loss of a body function. 5.2 Permanent serious disfigurement. 5.3 Severe long-term mental or behavioural disturbance or disorder. 5.4 Loss of a foetus.</strong></p>
    <h3>9.5 Whole Person Impairment</h3>
    <table><thead><tr><th>Region</th><th>Impairment</th><th>Reference</th><th>WPI</th></tr></thead>
    <tbody>${wpiRows}<tr><td colspan="3"><strong>Combined WPI</strong></td><td><strong>${wpiTotal}%</strong></td></tr></tbody></table>
    <h2>10. DISCUSSION</h2><div class="bt">${(r.ch10||"").replace(/\n/g,"<br/>")}</div>
    <div style="margin-top:60px;padding-top:20px;border-top:2px solid #1a2234;">
      <p>________________________________</p>
      <p><strong>${r.drName||"[PRACTITIONER NAME]"}</strong></p>
      <p><em>${r.quals||"[QUALIFICATIONS]"}</em></p>
      <p>Orthopaedic Surgeon</p>
      <p style="font-size:9pt;margin-top:16px;color:#666;border-top:1px solid #ddd;padding-top:10px;"><strong>VALIDITY:</strong> This report will remain valid for use in a court of law for 2 (two) years from the date of first consultation. An updated report will be required if the matter is not finalised within this period.</p>
    </div>`;
  const exportDoc=()=>{
    const full=`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:'Times New Roman',serif;font-size:11pt;line-height:1.7;margin:2.5cm;}h1{font-size:14pt;text-align:center;}h2{font-size:11pt;border-bottom:2px solid #000;padding-bottom:3px;margin:20px 0 8px;}h3{font-size:10.5pt;margin:14px 0 5px;}h4{font-size:10pt;margin:10px 0 4px;}table{width:100%;border-collapse:collapse;margin:10px 0;}th,td{border:1px solid #ccc;padding:5px 8px;font-size:9.5pt;}th{background:#1a2234;color:#fff;}.bt{margin-bottom:8px;}</style></head><body>${html}</body></html>`;
    const b=new Blob([full],{type:"application/msword"});
    const a=document.createElement("a");a.href=URL.createObjectURL(b);
    a.download=`MediSync_${(r.patientName||"Report").replace(/\s+/g,"_")}_${new Date().toISOString().slice(0,10)}.doc`;a.click();
  };
  const copyTxt=()=>{const d=document.createElement("div");d.innerHTML=html;navigator.clipboard.writeText(d.textContent||"");};
  return(
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <div className="ch-bar no-print">
        <div className="ch-left">
          <div className="ch-badge">ğŸ‘</div>
          <div><div className="ch-title">Report Preview</div><div className="ch-sub">Read-only â€” export or print to share</div></div>
        </div>
        <button className="btn btn-s" onClick={onBack}>â† Back to Editor</button>
      </div>
      <div className="preview-bg"><div className="preview-page" dangerouslySetInnerHTML={{__html:html}}/></div>
      <div className="preview-fabs no-print">
        <button className="fab" style={{background:"#7c3aed",color:"#fff"}} onClick={copyTxt} title="Copy text">ğŸ“‹</button>
        <button className="fab" style={{background:"var(--teal)",color:"#07090f"}} onClick={exportDoc} title="Export .doc">â¬‡</button>
        <button className="fab" style={{background:"var(--panel)",color:"var(--t1)",border:"1px solid var(--rim)"}} onClick={()=>window.print()} title="Print">ğŸ–¨</button>
      </div>
    </div>
  );
}

// â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen(){
  const [email,setEmail]=useState("");
  const [pass,setPass]=useState("");
  const [busy,setBusy]=useState(false);
  const [err,setErr]=useState("");
  const [reset,setReset]=useState(false);
  const [sent,setSent]=useState(false);
  const doLogin=async e=>{
    e.preventDefault();setErr("");setBusy(true);
    const {error}=await supabase.auth.signInWithPassword({email,password:pass});
    if(error)setErr(error.message);
    setBusy(false);
  };
  const doReset=async e=>{
    e.preventDefault();setErr("");setBusy(true);
    const {error}=await supabase.auth.resetPasswordForEmail(email,{redirectTo:window.location.href});
    if(error)setErr(error.message);else setSent(true);
    setBusy(false);
  };
  return(
    <div className="login-root">
      <div className="login-ring" style={{width:500,height:500,top:"50%",left:"50%",transform:"translate(-50%,-50%)"}}/>
      <div className="login-ring" style={{width:750,height:750,top:"50%",left:"50%",transform:"translate(-50%,-50%)",animationDelay:".8s",opacity:.4}}/>
      <div className="login-card">
        <div className="login-logo">
          <div className="login-mark">ğŸ”¬</div>
          <div>
            <div className="login-appname">MediSync <em>Ortho</em></div>
            <div className="login-apptag">Medico-Legal Engine</div>
          </div>
        </div>
        {!reset?(<>
          <div className="login-heading">Welcome back</div>
          <div className="login-sub">Sign in to access your reports</div>
          {err&&<div className="login-err">âš  {err}</div>}
          <form onSubmit={doLogin}>
            <div className="field"><label>Email Address</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="doctor@practice.co.za" required autoComplete="email"/></div>
            <div className="field"><label>Password</label><input type="password" value={pass} onChange={e=>setPass(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required autoComplete="current-password"/></div>
            <div className="login-forgot" onClick={()=>{setReset(true);setErr("");}}>Forgot password?</div>
            <button className="btn btn-p" style={{width:"100%",justifyContent:"center",marginTop:6,padding:"12px"}} type="submit" disabled={busy}>
              {busy?<><span className="spin"/> Signing in...</>:"Sign In â†’"}
            </button>
          </form>
          <div className="login-invite-hint">
            <div className="login-invite-label">New Staff Member?</div>
            <p>Ask your administrator to invite you via <strong>Supabase â†’ Authentication â†’ Users â†’ Invite user</strong>.</p>
          </div>
        </>):(<>
          <div className="login-heading">Reset Password</div>
          <div className="login-sub">We'll send a reset link to your email</div>
          {err&&<div className="login-err">âš  {err}</div>}
          {sent&&<div className="login-ok">âœ“ Reset link sent â€” check your inbox</div>}
          {!sent&&<form onSubmit={doReset}>
            <div className="field"><label>Email Address</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="doctor@practice.co.za" required/></div>
            <button className="btn btn-p" style={{width:"100%",justifyContent:"center",padding:"12px"}} type="submit" disabled={busy}>{busy?<><span className="spin"/> Sending...</>:"Send Reset Link"}</button>
          </form>}
          <div style={{textAlign:"center",marginTop:16}}>
            <button className="btn btn-g" onClick={()=>{setReset(false);setSent(false);setErr("");}}>â† Back to Sign In</button>
          </div>
        </>)}
      </div>
    </div>
  );
}

// â”€â”€ ACCOUNT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AccountModal({session,reports,apiKey,onSaveKey,onClose,onSignOut}){
  const [tab,setTab]=useState("account"); // account | apikey
  const [tmpKey,setTmpKey]=useState(apiKey);
  const [pwMode,setPwMode]=useState(false);
  const [newPw,setNewPw]=useState("");
  const [pwMsg,setPwMsg]=useState("");
  const [pwBusy,setPwBusy]=useState(false);
  const initials=(session?.user?.email||"??").slice(0,2).toUpperCase();
  const joined=session?.user?.created_at?new Date(session.user.created_at).toLocaleDateString("en-ZA",{day:"2-digit",month:"long",year:"numeric"}):"â€”";
  const changePw=async()=>{
    if(!newPw||newPw.length<6){setPwMsg("Password must be at least 6 characters.");return;}
    setPwBusy(true);
    const {error}=await supabase.auth.updateUser({password:newPw});
    setPwMsg(error?`Error: ${error.message}`:"âœ“ Password updated successfully.");
    setPwBusy(false);setNewPw("");
  };
  return(
    <div className="overlay" onClick={onClose}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <div className="modal-head">
          <div className="modal-title">Account & Settings</div>
          <button className="tb-icon" onClick={onClose}>âœ•</button>
        </div>
        {/* Tab bar */}
        <div style={{display:"flex",gap:4,padding:"12px 24px 0",borderBottom:"1px solid var(--glass-b)"}}>
          {[["account","ğŸ‘¤ Account"],["apikey","âœ¨ AI Key"]].map(([k,lbl])=>(
            <button key={k} onClick={()=>setTab(k)} style={{
              padding:"7px 14px",borderRadius:"7px 7px 0 0",border:"none",cursor:"pointer",
              fontSize:12,fontWeight:600,transition:"all .12s",
              background:tab===k?"var(--raised)":"transparent",
              color:tab===k?"var(--teal)":"var(--t3)",
              borderBottom:tab===k?"1px solid var(--raised)":"none",
              marginBottom:tab===k?"-1px":0,
            }}>{lbl}</button>
          ))}
        </div>
        <div className="modal-body">
          {tab==="account"&&(<>
            {/* Hero */}
            <div className="acc-hero">
              <div className="acc-hero-av">{initials}</div>
              <div>
                <div className="acc-hero-email">{session?.user?.email}</div>
                <div className="acc-hero-meta">Account created {joined}</div>
              </div>
            </div>
            {/* Stats */}
            <div className="acc-section">Activity</div>
            <div className="acc-stat"><span className="acc-stat-k">Total Reports</span><span className="acc-stat-v">{reports.length}</span></div>
            <div className="acc-stat"><span className="acc-stat-k">Reports in Progress</span><span className="acc-stat-v">{reports.filter(r=>{const f=[r.patientName,r.ch1,r.ch7,r.ch10];return f.some(x=>x&&x.trim())&&!f.every(x=>x&&x.trim());}).length}</span></div>
            {/* Change password */}
            <div className="acc-section">Security</div>
            {!pwMode?(
              <button className="btn btn-s btn-sm" onClick={()=>setPwMode(true)}>ğŸ” Change Password</button>
            ):(
              <div style={{background:"var(--raised)",border:"1px solid var(--line)",borderRadius:9,padding:14}}>
                <div className="field" style={{marginBottom:10}}><label>New Password</label><input type="password" value={newPw} onChange={e=>setNewPw(e.target.value)} placeholder="Min. 6 characters"/></div>
                {pwMsg&&<div style={{fontSize:12,color:pwMsg.startsWith("âœ“")?"var(--green)":"var(--red)",marginBottom:8}}>{pwMsg}</div>}
                <div style={{display:"flex",gap:8}}>
                  <button className="btn btn-p btn-sm" onClick={changePw} disabled={pwBusy}>{pwBusy?<span className="spin"/>:"Update"}</button>
                  <button className="btn btn-g btn-sm" onClick={()=>{setPwMode(false);setPwMsg("");setNewPw("");}}>Cancel</button>
                </div>
              </div>
            )}
          </>)}
          {tab==="apikey"&&(<>
            <div style={{fontSize:13,color:"var(--t3)",marginBottom:16,lineHeight:1.6}}>
              Enable AI-powered grammar correction and formatting assistance for all text fields. Your key is stored only in your browser â€” never on any server.
            </div>
            <div className="acc-section">Current Key</div>
            <div className="api-row" style={{marginBottom:16}}>
              <div className="api-val">{apiKey?apiKey.replace(/(.{12}).+(.{4})/,"$1â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢$2"):"No key set"}</div>
              <span className={`api-badge ${apiKey?"on":"off"}`}>{apiKey?"Active":"Inactive"}</span>
            </div>
            <div className="field"><label>Anthropic API Key</label><input type="password" value={tmpKey} onChange={e=>setTmpKey(e.target.value)} placeholder="sk-ant-..." style={{fontFamily:"monospace",letterSpacing:".5px"}}/><div className="fhint">Get yours at <strong style={{color:"var(--teal-dim)"}}>console.anthropic.com</strong></div></div>
            <div style={{display:"flex",gap:8,marginTop:4}}>
              <button className="btn btn-p btn-sm" onClick={()=>onSaveKey(tmpKey)}>Save Key</button>
              {apiKey&&<button className="btn btn-d btn-sm" onClick={()=>{setTmpKey("");onSaveKey("");}}>Remove Key</button>}
            </div>
          </>)}
        </div>
        <div className="modal-foot">
          <button className="btn btn-d" onClick={onSignOut}>â» Sign Out</button>
          <button className="btn btn-s" onClick={onClose}>Close</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App(){
  const [session,setSession]=useState(undefined);
  const [reports,setReports]=useState([]);
  const [activeId,setActiveId]=useState(null);
  const [chapter,setChapter]=useState(0);
  const [view,setView]=useState("list");  // list | editor | preview
  const [sbOpen,setSbOpen]=useState(true);
  const [toast,setToast]=useState(null);
  const [saveState,setSaveState]=useState("saved");
  const [apiKey,setApiKey]=useState(()=>localStorage.getItem("ms_apikey")||"");
  const [showAccount,setShowAccount]=useState(false);
  const [accOpen,setAccOpen]=useState(false);  // sidebar dropdown
  const [query,setQuery]=useState("");
  const [loadingRpts,setLoadingRpts]=useState(false);
  const saveTimer=useRef(null);

  // â”€â”€ AUTH â”€â”€
  useEffect(()=>{
    supabase.auth.getSession().then(({data:{session}})=>setSession(session));
    const {data:{subscription}}=supabase.auth.onAuthStateChange((_,s)=>setSession(s));
    return()=>subscription.unsubscribe();
  },[]);

  // â”€â”€ LOAD REPORTS â”€â”€
  useEffect(()=>{
    if(!session){setReports([]);return;}
    setLoadingRpts(true);
    supabase.from("reports").select("*").order("updated_at",{ascending:false})
      .then(({data,error})=>{
        if(!error&&data)setReports(data.map(row=>({...row.data,_id:row.id,_ts:row.updated_at})));
        setLoadingRpts(false);
      });
  },[session]);

  const toast2=msg=>{setToast(msg);setTimeout(()=>setToast(null),2600);};
  const signOut=async()=>{await supabase.auth.signOut();setReports([]);setActiveId(null);setView("list");setAccOpen(false);setShowAccount(false);};
  const saveApiKey=key=>{localStorage.setItem("ms_apikey",key);setApiKey(key);toast2(key?"âœ“ AI key saved":"AI key removed");};

  // â”€â”€ CLOUD SAVE â”€â”€
  const saveToDB=useCallback(async(data,dbId)=>{
    if(!session)return;
    setSaveState("saving");
    const payload={user_id:session.user.id,data:{...data},updated_at:new Date().toISOString()};
    const {error}=dbId
      ?await supabase.from("reports").update(payload).eq("id",dbId)
      :await supabase.from("reports").insert(payload);
    setSaveState(error?"error":"saved");
  },[session]);

  // â”€â”€ UPDATE REPORT â”€â”€
  const updateReport=useCallback(fn=>{
    setReports(prev=>prev.map(r=>{
      if((r._id||r._lid)!==activeId)return r;
      const updated={...fn(r),updated:new Date().toISOString()};
      clearTimeout(saveTimer.current);
      saveTimer.current=setTimeout(()=>saveToDB(updated,updated._id),1400);
      return updated;
    }));
  },[activeId,saveToDB]);

  // â”€â”€ CREATE â”€â”€
  const createReport=async()=>{
    const lid="l"+Date.now();
    const r={...newReport(),_lid:lid};
    setReports(p=>[r,...p]);
    setActiveId(lid);setChapter(0);setView("editor");
    setSaveState("saving");
    const {data,error}=await supabase.from("reports").insert({user_id:session.user.id,data:r,updated_at:new Date().toISOString()}).select().single();
    if(!error&&data){
      setReports(p=>p.map(x=>x._lid===lid?{...x,_id:data.id}:x));
      setActiveId(data.id);
    }
    setSaveState(error?"error":"saved");
  };

  // â”€â”€ DELETE â”€â”€
  const deleteReport=async id=>{
    if(!confirm("Delete this report permanently?"))return;
    const rpt=reports.find(r=>(r._id||r._lid)===id);
    if(rpt?._id)await supabase.from("reports").delete().eq("id",rpt._id);
    setReports(p=>p.filter(r=>(r._id||r._lid)!==id));
    if(activeId===id){setActiveId(null);setView("list");}
    toast2("Report deleted");
  };

  const openReport=r=>{setActiveId(r._id||r._lid);setChapter(0);setView("editor");};
  const activeReport=reports.find(r=>(r._id||r._lid)===activeId);

  const calcProg=r=>{
    const ff=[r.patientName,r.doi,r.ch1,r.ch2occ,Object.values(r.ch3prompts||{}).join(""),r.ch5,r.ch6general,r.ch7,r.ch8ortho,r.ch10];
    return Math.round(ff.filter(f=>f&&String(f).trim()).length/ff.length*100);
  };
  const chDone=id=>{
    if(!activeReport)return false;
    const r=activeReport;
    return!!{0:r.patientName,1:r.ch1,2:r.ch2occ,3:Object.keys(r.ch3prompts||{}).length>0,4:(r.ch4injuries||[]).length>0,5:r.ch5,6:r.ch6general,7:r.ch7,8:r.ch8ortho,9:r.ch9occ,10:r.ch10}[id];
  };

  const filtered=reports.filter(r=>{
    if(!query)return true;
    const q=query.toLowerCase();
    return(r.patientName||"").toLowerCase().includes(q)||(r.ourRef||"").toLowerCase().includes(q);
  });

  const initials=(session?.user?.email||"??").slice(0,2).toUpperCase();
  const props={r:activeReport,setR:updateReport,apiKey};
  const chapters=[<Ch0 {...props}/>,<Ch1 {...props}/>,<Ch2 {...props}/>,<Ch3 {...props}/>,<Ch4 {...props}/>,<Ch5 {...props}/>,<Ch6 {...props}/>,<Ch7 {...props}/>,<Ch8 {...props}/>,<Ch9 {...props}/>,<Ch10 {...props}/>];

  // â”€â”€ LOADING â”€â”€
  if(session===undefined)return(
    <div className="loading-full">
      <div className="spin"/>
      <div style={{fontSize:13,color:"var(--t3)",letterSpacing:".5px"}}>Loading MediSync Ortho...</div>
    </div>
  );
  if(!session)return<LoginScreen/>;

  // â”€â”€ PREVIEW â”€â”€
  if(view==="preview"&&activeReport)return(
    <div className="app">
      <Preview r={activeReport} onBack={()=>setView("editor")}/>
      {toast&&<div className="toast">{toast}</div>}
    </div>
  );

  // â”€â”€ TOPBAR (shared) â”€â”€
  const Topbar=({inEditor})=>(
    <header className="topbar">
      {inEditor&&<button className="hamburger" onClick={()=>setSbOpen(p=>!p)}><span/><span/><span/></button>}
      <div className="t-logo">
        <div className="t-logo-mark">ğŸ”¬</div>
        <div><div className="t-logo-text">MediSync <em>Ortho</em></div><div className="t-logo-sub">Medico-Legal</div></div>
      </div>
      {inEditor&&<div className="t-sep"/>}
      <div className="t-space"/>
      {inEditor&&(
        <div className={`status-pill ${saveState}`}>
          <div className={`status-dot${saveState==="saving"?" blink":""}`}/>
          {saveState==="saving"?"Savingâ€¦":saveState==="error"?"Save error":"Saved"}
        </div>
      )}
      {inEditor&&<button className="tb-btn tb-ghost" onClick={()=>{setView("list");setActiveId(null);}}>â† Reports</button>}
      {inEditor&&<button className="tb-btn tb-primary" onClick={()=>setView("preview")}>ğŸ‘ Preview</button>}
      {!inEditor&&<button className="tb-btn tb-primary" onClick={createReport}>+ New Report</button>}
      <button className="tb-icon" onClick={()=>setShowAccount(true)} title="Account & Settings" style={{background:"linear-gradient(135deg,rgba(157,126,255,.15),rgba(0,229,216,.1))",border:"1px solid rgba(157,126,255,.25)"}}>
        <span style={{fontFamily:"'Syne',sans-serif",fontSize:11,fontWeight:800,color:"var(--t1)"}}>{initials}</span>
      </button>
    </header>
  );

  // â”€â”€ LIST VIEW â”€â”€
  if(view==="list")return(
    <div className="app">
      <Topbar/>
      <div className="list-page">
        <div className="list-head">
          <div className="list-head-title">Your <em>Reports</em></div>
          <div className="list-head-sub">{reports.length} report{reports.length!==1?"s":""} Â· all saved to the cloud</div>
        </div>
        {reports.length>0&&(
          <div className="search-row">
            <span className="search-ico">ğŸ”</span>
            <input className="searchbox" placeholder="Search by patient name or reference..." value={query} onChange={e=>setQuery(e.target.value)}/>
          </div>
        )}
        <div className="rpt-list">
          {loadingRpts&&<div style={{textAlign:"center",padding:60}}><div className="spin" style={{width:32,height:32,borderWidth:3}}/><div style={{marginTop:16,color:"var(--t3)",fontSize:13}}>Loading reports...</div></div>}
          {!loadingRpts&&filtered.length===0&&reports.length===0&&(
            <div className="empty">
              <div className="empty-ico">ğŸ“‹</div>
              <div className="empty-t">No Reports Yet</div>
              <div className="empty-s">Create your first medico-legal orthopaedic report. Everything saves automatically to the cloud.</div>
              <button className="btn btn-p btn-lg" onClick={createReport}>+ Create First Report</button>
            </div>
          )}
          {!loadingRpts&&filtered.length===0&&reports.length>0&&(
            <div className="empty"><div className="empty-ico">ğŸ”</div><div className="empty-t">No Results</div><div className="empty-s">No reports match your search.</div></div>
          )}
          {!loadingRpts&&filtered.map(rpt=>{
            const rid=rpt._id||rpt._lid;
            const prog=calcProg(rpt);
            return(
              <div key={rid} className="rpt-card" onClick={()=>openReport(rpt)}>
                <div className="rpt-ico">ğŸ“„</div>
                <div className="rpt-info">
                  <div className="rpt-name">{rpt.patientName||"Untitled Report"}</div>
                  <div className="rpt-meta">
                    {rpt.ourRef&&<span style={{marginRight:12}}>Ref: {rpt.ourRef}</span>}
                    {rpt.doi&&<span style={{marginRight:12}}>DOI: {rpt.doi}</span>}
                    <span>Updated: {new Date(rpt._ts||rpt.updated||rpt.created).toLocaleDateString("en-ZA")}</span>
                  </div>
                  <div className="rpt-prog">
                    <div className="rpt-track"><div className="rpt-fill" style={{width:`${prog}%`}}/></div>
                    <div className="rpt-pct">{prog}%</div>
                  </div>
                </div>
                <button className="btn btn-d btn-sm" onClick={e=>{e.stopPropagation();deleteReport(rid);}}>ğŸ—‘</button>
              </div>
            );
          })}
        </div>
      </div>
      {showAccount&&<AccountModal session={session} reports={reports} apiKey={apiKey} onSaveKey={saveApiKey} onClose={()=>setShowAccount(false)} onSignOut={signOut}/>}
      {toast&&<div className="toast">{toast}</div>}
    </div>
  );

  // â”€â”€ EDITOR â”€â”€
  return(
    <div className="app">
      <Topbar inEditor/>
      <div className="body-wrap">
        {/* SIDEBAR */}
        <nav className={`sidebar${sbOpen?"":" closed"}`}>
          <div className="sb-rpt">
            <div className="sb-rpt-name">{activeReport?.patientName||"New Report"}</div>
            <div className="sb-rpt-meta">{activeReport?.ourRef||"No reference set"}</div>
            {activeReport&&<div className="sb-prog">
              <div className="sb-prog-track"><div className="sb-prog-fill" style={{width:`${calcProg(activeReport)}%`}}/></div>
              <div className="sb-prog-pct">{calcProg(activeReport)}% COMPLETE</div>
            </div>}
          </div>
          <div className="sb-nav">
            <div className="sb-nav-label">Chapters</div>
            {CHAPTERS.map(ch=>(
              <button key={ch.id} className={`nav-item${chapter===ch.id?" active":""}`} onClick={()=>setChapter(ch.id)}>
                <span className="nav-num">{ch.id}</span>
                <span style={{flex:1}}>{ch.short}</span>
                {chDone(ch.id)&&<span className="nav-tick">âœ“</span>}
              </button>
            ))}
          </div>
          {/* ACCOUNT PANEL */}
          <div className="sb-account">
            {accOpen&&(
              <div className="acc-dropdown">
                <button className="acc-item" onClick={()=>{setShowAccount(true);setAccOpen(false);}}>
                  <div className="acc-item-ico">ğŸ‘¤</div> My Account
                </button>
                <button className="acc-item" onClick={()=>{setShowAccount(true);setAccOpen(false);}}>
                  <div className="acc-item-ico">âœ¨</div> {apiKey?"AI Key Active":"Set AI Key"}
                </button>
                <button className="acc-item" onClick={()=>{setShowAccount(true);setAccOpen(false);}}>
                  <div className="acc-item-ico">ğŸ”</div> Change Password
                </button>
                <button className="acc-item red" onClick={signOut}>
                  <div className="acc-item-ico">â»</div> Sign Out
                </button>
              </div>
            )}
            <button className="sb-acc-btn" onClick={()=>setAccOpen(p=>!p)}>
              <div className="acc-avatar">{initials}</div>
              <div className="acc-info">
                <div className="acc-email">{session?.user?.email}</div>
                <div className="acc-role">Orthopaedic Surgeon</div>
              </div>
              <div className={`acc-chevron${accOpen?" open":""}`}>â–²</div>
            </button>
          </div>
        </nav>

        {/* MAIN */}
        <main className="main">
          <div className="ch-bar">
            <div className="ch-left">
              <div className="ch-badge">{CHAPTERS[chapter].icon}</div>
              <div>
                <div className="ch-title">{CHAPTERS[chapter].title}</div>
                <div className="ch-sub">Chapter {chapter} of 10</div>
              </div>
            </div>
            <div className="ch-nav">
              {chapter>0&&<button className="btn btn-s btn-sm" onClick={()=>setChapter(p=>p-1)}>â† Prev</button>}
              {chapter<10&&<button className="btn btn-p btn-sm" onClick={()=>setChapter(p=>p+1)}>Next â†’</button>}
            </div>
          </div>
          <div className="content">
            {activeReport?chapters[chapter]:(
              <div className="empty">
                <div className="empty-ico">ğŸ“‹</div>
                <div className="empty-t">No Report Open</div>
                <button className="btn btn-p" onClick={()=>setView("list")}>â† All Reports</button>
              </div>
            )}
          </div>
        </main>
      </div>

      {showAccount&&<AccountModal session={session} reports={reports} apiKey={apiKey} onSaveKey={saveApiKey} onClose={()=>setShowAccount(false)} onSignOut={signOut}/>}
      {toast&&<div className="toast">{toast}</div>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>

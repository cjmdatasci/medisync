<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MediSync Ortho ‚Äî MedLegal Engine</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#09090f;--s1:#0f1018;--s2:#14161e;--bd:#1c1f2a;
  --ac:#00e8b4;--bl:#3d7eff;--gd:#f0a030;--rd:#ff4455;--pu:#a855f7;
  --tx:#d8e0f0;--mt:#3e4460;--sm:#7880a0;
}
html,body,#root{height:100%;background:var(--bg);color:var(--tx);}
body{font-family:'IBM Plex Mono',monospace;font-size:12px;overflow:hidden;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px;}
button,input,select,textarea{font-family:'IBM Plex Mono',monospace;}
textarea{resize:vertical;}

/* APP LAYOUT */
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}

/* HEADER */
.hdr{display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:48px;background:var(--s1);border-bottom:1px solid var(--bd);
  flex-shrink:0;z-index:60;}
.hdr-l{display:flex;align-items:center;gap:10px;}
.hdr-icon{width:30px;height:30px;background:var(--bl);border-radius:7px;
  display:flex;align-items:center;justify-content:center;font-size:16px;}
.hdr-name{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--tx);}
.hdr-name span{color:var(--ac);}
.hdr-sub{font-size:8px;color:var(--sm);letter-spacing:1px;margin-top:1px;}
.hdr-r{display:flex;gap:6px;align-items:center;}

/* STATUS DOT */
.sdot{width:6px;height:6px;border-radius:50%;background:var(--ac);display:inline-block;}
.sdot.pulse{animation:sdpulse .9s infinite;}
@keyframes sdpulse{0%,100%{background:var(--gd);opacity:1;}50%{opacity:.3;}}

/* BODY */
.body-wrap{display:flex;flex:1;overflow:hidden;}

/* SIDEBAR */
.sb{width:220px;min-width:220px;background:var(--s1);border-right:1px solid var(--bd);
  display:flex;flex-direction:column;transition:width .2s,min-width .2s;overflow:hidden;}
.sb.closed{width:0;min-width:0;}
.sb-head{padding:12px 14px;border-bottom:1px solid var(--bd);white-space:nowrap;}
.sb-lbl{font-size:8px;letter-spacing:3px;color:var(--ac);font-weight:700;}
.sb-list{flex:1;overflow-y:auto;padding:6px;}

/* NAV BUTTON */
.nb{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:5px;
  font-size:8.5px;font-weight:700;letter-spacing:.8px;color:var(--mt);
  border:1px solid transparent;background:none;width:100%;text-align:left;
  white-space:nowrap;cursor:pointer;transition:all .1s;margin-bottom:1px;}
.nb:hover{color:var(--tx);background:var(--s2);}
.nb.on{color:var(--ac);border-color:rgba(0,232,180,.25);background:rgba(0,232,180,.05);}
.nb-num{font-size:8px;color:var(--sm);min-width:16px;}
.nb-dot{width:5px;height:5px;border-radius:50%;background:var(--ac);margin-left:auto;}

/* MAIN CONTENT */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.content{flex:1;overflow-y:auto;padding:20px 24px;}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:16px;margin-bottom:14px;}
.card-title{font-size:9px;letter-spacing:2px;color:var(--ac);font-weight:700;margin-bottom:12px;}

/* FORM ELEMENTS */
.fld{margin-bottom:12px;}
.fld label{display:block;font-size:9px;letter-spacing:1px;color:var(--sm);margin-bottom:4px;}
.fld input,.fld select,.fld textarea{
  width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  color:var(--tx);padding:8px 10px;font-size:11px;outline:none;transition:border .15s;}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:var(--ac);}
.fld select option{background:var(--s2);}
.fld textarea{min-height:80px;line-height:1.5;}
.fld-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.fld-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

/* BUTTONS */
.btn{border:none;border-radius:5px;padding:7px 13px;font-size:9px;letter-spacing:1px;
  font-weight:700;cursor:pointer;transition:all .12s;display:inline-flex;align-items:center;gap:5px;}
.btn-ac{background:var(--ac);color:#000;}
.btn-ac:hover{background:#00c99a;}
.btn-bl{background:var(--bl);color:#fff;}
.btn-bl:hover{background:#2d6aef;}
.btn-gd{background:var(--gd);color:#000;}
.btn-gd:hover{background:#d08a20;}
.btn-rd{background:var(--rd);color:#fff;}
.btn-rd:hover{background:#e03344;}
.btn-ghost{background:transparent;border:1px solid var(--bd);color:var(--sm);}
.btn-ghost:hover{border-color:var(--ac);color:var(--tx);}
.btn-sm{padding:4px 9px;font-size:8px;}

/* VOICE BUTTON */
.mic-btn{border-radius:50%;width:36px;height:36px;display:flex;align-items:center;
  justify-content:center;cursor:pointer;border:none;transition:all .12s;flex-shrink:0;}
.mic-btn.idle{background:var(--s2);color:var(--sm);}
.mic-btn.idle:hover{background:var(--bd);color:var(--tx);}
.mic-btn.recording{background:var(--rd);color:#fff;animation:mrecord 1s infinite;}
@keyframes mrecord{0%,100%{box-shadow:0 0 0 0 rgba(255,68,85,.4);}50%{box-shadow:0 0 0 8px rgba(255,68,85,0);}}

/* TEXTAREA WITH MIC */
.ta-wrap{display:flex;gap:8px;align-items:flex-start;}
.ta-wrap textarea{flex:1;}
.ta-actions{display:flex;flex-direction:column;gap:6px;}

/* AI BUTTON */
.ai-btn{border-radius:5px;padding:6px 8px;font-size:8px;letter-spacing:.5px;font-weight:700;
  cursor:pointer;border:none;background:rgba(168,85,247,.15);color:var(--pu);
  border:1px solid rgba(168,85,247,.3);transition:all .12s;white-space:nowrap;}
.ai-btn:hover{background:rgba(168,85,247,.25);}
.ai-btn:disabled{opacity:.4;cursor:wait;}

/* CHAPTER HEADER */
.ch-hdr{padding:14px 24px;border-bottom:1px solid var(--bd);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;background:var(--s1);}
.ch-title{font-size:13px;font-weight:700;letter-spacing:1px;color:var(--tx);}
.ch-sub{font-size:8px;color:var(--sm);margin-top:2px;letter-spacing:.5px;}

/* TAG */
.tag{display:inline-flex;align-items:center;padding:2px 7px;border-radius:3px;
  font-size:8px;font-weight:700;letter-spacing:.5px;}
.tag-ac{background:rgba(0,232,180,.12);color:var(--ac);}
.tag-gd{background:rgba(240,160,48,.12);color:var(--gd);}
.tag-rd{background:rgba(255,68,85,.12);color:var(--rd);}
.tag-bl{background:rgba(61,126,255,.12);color:var(--bl);}

/* ADL TABLE */
.adl-tbl{width:100%;border-collapse:collapse;font-size:10px;margin-bottom:16px;}
.adl-tbl th{background:var(--s2);color:var(--sm);padding:6px 8px;font-size:8px;letter-spacing:1px;
  border:1px solid var(--bd);text-align:left;}
.adl-tbl td{padding:5px 8px;border:1px solid var(--bd);vertical-align:middle;}
.adl-tbl tr:hover td{background:var(--s2);}
.adl-radio{display:flex;gap:10px;justify-content:center;}
.adl-radio label{cursor:pointer;display:flex;align-items:center;gap:3px;font-size:9px;color:var(--sm);}
.adl-radio label:hover{color:var(--tx);}
.adl-radio input[type=radio]{accent-color:var(--ac);}

/* ROM TABLE */
.rom-tbl{width:100%;border-collapse:collapse;font-size:11px;}
.rom-tbl th{background:var(--s2);padding:6px 8px;font-size:8px;letter-spacing:1px;color:var(--sm);
  border:1px solid var(--bd);}
.rom-tbl td{padding:4px 6px;border:1px solid var(--bd);}
.rom-tbl input{width:100%;background:transparent;border:none;color:var(--tx);outline:none;font-size:11px;text-align:center;}

/* REPORT LIST */
.rpt-card{background:var(--s2);border:1px solid var(--bd);border-radius:7px;padding:13px 15px;
  margin-bottom:8px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:12px;}
.rpt-card:hover{border-color:var(--ac);background:var(--s1);}
.rpt-card.active{border-color:var(--ac);background:var(--s1);}
.rpt-icon{width:36px;height:36px;border-radius:7px;background:rgba(61,126,255,.15);
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.rpt-meta{flex:1;min-width:0;}
.rpt-name{font-size:11px;font-weight:700;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-date{font-size:8px;color:var(--sm);margin-top:2px;}
.rpt-prog{font-size:8px;color:var(--ac);margin-top:2px;}

/* PROGRESS BAR */
.prog-bar{height:3px;background:var(--bd);border-radius:2px;margin-top:6px;}
.prog-fill{height:100%;background:var(--ac);border-radius:2px;transition:width .3s;}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;
  display:flex;align-items:center;justify-content:center;}
.modal{background:var(--s1);border:1px solid var(--bd);border-radius:10px;
  padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;}
.modal-title{font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:16px;color:var(--ac);}

/* PROMPT LIST */
.prompt-item{background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  padding:10px 12px;margin-bottom:8px;}
.prompt-letter{font-size:9px;color:var(--gd);font-weight:700;margin-bottom:3px;}
.prompt-text{font-size:10px;color:var(--sm);}

/* EXAM REGION */
.region-btn{background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  padding:8px 12px;font-size:9px;font-weight:700;cursor:pointer;color:var(--sm);
  transition:all .12s;text-align:left;width:100%;margin-bottom:4px;}
.region-btn:hover{border-color:var(--bl);color:var(--tx);}
.region-btn.sel{border-color:var(--ac);color:var(--ac);background:rgba(0,232,180,.05);}

/* CHAPTER 4 injuries */
.inj-list{list-style:none;}
.inj-item{display:flex;align-items:center;gap:8px;padding:6px 0;
  border-bottom:1px solid var(--bd);font-size:11px;}
.inj-item:last-child{border-bottom:none;}
.inj-dot{width:6px;height:6px;border-radius:50%;background:var(--gd);flex-shrink:0;}

/* PRINT STYLES */
@media print{
  body{background:#fff;color:#000;font-family:'Times New Roman',serif;font-size:11pt;}
  .no-print{display:none!important;}
  .print-only{display:block!important;}
  .prev-page{box-shadow:none;border:none;}
}
.print-only{display:none;}

/* PREVIEW */
.prev-wrap{flex:1;overflow-y:auto;background:var(--bg);padding:20px;}
.prev-page{background:#fff;color:#222;max-width:760px;margin:0 auto;
  padding:50px 60px;font-family:'Libre Baskerville',serif;font-size:10.5pt;
  line-height:1.6;box-shadow:0 4px 40px rgba(0,0,0,.5);border-radius:4px;}
.prev-page h1{font-size:14pt;font-weight:700;margin-bottom:6px;color:#111;}
.prev-page h2{font-size:11pt;font-weight:700;margin:18px 0 6px;color:#111;
  border-bottom:1px solid #ddd;padding-bottom:4px;}
.prev-page h3{font-size:10pt;font-weight:700;margin:12px 0 4px;}
.prev-page p,.btext{margin-bottom:8px;}
.prev-page table{width:100%;border-collapse:collapse;margin:10px 0;font-size:9.5pt;}
.prev-page table th{background:#f0f0f0;padding:5px 8px;border:1px solid #ccc;font-size:8.5pt;}
.prev-page table td{padding:4px 8px;border:1px solid #ccc;}
.prev-fabs{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:8px;}
.fab{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 2px 12px rgba(0,0,0,.4);transition:transform .12s;}
.fab:hover{transform:scale(1.1);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:var(--s1);border:1px solid var(--ac);border-radius:6px;
  padding:9px 18px;font-size:10px;color:var(--ac);letter-spacing:.5px;
  z-index:999;animation:fadein .2s ease;}
@keyframes fadein{from{opacity:0;transform:translateX(-50%) translateY(8px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

/* EMPTY STATE */
.empty{text-align:center;padding:60px 20px;color:var(--sm);}
.empty-icon{font-size:48px;margin-bottom:16px;}
.empty-title{font-size:14px;font-weight:700;color:var(--tx);margin-bottom:6px;}
.empty-sub{font-size:10px;line-height:1.5;}

/* LOADING SPINNER */
.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,232,180,.3);
  border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* SEARCH */
.search-wrap{padding:10px;border-bottom:1px solid var(--bd);}
.search-inp{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  color:var(--tx);padding:7px 10px;font-size:10px;outline:none;}
.search-inp:focus{border-color:var(--ac);}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const I = {
  mic: "üé§", stop: "‚èπ", ai: "‚ú®", save: "üíæ", new: "‚ûï",
  del: "üóë", back: "‚Üê", prev: "üëÅ", copy: "üìã", dl: "‚¨á",
  print: "üñ®", menu: "‚ò∞", scope: "üî¨", check: "‚úì", x: "‚úï",
  doc: "üìÑ", folder: "üìÅ", warn: "‚ö†", info: "‚Ñπ", arrow: "‚Üí"
};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DB = {
  load(){ try{ return JSON.parse(localStorage.getItem("ms_ortho")||"[]"); }catch{ return []; } },
  save(all){ try{ localStorage.setItem("ms_ortho",JSON.stringify(all)); }catch(e){} }
};

// ‚îÄ‚îÄ CHAPTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHAPTERS = [
  { id:0,  title:"Cover / Demographics",  short:"Demographics" },
  { id:1,  title:"Documents Perused",     short:"Documents" },
  { id:2,  title:"Occupational & Medical History", short:"History" },
  { id:3,  title:"Summary of Hospital Records", short:"Hospital Records" },
  { id:4,  title:"Injuries Sustained",    short:"Injuries" },
  { id:5,  title:"Current Complaints",    short:"Complaints" },
  { id:6,  title:"Clinical Evaluation",   short:"Clinical Eval" },
  { id:7,  title:"Diagnosis",             short:"Diagnosis" },
  { id:8,  title:"Further Management",    short:"Management" },
  { id:9,  title:"Disability & Impairment", short:"Disability" },
  { id:10, title:"Discussion",            short:"Discussion" },
];

// ‚îÄ‚îÄ CHAPTER 3 PROMPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CH3_PROMPTS = [
  { letter:"a", text:"Mechanism of accident and date of accident." },
  { letter:"b", text:"EMS assessment on scene ‚Äî presentation, complaints, exam findings, GCS, suspected diagnosis." },
  { letter:"c", text:"Transfer to hospital ‚Äî name of hospital and mode of transport (ambulance, helicopter, etc.)." },
  { letter:"d", text:"Date of presentation to hospital and department." },
  { letter:"e", text:"Complaints and findings on initial assessment." },
  { letter:"f", text:"Immediate investigations / treatment rendered." },
  { letter:"g", text:"Diagnosis." },
  { letter:"h", text:"Admission, transfer to relevant department, and formal diagnosis." },
  { letter:"i", text:"Definitive management and treatment prescribed, including dates." },
  { letter:"j", text:"Post-operative treatment and rehabilitation." },
  { letter:"k", text:"Discharge and assistive devices / step-down treatment." },
  { letter:"l", text:"Follow-up and review." },
];

// ‚îÄ‚îÄ EXAM REGIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EXAM_REGIONS = {
  "Cervical Spine":   ["Inspection","Palpation","Range of Motion (Flexion/Extension/Rotation/Lateral Flexion)","Power (myotomes C5-T1)","Sensation (dermatomes)","Reflexes (biceps C5, triceps C7, brachioradialis C6)","Spurling's Test","Lhermitte's Sign"],
  "Shoulder":         ["Inspection","Palpation","Range of Motion (Flexion/Abduction/External Rotation/Internal Rotation)","Power","Sensation","Reflexes","Neer's Test","Hawkins-Kennedy Test","Job's Test (empty can)","Apprehension Test","O'Brien's Test"],
  "Elbow":            ["Inspection","Palpation","Range of Motion (Flexion/Extension/Pronation/Supination)","Power","Sensation","Reflexes (biceps, triceps, brachioradialis)","Valgus/Varus Stress Test","Tinel's Sign at Cubital Tunnel"],
  "Wrist & Hand":     ["Inspection","Palpation","Range of Motion (Flexion/Extension/Radial-Ulnar Deviation)","Power (grip strength)","Sensation","Reflexes","Tinel's at Carpal Tunnel","Phalen's Test","Finkelstein's Test"],
  "Lumbar Spine":     ["Inspection","Palpation","Range of Motion (Flexion/Extension/Lateral Flexion/Rotation)","Power (myotomes L1-S1)","Sensation (dermatomes)","Reflexes (knee L4, ankle S1)","Straight Leg Raise (SLR)","Crossed SLR","Femoral Nerve Stretch"],
  "Hip":              ["Inspection","Palpation","Range of Motion (Flexion/Extension/Abduction/Adduction/Internal/External Rotation)","Power","Sensation","FABER Test","FADIR Test","Thomas Test","Trendelenburg Test"],
  "Knee":             ["Inspection","Palpation","Range of Motion (Flexion/Extension)","Power (quadriceps/hamstrings)","Sensation","Reflexes (patellar)","Lachman's Test","Anterior/Posterior Drawer","McMurray's Test","Valgus/Varus Stress"],
  "Ankle & Foot":     ["Inspection","Palpation","Range of Motion (Dorsiflexion/Plantar Flexion/Inversion/Eversion)","Power (big toe, ankle)","Sensation","Reflexes (Achilles)","Anterior Drawer Test","Talar Tilt Test","Thompson's Test"],
};

// ‚îÄ‚îÄ ADL ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ADL_BASIC = ["Bowel control","Bladder control","Grooming","Toileting","Feeding","Transfer (chair to bed)","Indoor mobility","Dressing","Stairs","Bathing"];
const ADL_ADV   = ["Driving a car","Sexual function","Medical self-care","Money management","Writing & communication","Travelling","Shopping","Cooking","Housework","Moderate activities (pushing/lifting)","Vigorous activities (sport/heavy lifting)"];
const ADL_OPTS_B = ["No Effect","Mild","Moderate","Severe"];
const ADL_OPTS_A = ["N/A","No Effect","Mild","Moderate","Severe"];

// ‚îÄ‚îÄ NEW REPORT TEMPLATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function newReport(){
  return {
    id: Date.now(),
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
    // Demographics
    drName:"", quals:"", ourRef:"", attRef:"",
    patientName:"", refNum:"", gender:"", dob:"", age:"", address:"", contact:"",
    doi:"", mechanism:"", preOccupation:"", postOccupation:"",
    dateExam:"", placeExam:"RG Medlegal Rooms, Kings Court Centre, Walmer Heights, Gqeberha, 6070",
    attorney:"", attContact:"",
    // Chapter content (keyed by chapter id)
    ch1:"", ch2occ:"", ch2pmsx:"", ch3:"", ch3prompts:{},
    ch4injuries:[], ch5:"", ch6general:"", ch6msk:{},
    ch7:"", ch8ortho:"", ch8ref:"", ch10:"",
    // ADL
    adlBasic:{}, adlAdv:{},
    // Occupational effects
    ch9occ:"",
    // WPI table
    wpiRows:[{ region:"", impairment:"", reference:"", wpi:"" }],
    // Exam regions selected
    examRegions:{},
  };
}

// ‚îÄ‚îÄ VOICE HOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function useVoice(){
  const [active, setActive] = useState(false);
  const [supported] = useState(() => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window);
  const recRef = useRef(null);
  const cbRef  = useRef(null);

  const start = useCallback((onResult) => {
    if (!supported) { alert("Voice recognition not supported in this browser."); return; }
    cbRef.current = onResult;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const r = new SR();
    r.lang = "en-ZA"; r.continuous = true; r.interimResults = false;
    r.onresult = e => {
      const t = Array.from(e.results).map(r=>r[0].transcript).join(" ");
      if (cbRef.current) cbRef.current(t);
    };
    r.onerror = () => setActive(false);
    r.onend = () => setActive(false);
    r.start();
    recRef.current = r;
    setActive(true);
  }, [supported]);

  const stop = useCallback(() => {
    if (recRef.current) { recRef.current.stop(); recRef.current = null; }
    setActive(false);
  }, []);

  return { active, supported, start, stop };
}

// ‚îÄ‚îÄ AI HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function aiProcess(text, instruction, apiKey){
  if (!apiKey) return text;
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "x-api-key":apiKey, "anthropic-version":"2023-06-01", "anthropic-dangerous-direct-browser-access":"true" },
      body: JSON.stringify({
        model:"claude-haiku-4-5-20251001",
        max_tokens:2000,
        messages:[{ role:"user", content:`${instruction}\n\nText:\n${text}` }]
      })
    });
    const d = await res.json();
    return d?.content?.[0]?.text || text;
  } catch(e){ return text; }
}

// ‚îÄ‚îÄ TEXTAREA WITH MIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TA({ value, onChange, placeholder, rows=4, label, apiKey, aiHint }){
  const voice = useVoice();
  const [loading, setLoading] = useState(false);
  const idRef = useRef(value);
  useEffect(()=>{ idRef.current = value; }, [value]);

  const toggleMic = () => {
    if (voice.active) { voice.stop(); return; }
    voice.start((transcript) => {
      onChange((idRef.current ? idRef.current + " " : "") + transcript);
    });
  };

  const runAI = async () => {
    if (!value.trim() || !apiKey) return;
    setLoading(true);
    const result = await aiProcess(value, aiHint || "Correct grammar, spelling and formatting for a South African medical report. Return only the corrected text.");
    onChange(result);
    setLoading(false);
  };

  return (
    <div className="fld">
      {label && <label>{label}</label>}
      <div className="ta-wrap">
        <textarea rows={rows} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>
        <div className="ta-actions">
          <button className={`mic-btn ${voice.active?"recording":"idle"}`} onClick={toggleMic} title={voice.active?"Stop recording":"Start recording"}>
            {voice.active ? "‚èπ" : "üé§"}
          </button>
          {apiKey && (
            <button className="ai-btn" onClick={runAI} disabled={loading} title="AI: Grammar & formatting">
              {loading ? <span className="spin"/> : "‚ú®"}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ CHAPTER COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// CH 0: Demographics
function Ch0({ r, setR }){
  const f = (k) => e => setR(p => ({ ...p, [k]: e.target.value }));
  return (
    <>
      <div className="card">
        <div className="card-title">PRACTICE DETAILS</div>
        <div className="fld-row">
          <div className="fld"><label>DOCTOR NAME</label><input value={r.drName} onChange={f("drName")} placeholder="Dr Sayed M Mia"/></div>
          <div className="fld"><label>QUALIFICATIONS</label><input value={r.quals} onChange={f("quals")} placeholder="FC Ortho (SA)"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>OUR REFERENCE</label><input value={r.ourRef} onChange={f("ourRef")} placeholder="RGML/SMM/szb/26453"/></div>
          <div className="fld"><label>ATTORNEY REFERENCE</label><input value={r.attRef} onChange={f("attRef")} placeholder="TIMOTHY/MS_BURO"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>INSTRUCTING ATTORNEY</label><input value={r.attorney} onChange={f("attorney")} placeholder="David Rossouw Attorneys"/></div>
          <div className="fld"><label>ATTORNEY CONTACT</label><input value={r.attContact} onChange={f("attContact")} placeholder="041 030 0107"/></div>
        </div>
      </div>
      <div className="card">
        <div className="card-title">PATIENT DETAILS</div>
        <div className="fld"><label>FULL NAME</label><input value={r.patientName} onChange={f("patientName")} placeholder="MOHAMUD SAID BURO"/></div>
        <div className="fld-row">
          <div className="fld"><label>ID / REF NUMBER</label><input value={r.refNum} onChange={f("refNum")} placeholder="ECZSOM01030209"/></div>
          <div className="fld"><label>GENDER</label>
            <select value={r.gender} onChange={f("gender")}>
              <option value="">Select...</option>
              <option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>DATE OF BIRTH</label><input type="date" value={r.dob} onChange={f("dob")}/></div>
          <div className="fld"><label>CURRENT AGE</label><input value={r.age} onChange={f("age")} placeholder="47"/></div>
        </div>
        <div className="fld"><label>RESIDENTIAL ADDRESS</label><input value={r.address} onChange={f("address")} placeholder="182 Durban Road, Korsten, Gqeberha, 6001"/></div>
        <div className="fld"><label>CONTACT NUMBER</label><input value={r.contact} onChange={f("contact")} placeholder="069 899 3104"/></div>
      </div>
      <div className="card">
        <div className="card-title">ACCIDENT & EXAMINATION</div>
        <div className="fld-row">
          <div className="fld"><label>DATE OF INJURY</label><input type="date" value={r.doi} onChange={f("doi")}/></div>
          <div className="fld"><label>MECHANISM</label><input value={r.mechanism} onChange={f("mechanism")} placeholder="Motor Vehicle Accident"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>PRE-ACCIDENT OCCUPATION</label><input value={r.preOccupation} onChange={f("preOccupation")}/></div>
          <div className="fld"><label>POST-ACCIDENT OCCUPATION</label><input value={r.postOccupation} onChange={f("postOccupation")}/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>DATE OF EXAMINATION</label><input type="date" value={r.dateExam} onChange={f("dateExam")}/></div>
          <div className="fld"><label>PLACE OF EXAMINATION</label><input value={r.placeExam} onChange={f("placeExam")}/></div>
        </div>
      </div>
    </>
  );
}

// CH 1: Documents Perused
function Ch1({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">DOCUMENTS PERUSED</div>
      <p style={{fontSize:10,color:"var(--sm)",marginBottom:10}}>List documents in order (one per line or dictate).</p>
      <TA value={r.ch1} onChange={v=>setR(p=>({...p,ch1:v}))}
        rows={8} apiKey={apiKey}
        placeholder={"1. Instruction Letter\n2. Refugee Status of Client\n3. Accident Report\n4. Ambulance Voucher\n5. Hospital Records\n6. Patient Questionnaire"}/>
    </div>
  );
}

// CH 2: History
function Ch2({ r, setR, apiKey }){
  const fOcc = (k) => e => setR(p=>({...p,[k]:e.target.value}));
  return (
    <>
      <div className="card">
        <div className="card-title">2.1 OCCUPATIONAL HISTORY</div>
        <div className="fld-row">
          <div className="fld"><label>HIGHEST GRADE PASSED</label><input value={r.ch2grade||""} onChange={fOcc("ch2grade")} placeholder="Grade 7"/></div>
          <div className="fld"><label>TERTIARY EDUCATION</label><input value={r.ch2tertiary||""} onChange={fOcc("ch2tertiary")} placeholder="None"/></div>
        </div>
        <TA label="PRE-ACCIDENT OCCUPATION (detail)" value={r.ch2occ} onChange={v=>setR(p=>({...p,ch2occ:v}))}
          rows={4} apiKey={apiKey}
          placeholder="At the time of the accident, the patient was employed as..."/>
        <TA label="POST-ACCIDENT OCCUPATION (detail)" value={r.ch2postOcc||""} onChange={v=>setR(p=>({...p,ch2postOcc:v}))}
          rows={3} apiKey={apiKey}
          placeholder="Following the accident, the patient..."/>
      </div>
      <div className="card">
        <div className="card-title">2.2 PAST MEDICAL & SURGICAL HISTORY</div>
        <div className="fld-row">
          <div className="fld"><label>PREVIOUS INJURIES</label><input value={r.ch2injuries||""} onChange={fOcc("ch2injuries")} placeholder="None reported"/></div>
          <div className="fld"><label>SURGICAL HISTORY</label><input value={r.ch2surgery||""} onChange={fOcc("ch2surgery")} placeholder="None reported"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>MEDICAL HISTORY</label><input value={r.ch2medical||""} onChange={fOcc("ch2medical")} placeholder="None reported"/></div>
          <div className="fld"><label>CHRONIC MEDICATION</label><input value={r.ch2meds||""} onChange={fOcc("ch2meds")} placeholder="None reported"/></div>
        </div>
        <TA label="ADDITIONAL NOTES" value={r.ch2pmsx} onChange={v=>setR(p=>({...p,ch2pmsx:v}))}
          rows={3} apiKey={apiKey} placeholder="Additional medical history details..."/>
      </div>
    </>
  );
}

// CH 3: Hospital Records
function Ch3({ r, setR, apiKey }){
  const updatePrompt = (letter, val) => {
    setR(p=>({...p, ch3prompts:{...p.ch3prompts, [letter]:val}}));
  };
  return (
    <>
      <div className="card">
        <div className="card-title">GUIDED HOSPITAL RECORD PROMPTS</div>
        <p style={{fontSize:10,color:"var(--sm)",marginBottom:12}}>
          Dictate or type each section following the prompts below. Use the mic button for voice input.
        </p>
        {CH3_PROMPTS.map(p=>(
          <div key={p.letter} style={{marginBottom:14}}>
            <div className="prompt-letter">{p.letter.toUpperCase()}.</div>
            <div className="prompt-text" style={{marginBottom:6,fontSize:10,color:"var(--sm)"}}>{p.text}</div>
            <TA value={r.ch3prompts?.[p.letter]||""}
              onChange={v=>updatePrompt(p.letter,v)}
              rows={3} apiKey={apiKey}
              placeholder={`Dictate section (${p.letter})...`}/>
          </div>
        ))}
      </div>
      <div className="card">
        <div className="card-title">3.2 POST-TRAUMA FOLLOW-UP</div>
        <TA value={r.ch3||""} onChange={v=>setR(p=>({...p,ch3:v}))}
          rows={5} apiKey={apiKey}
          placeholder="The patient attended multiple follow-up appointments for..."/>
      </div>
    </>
  );
}

// CH 4: Injuries Sustained
function Ch4({ r, setR }){
  const [newInj, setNewInj] = useState("");
  const addInj = () => {
    if (!newInj.trim()) return;
    setR(p=>({...p, ch4injuries:[...(p.ch4injuries||[]), newInj.trim()]}));
    setNewInj("");
  };
  const removeInj = (i) => {
    setR(p=>({...p, ch4injuries:p.ch4injuries.filter((_,idx)=>idx!==i)}));
  };
  return (
    <div className="card">
      <div className="card-title">INJURIES SUSTAINED</div>
      <p style={{fontSize:10,color:"var(--sm)",marginBottom:10}}>These are extracted from the hospital records and listed in point form.</p>
      <ul className="inj-list" style={{marginBottom:14}}>
        {(r.ch4injuries||[]).map((inj,i)=>(
          <li key={i} className="inj-item">
            <span className="inj-dot"/>
            <span style={{flex:1,fontSize:11}}>{inj}</span>
            <button className="btn btn-ghost btn-sm" onClick={()=>removeInj(i)}>‚úï</button>
          </li>
        ))}
        {!(r.ch4injuries||[]).length && (
          <li style={{color:"var(--sm)",fontSize:10,padding:"8px 0"}}>No injuries added yet. Type below and press Add.</li>
        )}
      </ul>
      <div style={{display:"flex",gap:8}}>
        <input style={{flex:1,background:"var(--s2)",border:"1px solid var(--bd)",borderRadius:5,color:"var(--tx)",padding:"7px 10px",fontSize:11,outline:"none"}}
          value={newInj} onChange={e=>setNewInj(e.target.value)}
          onKeyDown={e=>e.key==="Enter"&&addInj()}
          placeholder="e.g. Right foot fractures of distal metatarsal bones"/>
        <button className="btn btn-ac" onClick={addInj}>Add</button>
      </div>
    </div>
  );
}

// CH 5: Current Complaints
function Ch5({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">CURRENT COMPLAINTS</div>
      <TA value={r.ch5} onChange={v=>setR(p=>({...p,ch5:v}))}
        rows={10} apiKey={apiKey}
        placeholder="Pre-accident symptoms: The patient reports no history of injury...\n\nCurrent complaints: According to the patient he experiences..."
        aiHint="Format this as a South African medico-legal report section for Current Complaints. Improve grammar and professional medical language. Return only the formatted text."/>
    </div>
  );
}

// CH 6: Clinical Evaluation
function Ch6({ r, setR, apiKey }){
  const [selRegion, setSelRegion] = useState(null);
  const updateMsk = (region, field, val) => {
    setR(p=>({...p, ch6msk:{...p.ch6msk, [region]:{...(p.ch6msk?.[region]||{}), [field]:val}}}));
  };
  const addRegion = (rg) => {
    setR(p=>({...p, examRegions:{...p.examRegions, [rg]:true}}));
    setSelRegion(rg);
  };
  const removeRegion = (rg) => {
    const nr={...r.examRegions}; delete nr[rg];
    setR(p=>({...p, examRegions:nr}));
    if (selRegion===rg) setSelRegion(null);
  };
  const activeRegions = Object.keys(r.examRegions||{}).filter(k=>r.examRegions[k]);

  return (
    <>
      <div className="card">
        <div className="card-title">6.1 GENERAL EXAMINATION</div>
        <TA value={r.ch6general||""} onChange={v=>setR(p=>({...p,ch6general:v}))}
          rows={5} apiKey={apiKey}
          placeholder={"Gait: ...\nGeneral impression: Well-kempt.\nAssistive devices: None.\nHome language: ...\nDexterity: Right-handed."}/>
      </div>
      <div className="card">
        <div className="card-title">6.2 MUSCULOSKELETAL EXAMINATION</div>
        <div style={{display:"flex",gap:12,marginBottom:14}}>
          <div style={{flex:"0 0 180px"}}>
            <div style={{fontSize:8,color:"var(--sm)",letterSpacing:"1px",marginBottom:6}}>SELECT REGION</div>
            {Object.keys(EXAM_REGIONS).map(rg=>(
              <button key={rg} className={`region-btn${activeRegions.includes(rg)?" sel":""}`}
                onClick={()=>activeRegions.includes(rg)?setSelRegion(rg):addRegion(rg)}>
                {rg}
              </button>
            ))}
          </div>
          <div style={{flex:1,minWidth:0}}>
            {selRegion ? (
              <>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
                  <div style={{fontSize:11,fontWeight:700,color:"var(--ac)"}}>{selRegion}</div>
                  <button className="btn btn-ghost btn-sm" onClick={()=>removeRegion(selRegion)}>Remove Region</button>
                </div>
                {EXAM_REGIONS[selRegion].map(field=>(
                  <TA key={field} label={field.toUpperCase()}
                    value={r.ch6msk?.[selRegion]?.[field]||""}
                    onChange={v=>updateMsk(selRegion,field,v)}
                    rows={2} apiKey={apiKey}/>
                ))}
              </>
            ) : (
              <div className="empty" style={{padding:"30px 20px"}}>
                <div style={{fontSize:24,marginBottom:8}}>ü¶¥</div>
                <div style={{fontSize:10,color:"var(--sm)"}}>Select a region from the left to begin examination prompts.</div>
              </div>
            )}
          </div>
        </div>
      </div>
      <div className="card">
        <div className="card-title">6.3 EVIDENCE OF INJURY & SPECIAL INVESTIGATIONS</div>
        <div className="fld">
          <label>6.3.1 SCARRING / DISFIGUREMENT / DEFORMITY</label>
          <p style={{fontSize:9,color:"var(--sm)",marginBottom:8}}>Capture photos using your device camera (use the camera icon on mobile/tablet).</p>
          <TA value={r.ch6scarring||""} onChange={v=>setR(p=>({...p,ch6scarring:v}))}
            rows={3} apiKey={apiKey} placeholder="Description of scarring, deformity, or disfigurement..."/>
        </div>
        <div className="fld">
          <label>6.3.2 RADIOLOGICAL EXAMINATION</label>
          <p style={{fontSize:9,color:"var(--sm)",marginBottom:8}}>Upload X-ray images and paste the radiology report below.</p>
          <TA value={r.ch6radiology||""} onChange={v=>setR(p=>({...p,ch6radiology:v}))}
            rows={6} apiKey={apiKey}
            placeholder={"Exam Date: ...\nX-RAY [REGION]\nBones: ...\nSoft tissue: ...\nOther: ..."}/>
        </div>
      </div>
    </>
  );
}

// CH 7: Diagnosis
function Ch7({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">DIAGNOSIS</div>
      <p style={{fontSize:10,color:"var(--sm)",marginBottom:10}}>
        Following thorough review of records, patient interview, clinical examination and special investigations:
      </p>
      <TA value={r.ch7} onChange={v=>setR(p=>({...p,ch7:v}))}
        rows={10} apiKey={apiKey}
        placeholder={"1. Soft tissue injury of the right leg treated conservatively.\n2. Right foot fractures resulting in:\n   a. Pain and swelling...\n   b. Tender bony deformity...\n   c. Painful and restricted range of motion..."}
        aiHint="Format this diagnosis section for a South African orthopaedic medico-legal report. Use numbered and lettered lists. Correct grammar and medical terminology. Return only the formatted text."/>
    </div>
  );
}

// CH 8: Further Management
function Ch8({ r, setR, apiKey }){
  return (
    <>
      <div className="card">
        <div className="card-title">8.1 ORTHOPAEDIC TREATMENT</div>
        <TA value={r.ch8ortho} onChange={v=>setR(p=>({...p,ch8ortho:v}))}
          rows={8} apiKey={apiKey}
          placeholder={"Right foot and ankle:\na) Referral to a podiatrist for specialized footwear.\nb) Conservative treatment with NSAIDs and analgesics at approx. R500/month.\nc) Physiotherapy at R600/session.\nd) Occupational therapy at R600/session."}/>
      </div>
      <div className="card">
        <div className="card-title">8.2 REFERRALS</div>
        <TA value={r.ch8ref} onChange={v=>setR(p=>({...p,ch8ref:v}))}
          rows={5} apiKey={apiKey}
          placeholder={"After reviewing patient records and conducting a thorough evaluation, I advise the patient be assessed by:\n1. Podiatrist\n2. Physiotherapist\n3. Occupational Therapist\n4. Industrial Psychologist"}/>
      </div>
      <div className="card">
        <div className="card-title">8.3 BURDEN OF TREATMENT</div>
        <div style={{fontSize:10,color:"var(--sm)",lineHeight:1.6}}>
          <p>Standard paragraph ‚Äî included automatically in the report:</p>
          <div style={{background:"var(--s2)",padding:10,borderRadius:5,marginTop:8,fontSize:10,color:"var(--tx)"}}>
            Side effects from regular use of NSAIDs and analgesics include but are not limited to allergic reactions, peptic ulcer disease, heartburn, gastritis, kidney and liver damage, excessive bleeding, heart problems, and toxicity. Some of these drugs can cause impaired concentration, anxiety, sleepiness, and breathing abnormalities. Careful monitoring of the use of these drugs is essential as one can become dependent on them and/or suffer harmful side effects.
          </div>
        </div>
      </div>
      <div className="card">
        <div className="card-title">8.4 ADDITIONAL EXPENSES</div>
        <div style={{fontSize:10,color:"var(--sm)",lineHeight:1.6}}>
          <div style={{background:"var(--s2)",padding:10,borderRadius:5,fontSize:10,color:"var(--tx)"}}>
            Other specialist consultation rates, consultation frequency, and further treatment costs are to be determined by the relevant specialist. Transportation costs for treatment are to be determined by the Occupational Therapist. Medical inflation rates need to be taken into consideration as determined annually.
          </div>
        </div>
      </div>
    </>
  );
}

// CH 9: Disability & Impairment
function Ch9({ r, setR, apiKey }){
  const setAdl = (type, activity, val) => {
    const k = type==="basic"?"adlBasic":"adlAdv";
    setR(p=>({...p, [k]:{...p[k], [activity]:val}}));
  };
  const updateWpi = (i, field, val) => {
    const rows = [...(r.wpiRows||[{ region:"",impairment:"",reference:"",wpi:"" }])];
    rows[i] = {...rows[i], [field]:val};
    setR(p=>({...p, wpiRows:rows}));
  };
  const addWpiRow = () => {
    setR(p=>({...p, wpiRows:[...(p.wpiRows||[]), {region:"",impairment:"",reference:"",wpi:""}]}));
  };
  const removeWpiRow = (i) => {
    setR(p=>({...p, wpiRows:p.wpiRows.filter((_,idx)=>idx!==i)}));
  };

  const renderAdl = (items, opts, type) => (
    <table className="adl-tbl">
      <thead>
        <tr>
          <th style={{width:"35%"}}>ACTIVITY</th>
          {opts.map(o=><th key={o} style={{textAlign:"center"}}>{o}</th>)}
        </tr>
      </thead>
      <tbody>
        {items.map(act=>(
          <tr key={act}>
            <td style={{fontSize:10}}>{act}</td>
            {opts.map(opt=>(
              <td key={opt}>
                <div className="adl-radio">
                  <label>
                    <input type="radio" name={`${type}_${act}`}
                      value={opt} checked={(r[type==="basic"?"adlBasic":"adlAdv"]?.[act]||"")=== opt}
                      onChange={()=>setAdl(type,act,opt)}/>
                  </label>
                </div>
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  );

  return (
    <>
      <div className="card">
        <div className="card-title">9.1 ACTIVITIES OF DAILY LIVING ‚Äî AS REPORTED BY THE PATIENT</div>
        <div style={{marginBottom:16}}>
          <div style={{fontSize:10,fontWeight:700,color:"var(--tx)",marginBottom:8}}>Basic ADL</div>
          {renderAdl(ADL_BASIC, ADL_OPTS_B, "basic")}
        </div>
        <div>
          <div style={{fontSize:10,fontWeight:700,color:"var(--tx)",marginBottom:8}}>Advanced ADL</div>
          {renderAdl(ADL_ADV, ADL_OPTS_A, "advanced")}
        </div>
      </div>
      <div className="card">
        <div className="card-title">9.2 OCCUPATIONAL EFFECTS AND LIMITATIONS</div>
        <TA value={r.ch9occ||""} onChange={v=>setR(p=>({...p,ch9occ:v}))}
          rows={8} apiKey={apiKey}
          placeholder={"The patient was employed as a general worker at the time of the accident.\nAccording to the patient his recuperation period was approximately...\n..."}/>
      </div>
      <div className="card">
        <div className="card-title">9.3 NARRATIVE TEST ‚Äî MANUAL EDIT IN FINAL REPORT</div>
        <div style={{fontSize:10,color:"var(--sm)",lineHeight:1.6,background:"var(--s2)",padding:12,borderRadius:5}}>
          <strong style={{color:"var(--gd)"}}>‚ö† This section is kept for manual editing in the final report.</strong><br/>
          The standard RAF Amendment Regulations Narrative Test text will be included automatically. Review and edit in the exported document.
        </div>
      </div>
      <div className="card">
        <div className="card-title">9.5 WHOLE PERSON IMPAIRMENT (WPI)</div>
        <table className="rom-tbl" style={{marginBottom:10}}>
          <thead>
            <tr>
              <th>REGION</th><th>IMPAIRMENT DESCRIPTION</th><th>REFERENCE</th><th>WPI %</th><th></th>
            </tr>
          </thead>
          <tbody>
            {(r.wpiRows||[{region:"",impairment:"",reference:"",wpi:""}]).map((row,i)=>(
              <tr key={i}>
                <td><input value={row.region} onChange={e=>updateWpi(i,"region",e.target.value)} placeholder="Lower Extremities"/></td>
                <td><input value={row.impairment} onChange={e=>updateWpi(i,"impairment",e.target.value)} placeholder="Right foot fracture..."/></td>
                <td><input value={row.reference} onChange={e=>updateWpi(i,"reference",e.target.value)} placeholder="P501-505, T16-2"/></td>
                <td><input value={row.wpi} onChange={e=>updateWpi(i,"wpi",e.target.value)} placeholder="8%" style={{maxWidth:60}}/></td>
                <td><button className="btn btn-ghost btn-sm" onClick={()=>removeWpiRow(i)}>‚úï</button></td>
              </tr>
            ))}
            <tr>
              <td colSpan={3} style={{fontWeight:700,fontSize:10}}>COMBINED WPI</td>
              <td style={{fontWeight:700,color:"var(--ac)"}}>
                {(r.wpiRows||[]).reduce((acc,row)=>acc+(parseFloat(row.wpi)||0),0).toFixed(0)}%
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>
        <button className="btn btn-ghost btn-sm" onClick={addWpiRow}>+ Add Row</button>
      </div>
    </>
  );
}

// CH 10: Discussion
function Ch10({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">DISCUSSION</div>
      <TA value={r.ch10||""} onChange={v=>setR(p=>({...p,ch10:v}))}
        rows={12} apiKey={apiKey}
        placeholder={"Mr. [Name] was involved in a motor vehicle accident on [date].\nHe sustained [injuries] and continues to suffer from the sequelae of his injury.\nI believe that the injury he sustained has led to long-term impairment...\nTherefore, it is my professional opinion that his injuries are serious and qualify under 5.1 Serious long-term impairment or loss of a body function of the Narrative Test.\nHis Whole Person Impairment (WPI) is [X]% in accordance with the AMA Guides¬Æ 6th Edition.\nFrom an orthopaedic perspective, the injury will have no effect on his life expectancy."}
        aiHint="Write a professional Discussion section for a South African orthopaedic medico-legal RAF report based on the following notes. Correct grammar and use formal legal-medical language. Return only the text."/>
    </div>
  );
}

// ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function Preview({ r, onBack }){
  const fmt = (iso) => {
    if (!iso) return "";
    try { return new Date(iso).toLocaleDateString("en-ZA",{day:"2-digit",month:"long",year:"numeric"}); }
    catch { return iso; }
  };

  const adlTable = (title, items, opts, type) => {
    const key = type==="basic"?"adlBasic":"adlAdv";
    const rows = items.map(act=>`
      <tr>
        <td>${act}</td>
        ${opts.map(opt=>`<td style="text-align:center">${r[key]?.[act]===opt?"‚úì":""}</td>`).join("")}
      </tr>`).join("");
    return `<h3>${title}</h3>
      <table>
        <thead><tr><th>Activity</th>${opts.map(o=>`<th>${o}</th>`).join("")}</tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  };

  const wpiRows = (r.wpiRows||[]).map(row=>`
    <tr><td>${row.region}</td><td>${row.impairment}</td><td>${row.reference}</td><td>${row.wpi}</td></tr>`).join("");
  const combinedWpi = (r.wpiRows||[]).reduce((acc,row)=>acc+(parseFloat(row.wpi)||0),0).toFixed(0);

  const prompts = CH3_PROMPTS.map(p=>{
    const val = r.ch3prompts?.[p.letter];
    return val ? `<p><strong>${p.letter.toUpperCase()}.</strong> ${val}</p>` : "";
  }).filter(Boolean).join("");

  const mskSections = Object.keys(r.examRegions||{}).filter(k=>r.examRegions[k]).map(rg=>{
    const fields = EXAM_REGIONS[rg];
    const content = fields.map(f=>{
      const val = r.ch6msk?.[rg]?.[f];
      return val ? `<p><strong>${f}:</strong> ${val}</p>` : "";
    }).filter(Boolean).join("");
    return content ? `<h3>${rg}</h3>${content}` : "";
  }).filter(Boolean).join("");

  const injuries = (r.ch4injuries||[]).map((inj,i)=>`<p>${i+1}. ${inj}</p>`).join("");

  const html = `
    <h1 style="text-align:center;font-size:16pt;">MEDICO-LEGAL REPORT</h1>
    <p style="text-align:center"><strong>Our Reference:</strong> ${r.ourRef||"[REF]"}</p>
    <p style="text-align:center"><strong>Attorney Reference:</strong> ${r.attRef||"[ATTREF]"}</p>
    <br/>
    <table>
      <tbody>
        <tr><td><strong>Patient Full Name:</strong></td><td>${r.patientName||""}</td></tr>
        <tr><td><strong>ID/Reference:</strong></td><td>${r.refNum||""}</td></tr>
        <tr><td><strong>Gender:</strong></td><td>${r.gender||""}</td></tr>
        <tr><td><strong>Date of Birth:</strong></td><td>${fmt(r.dob)}</td></tr>
        <tr><td><strong>Current Age:</strong></td><td>${r.age||""}</td></tr>
        <tr><td><strong>Residential Address:</strong></td><td>${r.address||""}</td></tr>
        <tr><td><strong>Contact Number:</strong></td><td>${r.contact||""}</td></tr>
        <tr><td><strong>Date of Injury:</strong></td><td>${fmt(r.doi)}</td></tr>
        <tr><td><strong>Mechanism of Injury:</strong></td><td>${r.mechanism||""}</td></tr>
        <tr><td><strong>Pre-Accident Occupation:</strong></td><td>${r.preOccupation||""}</td></tr>
        <tr><td><strong>Post-Accident Occupation:</strong></td><td>${r.postOccupation||""}</td></tr>
        <tr><td><strong>Date of Examination:</strong></td><td>${fmt(r.dateExam)}</td></tr>
        <tr><td><strong>Place of Examination:</strong></td><td>${r.placeExam||""}</td></tr>
        <tr><td><strong>Instructing Attorney:</strong></td><td>${r.attorney||""}</td></tr>
        <tr><td><strong>Attorney Contact:</strong></td><td>${r.attContact||""}</td></tr>
      </tbody>
    </table>

    <h2>1. DOCUMENTS PERUSED</h2>
    <div class="btext">${(r.ch1||"").replace(/\n/g,"<br/>")}</div>

    <h2>2. OCCUPATIONAL AND MEDICAL HISTORY</h2>
    <h3>2.1 Occupational History</h3>
    <p><strong>Highest grade passed:</strong> ${r.ch2grade||""}</p>
    <p><strong>Tertiary education:</strong> ${r.ch2tertiary||""}</p>
    <p><strong>Pre-accident occupation:</strong> ${(r.ch2occ||"").replace(/\n/g,"<br/>")}</p>
    <p><strong>Post-accident occupation:</strong> ${(r.ch2postOcc||"").replace(/\n/g,"<br/>")}</p>
    <h3>2.2 Past Medical and Surgical History</h3>
    <p><strong>Previous injuries:</strong> ${r.ch2injuries||""}</p>
    <p><strong>Surgical history:</strong> ${r.ch2surgery||""}</p>
    <p><strong>Medical history:</strong> ${r.ch2medical||""}</p>
    <p><strong>Chronic medication:</strong> ${r.ch2meds||""}</p>
    ${r.ch2pmsx ? `<p>${r.ch2pmsx.replace(/\n/g,"<br/>")}</p>` : ""}

    <h2>3. SUMMARY OF THE HOSPITAL RECORDS</h2>
    <h3>3.1 Management and Diagnosis</h3>
    ${prompts}
    <h3>3.2 Post-Trauma Follow-Up and Treatment</h3>
    <div class="btext">${(r.ch3||"").replace(/\n/g,"<br/>")}</div>

    <h2>4. INJURIES SUSTAINED</h2>
    ${injuries || "<p>No injuries listed.</p>"}

    <h2>5. CURRENT COMPLAINTS</h2>
    <div class="btext">${(r.ch5||"").replace(/\n/g,"<br/>")}</div>

    <h2>6. CLINICAL EVALUATION</h2>
    <h3>6.1 General Examination</h3>
    <div class="btext">${(r.ch6general||"").replace(/\n/g,"<br/>")}</div>
    <h3>6.2 Musculoskeletal Examination</h3>
    ${mskSections||"<p>No examination findings entered.</p>"}
    <h3>6.3 Evidence of Injury &amp; Special Investigations</h3>
    <h4>6.3.1 Scarring and Disfigurement/Deformity</h4>
    <div class="btext">${(r.ch6scarring||"").replace(/\n/g,"<br/>")}</div>
    <h4>6.3.2 Radiological Examination</h4>
    <div class="btext">${(r.ch6radiology||"").replace(/\n/g,"<br/>")}</div>

    <h2>7. DIAGNOSIS</h2>
    <p>Following a thorough review of the patient's available records, the patient interview, my clinical examination, and the special investigation findings, I diagnose the patient as follows:</p>
    <div class="btext">${(r.ch7||"").replace(/\n/g,"<br/>")}</div>

    <h2>8. FURTHER MANAGEMENT</h2>
    <h3>8.1 Orthopaedic Treatment</h3>
    <div class="btext">${(r.ch8ortho||"").replace(/\n/g,"<br/>")}</div>
    <h3>8.2 Referrals</h3>
    <div class="btext">${(r.ch8ref||"").replace(/\n/g,"<br/>")}</div>
    <h3>8.3 Burden of Treatment</h3>
    <p>Side effects from regular use of NSAIDs and analgesics include but are not limited to allergic reactions, peptic ulcer disease, heartburn, gastritis, kidney and liver damage, excessive bleeding, heart problems, and toxicity. Some of these drugs can cause impaired concentration, anxiety, sleepiness, and breathing abnormalities. Careful monitoring of the use of these drugs is essential as one can become dependent on them and/or suffer harmful side effects. Additionally, the burden of cost, drug dependence, regional availability of medication, and compliance of treatment could become a stressor in the patient's life.</p>
    <h3>8.4 Additional Expenses</h3>
    <p>Other specialist consultation rates, consultation frequency, and further treatment costs are to be determined by the relevant specialist. Transportation costs for treatment are to be determined by the Occupational Therapist. Medical inflation rates need to be taken into consideration as determined annually.</p>

    <h2>9. DISABILITY &amp; IMPAIRMENT</h2>
    <h3>9.1 Activities of Daily Living ‚Äî As Reported by the Patient</h3>
    ${adlTable("Basic Activities of Daily Living", ADL_BASIC, ADL_OPTS_B, "basic")}
    ${adlTable("Advanced Activities of Daily Living", ADL_ADV, ADL_OPTS_A, "advanced")}
    <h3>9.2 Occupational Effects and Limitations</h3>
    <div class="btext">${(r.ch9occ||"").replace(/\n/g,"<br/>")}</div>
    <h3>9.3 Applying the Narrative Test</h3>
    <p>The Road Accident Fund (RAF) Amendment Regulations of 2008 prescribes the use of the Narrative Test as a medical instrument to be used to determine the seriousness of an individual's injuries if the Whole Person Impairment (WPI) rating is less than 30% in accordance with the American Medical Association (AMA) Guides to the Evaluation of Permanent Impairment, and if the medical practitioner regards the injuries as serious.</p>
    <p>In accordance with the RAF4 Serious Injury Assessment Report the following criteria were considered:</p>
    <p><strong>5.1 Serious long-term impairment or loss of a body function.</strong><br/>
    <strong>5.2 Permanent serious disfigurement.</strong><br/>
    <strong>5.3 Severe long-term mental or severe long-term behavioural disturbance or disorder.</strong><br/>
    <strong>5.4 Loss of a foetus.</strong></p>
    <h3>9.5 Whole Person Impairment</h3>
    <p>Using the AMA Guides¬Æ to the Evaluation of Permanent Impairment, 6th Edition:</p>
    <table>
      <thead><tr><th>Region</th><th>Impairment</th><th>Reference</th><th>WPI</th></tr></thead>
      <tbody>
        ${wpiRows}
        <tr><td colspan="3"><strong>Combined WPI</strong></td><td><strong>${combinedWpi}%</strong></td></tr>
      </tbody>
    </table>

    <h2>10. DISCUSSION</h2>
    <div class="btext">${(r.ch10||"").replace(/\n/g,"<br/>")}</div>

    <div style="margin-top:60px;padding-top:20px;border-top:1px solid #ccc;text-align:left">
      <p>________________________________</p>
      <p><strong>${r.drName||"[PRACTITIONER NAME]"}</strong></p>
      <p><em>${r.quals||"[QUALIFICATIONS]"}</em></p>
      <p>Orthopaedic Surgeon</p>
      <p style="font-size:9pt;margin-top:12px;color:#666">
        VALIDITY: This report will remain valid for use in a court of law for a period of 2 (two) years from the date of the first consultation.
      </p>
    </div>
  `;

  const copyText = () => {
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    navigator.clipboard.writeText(tmp.textContent||tmp.innerText||"");
  };

  const exportDoc = () => {
    const full = `<!DOCTYPE html><html><head><meta charset="UTF-8">
      <style>
        body{font-family:'Times New Roman',serif;font-size:11pt;line-height:1.6;margin:2cm;}
        h1{font-size:14pt;text-align:center;} h2{font-size:11pt;border-bottom:1px solid #ccc;padding-bottom:3px;}
        h3{font-size:10pt;} table{width:100%;border-collapse:collapse;margin:10px 0;}
        th,td{border:1px solid #ccc;padding:4px 8px;font-size:9.5pt;}
        th{background:#f0f0f0;}
      </style></head><body>${html}</body></html>`;
    const blob = new Blob([full], {type:"application/msword"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MediSync_${(r.patientName||"Report").replace(/\s+/g,"_")}.doc`;
    a.click();
  };

  return (
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <div className="ch-hdr no-print">
        <div>
          <div className="ch-title">REPORT PREVIEW</div>
          <div className="ch-sub">Read-only preview ‚Äî export to edit</div>
        </div>
        <button className="btn btn-ghost" onClick={onBack}>‚Üê Back to Editor</button>
      </div>
      <div className="prev-wrap">
        <div className="prev-page" dangerouslySetInnerHTML={{__html:html}}/>
      </div>
      <div className="prev-fabs no-print">
        <button className="fab" style={{background:"#7c3aed"}} onClick={copyText} title="Copy text">üìã</button>
        <button className="fab" style={{background:"#3d7eff"}} onClick={exportDoc} title="Export .doc">‚¨á</button>
        <button className="fab" style={{background:"#111"}} onClick={()=>window.print()} title="Print">üñ®</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App(){
  const [reports, setReports] = useState(() => DB.load());
  const [activeId, setActiveId] = useState(null);
  const [chapter, setChapter] = useState(0);
  const [view, setView] = useState("list"); // list | editor | preview
  const [sbOpen, setSbOpen] = useState(true);
  const [toast, setToast] = useState(null);
  const [saving, setSaving] = useState(false);
  const [apiKey, setApiKey] = useState(() => localStorage.getItem("ms_apikey")||"");
  const [showApiModal, setShowApiModal] = useState(false);
  const [query, setQuery] = useState("");

  const activeReport = reports.find(r=>r.id===activeId);

  // Auto-save
  useEffect(() => {
    if (!reports.length) return;
    setSaving(true);
    DB.save(reports);
    const t = setTimeout(()=>setSaving(false), 800);
    return ()=>clearTimeout(t);
  }, [reports]);

  const showToast = (msg) => {
    setToast(msg);
    setTimeout(()=>setToast(null), 2500);
  };

  const updateReport = (updater) => {
    setReports(prev => prev.map(r => r.id===activeId ? {...updater(r), updated:new Date().toISOString()} : r));
  };

  const createReport = () => {
    const r = newReport();
    setReports(p=>[r,...p]);
    setActiveId(r.id);
    setChapter(0);
    setView("editor");
  };

  const deleteReport = (id) => {
    if (!confirm("Delete this report? This cannot be undone.")) return;
    setReports(p=>p.filter(r=>r.id!==id));
    if (activeId===id) { setActiveId(null); setView("list"); }
  };

  const openReport = (id) => {
    setActiveId(id);
    setChapter(0);
    setView("editor");
  };

  const saveApiKey = (key) => {
    localStorage.setItem("ms_apikey", key);
    setApiKey(key);
    setShowApiModal(false);
    showToast("API key saved");
  };

  // Progress calculation
  const calcProgress = (r) => {
    const fields = [r.patientName,r.doi,r.mechanism,r.ch1,r.ch2occ,r.ch3,r.ch5,r.ch6general,r.ch7,r.ch8ortho,r.ch10];
    const filled = fields.filter(f=>f&&String(f).trim().length>0).length;
    return Math.round((filled/fields.length)*100);
  };

  const filteredReports = reports.filter(r => {
    if (!query) return true;
    const q = query.toLowerCase();
    return (r.patientName||"").toLowerCase().includes(q) ||
           (r.ourRef||"").toLowerCase().includes(q) ||
           (r.attRef||"").toLowerCase().includes(q);
  });

  const renderChapter = () => {
    if (!activeReport) return null;
    const props = { r:activeReport, setR:updateReport, apiKey };
    switch(chapter){
      case 0: return <Ch0 {...props}/>;
      case 1: return <Ch1 {...props}/>;
      case 2: return <Ch2 {...props}/>;
      case 3: return <Ch3 {...props}/>;
      case 4: return <Ch4 {...props}/>;
      case 5: return <Ch5 {...props}/>;
      case 6: return <Ch6 {...props}/>;
      case 7: return <Ch7 {...props}/>;
      case 8: return <Ch8 {...props}/>;
      case 9: return <Ch9 {...props}/>;
      case 10: return <Ch10 {...props}/>;
      default: return null;
    }
  };

  // ‚îÄ‚îÄ API KEY MODAL
  if (showApiModal) return (
    <div className="modal-bg" onClick={()=>setShowApiModal(false)}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <div className="modal-title">ANTHROPIC API KEY</div>
        <p style={{fontSize:10,color:"var(--sm)",marginBottom:12,lineHeight:1.5}}>
          Enter your Anthropic API key to enable AI-powered grammar correction and content enhancement.
          Your key is stored locally in the browser and never sent to any server other than Anthropic.
        </p>
        <ApiKeyForm current={apiKey} onSave={saveApiKey} onCancel={()=>setShowApiModal(false)}/>
      </div>
    </div>
  );

  // ‚îÄ‚îÄ PREVIEW VIEW
  if (view==="preview" && activeReport){
    return (
      <div className="app">
        <Preview r={activeReport} onBack={()=>setView("editor")}/>
        {toast && <div className="toast">{toast}</div>}
      </div>
    );
  }

  // ‚îÄ‚îÄ LIST VIEW
  if (view==="list"){
    return (
      <div className="app">
        <header className="hdr">
          <div className="hdr-l">
            <div className="hdr-icon">üî¨</div>
            <div>
              <div className="hdr-name">MediSync <span>Ortho</span></div>
              <div className="hdr-sub">MEDICO-LEGAL ENGINE</div>
            </div>
          </div>
          <div className="hdr-r">
            <button className="btn btn-ghost btn-sm" onClick={()=>setShowApiModal(true)}>
              {apiKey ? "‚úì AI Key" : "Set AI Key"}
            </button>
            <button className="btn btn-ac" onClick={createReport}>+ New Report</button>
          </div>
        </header>
        <div style={{flex:1,overflow:"hidden",display:"flex",flexDirection:"column",padding:24,maxWidth:700,margin:"0 auto",width:"100%"}}>
          <div style={{marginBottom:16}}>
            <input className="search-inp" placeholder="Search reports by name, reference..."
              value={query} onChange={e=>setQuery(e.target.value)} style={{width:"100%"}}/>
          </div>
          {filteredReports.length===0 ? (
            <div className="empty">
              <div className="empty-icon">üìã</div>
              <div className="empty-title">{reports.length?"No results":"No Reports Yet"}</div>
              <div className="empty-sub">
                {reports.length?"Try a different search term.":"Create your first medico-legal report to get started."}
              </div>
              {!reports.length && (
                <button className="btn btn-ac" style={{marginTop:20}} onClick={createReport}>+ Create Report</button>
              )}
            </div>
          ) : (
            <div style={{flex:1,overflowY:"auto"}}>
              {filteredReports.map(rpt=>{
                const prog = calcProgress(rpt);
                return (
                  <div key={rpt.id} className="rpt-card" onClick={()=>openReport(rpt.id)}>
                    <div className="rpt-icon">üìÑ</div>
                    <div className="rpt-meta">
                      <div className="rpt-name">{rpt.patientName||"Untitled Report"}</div>
                      <div className="rpt-date">
                        {rpt.ourRef&&`${rpt.ourRef} ¬∑ `}
                        {rpt.doi&&`DOI: ${rpt.doi} ¬∑ `}
                        Updated: {new Date(rpt.updated||rpt.created).toLocaleDateString("en-ZA")}
                      </div>
                      <div className="rpt-prog">{prog}% complete</div>
                      <div className="prog-bar"><div className="prog-fill" style={{width:`${prog}%`}}/></div>
                    </div>
                    <button className="btn btn-ghost btn-sm" onClick={e=>{e.stopPropagation();deleteReport(rpt.id);}}>üóë</button>
                  </div>
                );
              })}
            </div>
          )}
        </div>
        {toast && <div className="toast">{toast}</div>}
      </div>
    );
  }

  // ‚îÄ‚îÄ EDITOR VIEW
  return (
    <div className="app">
      <header className="hdr">
        <div className="hdr-l">
          <button className="btn btn-ghost btn-sm" style={{padding:"4px 8px"}} onClick={()=>setSbOpen(p=>!p)}>‚ò∞</button>
          <div className="hdr-icon">üî¨</div>
          <div>
            <div className="hdr-name">MediSync <span>Ortho</span></div>
            <div className="hdr-sub" style={{display:"flex",alignItems:"center",gap:4}}>
              <span className={`sdot${saving?" pulse":""}`}/>
              {saving?"SAVING‚Ä¶":"SAVED"}
            </div>
          </div>
        </div>
        <div className="hdr-r">
          <button className="btn btn-ghost btn-sm" onClick={()=>{setView("list");setActiveId(null);}}>‚Üê Reports</button>
          <button className="btn btn-ghost btn-sm" onClick={()=>setShowApiModal(true)}>
            {apiKey?"‚úì AI":"Set AI Key"}
          </button>
          <button className="btn btn-ac btn-sm" onClick={()=>setView("preview")}>Preview</button>
        </div>
      </header>

      <div className="body-wrap">
        {/* SIDEBAR */}
        <nav className={`sb${sbOpen?"":" closed"}`}>
          <div className="sb-head">
            <div className="sb-lbl">CHAPTERS</div>
            {activeReport && <div style={{fontSize:8,color:"var(--sm)",marginTop:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{activeReport.patientName||"New Report"}</div>}
          </div>
          <div className="sb-list">
            {CHAPTERS.map(ch=>{
              const done = ch.id===0 ? !!(activeReport?.patientName) :
                           ch.id===1 ? !!(activeReport?.ch1) :
                           ch.id===2 ? !!(activeReport?.ch2occ) :
                           ch.id===3 ? !!(activeReport?.ch3||Object.keys(activeReport?.ch3prompts||{}).length) :
                           ch.id===4 ? !!(activeReport?.ch4injuries?.length) :
                           ch.id===5 ? !!(activeReport?.ch5) :
                           ch.id===6 ? !!(activeReport?.ch6general) :
                           ch.id===7 ? !!(activeReport?.ch7) :
                           ch.id===8 ? !!(activeReport?.ch8ortho) :
                           ch.id===9 ? !!(activeReport?.ch9occ) :
                           ch.id===10? !!(activeReport?.ch10) : false;
              return (
                <button key={ch.id} className={`nb${chapter===ch.id?" on":""}`} onClick={()=>setChapter(ch.id)}>
                  <span className="nb-num">{ch.id}.</span>
                  <span>{ch.short}</span>
                  {done && <span className="nb-dot"/>}
                </button>
              );
            })}
          </div>
        </nav>

        {/* MAIN */}
        <main className="main">
          <div className="ch-hdr">
            <div>
              <div className="ch-title">{CHAPTERS[chapter].title}</div>
              <div className="ch-sub">Chapter {chapter} of 10</div>
            </div>
            <div style={{display:"flex",gap:8,alignItems:"center"}}>
              {chapter>0&&<button className="btn btn-ghost btn-sm" onClick={()=>setChapter(p=>p-1)}>‚Üê Prev</button>}
              {chapter<10&&<button className="btn btn-ac btn-sm" onClick={()=>setChapter(p=>p+1)}>Next ‚Üí</button>}
            </div>
          </div>
          <div className="content">
            {activeReport ? renderChapter() : (
              <div className="empty">
                <div className="empty-icon">üìã</div>
                <div className="empty-title">No Report Selected</div>
                <div className="empty-sub">Go back and select or create a report.</div>
              </div>
            )}
          </div>
        </main>
      </div>

      {toast && <div className="toast">{toast}</div>}
    </div>
  );
}

// ‚îÄ‚îÄ API KEY FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ApiKeyForm({ current, onSave, onCancel }){
  const [val, setVal] = useState(current||"");
  return (
    <div>
      <div className="fld">
        <label>API KEY</label>
        <input type="password" value={val} onChange={e=>setVal(e.target.value)}
          placeholder="sk-ant-..." style={{fontFamily:"monospace"}}/>
      </div>
      <div style={{display:"flex",gap:8,marginTop:8}}>
        <button className="btn btn-ac" onClick={()=>onSave(val)}>Save Key</button>
        <button className="btn btn-ghost" onClick={onCancel}>Cancel</button>
        {current && <button className="btn btn-ghost" style={{color:"var(--rd)"}} onClick={()=>onSave("")}>Clear</button>}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ MOUNT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);
</script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>MediSync Ortho ‚Äî MedLegal Engine</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#09090f;--s1:#0f1018;--s2:#14161e;--bd:#1c1f2a;
  --ac:#00e8b4;--bl:#3d7eff;--gd:#f0a030;--rd:#ff4455;--pu:#a855f7;
  --tx:#d8e0f0;--mt:#3e4460;--sm:#7880a0;
}
html,body,#root{height:100%;background:var(--bg);color:var(--tx);}
body{font-family:'IBM Plex Mono',monospace;font-size:12px;overflow:hidden;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px;}
button,input,select,textarea{font-family:'IBM Plex Mono',monospace;}
textarea{resize:vertical;}

/* APP LAYOUT */
.app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}

/* HEADER */
.hdr{display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;height:48px;background:var(--s1);border-bottom:1px solid var(--bd);
  flex-shrink:0;z-index:60;}
.hdr-l{display:flex;align-items:center;gap:10px;}
.hdr-icon{width:30px;height:30px;background:var(--bl);border-radius:7px;
  display:flex;align-items:center;justify-content:center;font-size:16px;}
.hdr-name{font-size:11px;font-weight:700;letter-spacing:2px;color:var(--tx);}
.hdr-name span{color:var(--ac);}
.hdr-sub{font-size:8px;color:var(--sm);letter-spacing:1px;margin-top:1px;}
.hdr-r{display:flex;gap:6px;align-items:center;}

/* STATUS DOT */
.sdot{width:6px;height:6px;border-radius:50%;background:var(--ac);display:inline-block;}
.sdot.pulse{animation:sdpulse .9s infinite;}
@keyframes sdpulse{0%,100%{background:var(--gd);opacity:1;}50%{opacity:.3;}}

/* BODY */
.body-wrap{display:flex;flex:1;overflow:hidden;}

/* SIDEBAR */
.sb{width:220px;min-width:220px;background:var(--s1);border-right:1px solid var(--bd);
  display:flex;flex-direction:column;transition:width .2s,min-width .2s;overflow:hidden;}
.sb.closed{width:0;min-width:0;}
.sb-head{padding:12px 14px;border-bottom:1px solid var(--bd);white-space:nowrap;}
.sb-lbl{font-size:8px;letter-spacing:3px;color:var(--ac);font-weight:700;}
.sb-list{flex:1;overflow-y:auto;padding:6px;}

/* NAV BUTTON */
.nb{display:flex;align-items:center;gap:8px;padding:7px 9px;border-radius:5px;
  font-size:8.5px;font-weight:700;letter-spacing:.8px;color:var(--mt);
  border:1px solid transparent;background:none;width:100%;text-align:left;
  white-space:nowrap;cursor:pointer;transition:all .1s;margin-bottom:1px;}
.nb:hover{color:var(--tx);background:var(--s2);}
.nb.on{color:var(--ac);border-color:rgba(0,232,180,.25);background:rgba(0,232,180,.05);}
.nb-num{font-size:8px;color:var(--sm);min-width:16px;}
.nb-dot{width:5px;height:5px;border-radius:50%;background:var(--ac);margin-left:auto;}

/* MAIN CONTENT */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.content{flex:1;overflow-y:auto;padding:20px 24px;}

/* CARDS */
.card{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:16px;margin-bottom:14px;}
.card-title{font-size:9px;letter-spacing:2px;color:var(--ac);font-weight:700;margin-bottom:12px;}

/* FORM ELEMENTS */
.fld{margin-bottom:12px;}
.fld label{display:block;font-size:9px;letter-spacing:1px;color:var(--sm);margin-bottom:4px;}
.fld input,.fld select,.fld textarea{
  width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  color:var(--tx);padding:8px 10px;font-size:11px;outline:none;transition:border .15s;}
.fld input:focus,.fld select:focus,.fld textarea:focus{border-color:var(--ac);}
.fld select option{background:var(--s2);}
.fld textarea{min-height:80px;line-height:1.5;}
.fld-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.fld-row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

/* BUTTONS */
.btn{border:none;border-radius:5px;padding:7px 13px;font-size:9px;letter-spacing:1px;
  font-weight:700;cursor:pointer;transition:all .12s;display:inline-flex;align-items:center;gap:5px;}
.btn-ac{background:var(--ac);color:#000;}
.btn-ac:hover{background:#00c99a;}
.btn-bl{background:var(--bl);color:#fff;}
.btn-bl:hover{background:#2d6aef;}
.btn-gd{background:var(--gd);color:#000;}
.btn-gd:hover{background:#d08a20;}
.btn-rd{background:var(--rd);color:#fff;}
.btn-rd:hover{background:#e03344;}
.btn-ghost{background:transparent;border:1px solid var(--bd);color:var(--sm);}
.btn-ghost:hover{border-color:var(--ac);color:var(--tx);}
.btn-sm{padding:4px 9px;font-size:8px;}

/* VOICE BUTTON */
.mic-btn{border-radius:50%;width:36px;height:36px;display:flex;align-items:center;
  justify-content:center;cursor:pointer;border:none;transition:all .12s;flex-shrink:0;}
.mic-btn.idle{background:var(--s2);color:var(--sm);}
.mic-btn.idle:hover{background:var(--bd);color:var(--tx);}
.mic-btn.recording{background:var(--rd);color:#fff;animation:mrecord 1s infinite;}
@keyframes mrecord{0%,100%{box-shadow:0 0 0 0 rgba(255,68,85,.4);}50%{box-shadow:0 0 0 8px rgba(255,68,85,0);}}

/* TEXTAREA WITH MIC */
.ta-wrap{display:flex;gap:8px;align-items:flex-start;}
.ta-wrap textarea{flex:1;}
.ta-actions{display:flex;flex-direction:column;gap:6px;}

/* AI BUTTON */
.ai-btn{border-radius:5px;padding:6px 8px;font-size:8px;letter-spacing:.5px;font-weight:700;
  cursor:pointer;border:none;background:rgba(168,85,247,.15);color:var(--pu);
  border:1px solid rgba(168,85,247,.3);transition:all .12s;white-space:nowrap;}
.ai-btn:hover{background:rgba(168,85,247,.25);}
.ai-btn:disabled{opacity:.4;cursor:wait;}

/* CHAPTER HEADER */
.ch-hdr{padding:14px 24px;border-bottom:1px solid var(--bd);flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;background:var(--s1);}
.ch-title{font-size:13px;font-weight:700;letter-spacing:1px;color:var(--tx);}
.ch-sub{font-size:8px;color:var(--sm);margin-top:2px;letter-spacing:.5px;}

/* TAG */
.tag{display:inline-flex;align-items:center;padding:2px 7px;border-radius:3px;
  font-size:8px;font-weight:700;letter-spacing:.5px;}
.tag-ac{background:rgba(0,232,180,.12);color:var(--ac);}
.tag-gd{background:rgba(240,160,48,.12);color:var(--gd);}
.tag-rd{background:rgba(255,68,85,.12);color:var(--rd);}
.tag-bl{background:rgba(61,126,255,.12);color:var(--bl);}

/* ADL TABLE */
.adl-tbl{width:100%;border-collapse:collapse;font-size:10px;margin-bottom:16px;}
.adl-tbl th{background:var(--s2);color:var(--sm);padding:6px 8px;font-size:8px;letter-spacing:1px;
  border:1px solid var(--bd);text-align:left;}
.adl-tbl td{padding:5px 8px;border:1px solid var(--bd);vertical-align:middle;}
.adl-tbl tr:hover td{background:var(--s2);}
.adl-radio{display:flex;gap:10px;justify-content:center;}
.adl-radio label{cursor:pointer;display:flex;align-items:center;gap:3px;font-size:9px;color:var(--sm);}
.adl-radio label:hover{color:var(--tx);}
.adl-radio input[type=radio]{accent-color:var(--ac);}

/* ROM TABLE */
.rom-tbl{width:100%;border-collapse:collapse;font-size:11px;}
.rom-tbl th{background:var(--s2);padding:6px 8px;font-size:8px;letter-spacing:1px;color:var(--sm);
  border:1px solid var(--bd);}
.rom-tbl td{padding:4px 6px;border:1px solid var(--bd);}
.rom-tbl input{width:100%;background:transparent;border:none;color:var(--tx);outline:none;font-size:11px;text-align:center;}

/* REPORT LIST */
.rpt-card{background:var(--s2);border:1px solid var(--bd);border-radius:7px;padding:13px 15px;
  margin-bottom:8px;cursor:pointer;transition:all .12s;display:flex;align-items:center;gap:12px;}
.rpt-card:hover{border-color:var(--ac);background:var(--s1);}
.rpt-card.active{border-color:var(--ac);background:var(--s1);}
.rpt-icon{width:36px;height:36px;border-radius:7px;background:rgba(61,126,255,.15);
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.rpt-meta{flex:1;min-width:0;}
.rpt-name{font-size:11px;font-weight:700;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rpt-date{font-size:8px;color:var(--sm);margin-top:2px;}
.rpt-prog{font-size:8px;color:var(--ac);margin-top:2px;}

/* PROGRESS BAR */
.prog-bar{height:3px;background:var(--bd);border-radius:2px;margin-top:6px;}
.prog-fill{height:100%;background:var(--ac);border-radius:2px;transition:width .3s;}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;
  display:flex;align-items:center;justify-content:center;}
.modal{background:var(--s1);border:1px solid var(--bd);border-radius:10px;
  padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;}
.modal-title{font-size:12px;font-weight:700;letter-spacing:1px;margin-bottom:16px;color:var(--ac);}

/* PROMPT LIST */
.prompt-item{background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  padding:10px 12px;margin-bottom:8px;}
.prompt-letter{font-size:9px;color:var(--gd);font-weight:700;margin-bottom:3px;}
.prompt-text{font-size:10px;color:var(--sm);}

/* EXAM REGION */
.region-btn{background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  padding:8px 12px;font-size:9px;font-weight:700;cursor:pointer;color:var(--sm);
  transition:all .12s;text-align:left;width:100%;margin-bottom:4px;}
.region-btn:hover{border-color:var(--bl);color:var(--tx);}
.region-btn.sel{border-color:var(--ac);color:var(--ac);background:rgba(0,232,180,.05);}

/* CHAPTER 4 injuries */
.inj-list{list-style:none;}
.inj-item{display:flex;align-items:center;gap:8px;padding:6px 0;
  border-bottom:1px solid var(--bd);font-size:11px;}
.inj-item:last-child{border-bottom:none;}
.inj-dot{width:6px;height:6px;border-radius:50%;background:var(--gd);flex-shrink:0;}

/* PRINT STYLES */
@media print{
  body{background:#fff;color:#000;font-family:'Times New Roman',serif;font-size:11pt;}
  .no-print{display:none!important;}
  .print-only{display:block!important;}
  .prev-page{box-shadow:none;border:none;}
}
.print-only{display:none;}

/* PREVIEW */
.prev-wrap{flex:1;overflow-y:auto;background:var(--bg);padding:20px;}
.prev-page{background:#fff;color:#222;max-width:760px;margin:0 auto;
  padding:50px 60px;font-family:'Libre Baskerville',serif;font-size:10.5pt;
  line-height:1.6;box-shadow:0 4px 40px rgba(0,0,0,.5);border-radius:4px;}
.prev-page h1{font-size:14pt;font-weight:700;margin-bottom:6px;color:#111;}
.prev-page h2{font-size:11pt;font-weight:700;margin:18px 0 6px;color:#111;
  border-bottom:1px solid #ddd;padding-bottom:4px;}
.prev-page h3{font-size:10pt;font-weight:700;margin:12px 0 4px;}
.prev-page p,.btext{margin-bottom:8px;}
.prev-page table{width:100%;border-collapse:collapse;margin:10px 0;font-size:9.5pt;}
.prev-page table th{background:#f0f0f0;padding:5px 8px;border:1px solid #ccc;font-size:8.5pt;}
.prev-page table td{padding:4px 8px;border:1px solid #ccc;}
.prev-fabs{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:8px;}
.fab{width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:18px;
  box-shadow:0 2px 12px rgba(0,0,0,.4);transition:transform .12s;}
.fab:hover{transform:scale(1.1);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
  background:var(--s1);border:1px solid var(--ac);border-radius:6px;
  padding:9px 18px;font-size:10px;color:var(--ac);letter-spacing:.5px;
  z-index:999;animation:fadein .2s ease;}
@keyframes fadein{from{opacity:0;transform:translateX(-50%) translateY(8px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

/* EMPTY STATE */
.empty{text-align:center;padding:60px 20px;color:var(--sm);}
.empty-icon{font-size:48px;margin-bottom:16px;}
.empty-title{font-size:14px;font-weight:700;color:var(--tx);margin-bottom:6px;}
.empty-sub{font-size:10px;line-height:1.5;}

/* LOADING SPINNER */
.spin{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,232,180,.3);
  border-top-color:var(--ac);border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* SEARCH */
.search-wrap{padding:10px;border-bottom:1px solid var(--bd);}
.search-inp{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:5px;
  color:var(--tx);padding:7px 10px;font-size:10px;outline:none;}
.search-inp:focus{border-color:var(--ac);}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

// ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const I = {
  mic: "üé§", stop: "‚èπ", ai: "‚ú®", save: "üíæ", new: "‚ûï",
  del: "üóë", back: "‚Üê", prev: "üëÅ", copy: "üìã", dl: "‚¨á",
  print: "üñ®", menu: "‚ò∞", scope: "üî¨", check: "‚úì", x: "‚úï",
  doc: "üìÑ", folder: "üìÅ", warn: "‚ö†", info: "‚Ñπ", arrow: "‚Üí"
};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DB = {
  load(){ try{ return JSON.parse(localStorage.getItem("ms_ortho")||"[]"); }catch{ return []; } },
  save(all){ try{ localStorage.setItem("ms_ortho",JSON.stringify(all)); }catch(e){} }
};

// ‚îÄ‚îÄ CHAPTERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CHAPTERS = [
  { id:0,  title:"Cover / Demographics",  short:"Demographics" },
  { id:1,  title:"Documents Perused",     short:"Documents" },
  { id:2,  title:"Occupational & Medical History", short:"History" },
  { id:3,  title:"Summary of Hospital Records", short:"Hospital Records" },
  { id:4,  title:"Injuries Sustained",    short:"Injuries" },
  { id:5,  title:"Current Complaints",    short:"Complaints" },
  { id:6,  title:"Clinical Evaluation",   short:"Clinical Eval" },
  { id:7,  title:"Diagnosis",             short:"Diagnosis" },
  { id:8,  title:"Further Management",    short:"Management" },
  { id:9,  title:"Disability & Impairment", short:"Disability" },
  { id:10, title:"Discussion",            short:"Discussion" },
];

// ‚îÄ‚îÄ CHAPTER 3 PROMPTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CH3_PROMPTS = [
  { letter:"a", text:"Mechanism of accident and date of accident." },
  { letter:"b", text:"EMS assessment on scene ‚Äî presentation, complaints, exam findings, GCS, suspected diagnosis." },
  { letter:"c", text:"Transfer to hospital ‚Äî name of hospital and mode of transport (ambulance, helicopter, etc.)." },
  { letter:"d", text:"Date of presentation to hospital and department." },
  { letter:"e", text:"Complaints and findings on initial assessment." },
  { letter:"f", text:"Immediate investigations / treatment rendered." },
  { letter:"g", text:"Diagnosis." },
  { letter:"h", text:"Admission, transfer to relevant department, and formal diagnosis." },
  { letter:"i", text:"Definitive management and treatment prescribed, including dates." },
  { letter:"j", text:"Post-operative treatment and rehabilitation." },
  { letter:"k", text:"Discharge and assistive devices / step-down treatment." },
  { letter:"l", text:"Follow-up and review." },
];

// ‚îÄ‚îÄ EXAM REGIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const EXAM_REGIONS = {
  "Cervical Spine":   ["Inspection","Palpation","Range of Motion (Flexion/Extension/Rotation/Lateral Flexion)","Power (myotomes C5-T1)","Sensation (dermatomes)","Reflexes (biceps C5, triceps C7, brachioradialis C6)","Spurling's Test","Lhermitte's Sign"],
  "Shoulder":         ["Inspection","Palpation","Range of Motion (Flexion/Abduction/External Rotation/Internal Rotation)","Power","Sensation","Reflexes","Neer's Test","Hawkins-Kennedy Test","Job's Test (empty can)","Apprehension Test","O'Brien's Test"],
  "Elbow":            ["Inspection","Palpation","Range of Motion (Flexion/Extension/Pronation/Supination)","Power","Sensation","Reflexes (biceps, triceps, brachioradialis)","Valgus/Varus Stress Test","Tinel's Sign at Cubital Tunnel"],
  "Wrist & Hand":     ["Inspection","Palpation","Range of Motion (Flexion/Extension/Radial-Ulnar Deviation)","Power (grip strength)","Sensation","Reflexes","Tinel's at Carpal Tunnel","Phalen's Test","Finkelstein's Test"],
  "Lumbar Spine":     ["Inspection","Palpation","Range of Motion (Flexion/Extension/Lateral Flexion/Rotation)","Power (myotomes L1-S1)","Sensation (dermatomes)","Reflexes (knee L4, ankle S1)","Straight Leg Raise (SLR)","Crossed SLR","Femoral Nerve Stretch"],
  "Hip":              ["Inspection","Palpation","Range of Motion (Flexion/Extension/Abduction/Adduction/Internal/External Rotation)","Power","Sensation","FABER Test","FADIR Test","Thomas Test","Trendelenburg Test"],
  "Knee":             ["Inspection","Palpation","Range of Motion (Flexion/Extension)","Power (quadriceps/hamstrings)","Sensation","Reflexes (patellar)","Lachman's Test","Anterior/Posterior Drawer","McMurray's Test","Valgus/Varus Stress"],
  "Ankle & Foot":     ["Inspection","Palpation","Range of Motion (Dorsiflexion/Plantar Flexion/Inversion/Eversion)","Power (big toe, ankle)","Sensation","Reflexes (Achilles)","Anterior Drawer Test","Talar Tilt Test","Thompson's Test"],
};

// ‚îÄ‚îÄ ADL ITEMS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ADL_BASIC = ["Bowel control","Bladder control","Grooming","Toileting","Feeding","Transfer (chair to bed)","Indoor mobility","Dressing","Stairs","Bathing"];
const ADL_ADV   = ["Driving a car","Sexual function","Medical self-care","Money management","Writing & communication","Travelling","Shopping","Cooking","Housework","Moderate activities (pushing/lifting)","Vigorous activities (sport/heavy lifting)"];
const ADL_OPTS_B = ["No Effect","Mild","Moderate","Severe"];
const ADL_OPTS_A = ["N/A","No Effect","Mild","Moderate","Severe"];

// ‚îÄ‚îÄ NEW REPORT TEMPLATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function newReport(){
  return {
    id: Date.now(),
    created: new Date().toISOString(),
    updated: new Date().toISOString(),
    // Demographics
    drName:"", quals:"", ourRef:"", attRef:"",
    patientName:"", refNum:"", gender:"", dob:"", age:"", address:"", contact:"",
    doi:"", mechanism:"", preOccupation:"", postOccupation:"",
    dateExam:"", placeExam:"RG Medlegal Rooms, Kings Court Centre, Walmer Heights, Gqeberha, 6070",
    attorney:"", attContact:"",
    // Chapter content (keyed by chapter id)
    ch1:"", ch2occ:"", ch2pmsx:"", ch3:"", ch3prompts:{},
    ch4injuries:[], ch5:"", ch6general:"", ch6msk:{},
    ch7:"", ch8ortho:"", ch8ref:"", ch10:"",
    // ADL
    adlBasic:{}, adlAdv:{},
    // Occupational effects
    ch9occ:"",
    // WPI table
    wpiRows:[{ region:"", impairment:"", reference:"", wpi:"" }],
    // Exam regions selected
    examRegions:{},
  };
}

// ‚îÄ‚îÄ VOICE HOOK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function useVoice(){
  const [active, setActive] = useState(false);
  const [supported] = useState(() => 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window);
  const recRef = useRef(null);
  const cbRef  = useRef(null);

  const start = useCallback((onResult) => {
    if (!supported) { alert("Voice recognition not supported in this browser."); return; }
    cbRef.current = onResult;
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const r = new SR();
    r.lang = "en-ZA"; r.continuous = true; r.interimResults = false;
    r.onresult = e => {
      const t = Array.from(e.results).map(r=>r[0].transcript).join(" ");
      if (cbRef.current) cbRef.current(t);
    };
    r.onerror = () => setActive(false);
    r.onend = () => setActive(false);
    r.start();
    recRef.current = r;
    setActive(true);
  }, [supported]);

  const stop = useCallback(() => {
    if (recRef.current) { recRef.current.stop(); recRef.current = null; }
    setActive(false);
  }, []);

  return { active, supported, start, stop };
}

// ‚îÄ‚îÄ AI HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function aiProcess(text, instruction, apiKey){
  if (!apiKey) return text;
  try {
    const res = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST",
      headers:{ "Content-Type":"application/json", "x-api-key":apiKey, "anthropic-version":"2023-06-01", "anthropic-dangerous-direct-browser-access":"true" },
      body: JSON.stringify({
        model:"claude-haiku-4-5-20251001",
        max_tokens:2000,
        messages:[{ role:"user", content:`${instruction}\n\nText:\n${text}` }]
      })
    });
    const d = await res.json();
    return d?.content?.[0]?.text || text;
  } catch(e){ return text; }
}

// ‚îÄ‚îÄ TEXTAREA WITH MIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TA({ value, onChange, placeholder, rows=4, label, apiKey, aiHint }){
  const voice = useVoice();
  const [loading, setLoading] = useState(false);
  const idRef = useRef(value);
  useEffect(()=>{ idRef.current = value; }, [value]);

  const toggleMic = () => {
    if (voice.active) { voice.stop(); return; }
    voice.start((transcript) => {
      onChange((idRef.current ? idRef.current + " " : "") + transcript);
    });
  };

  const runAI = async () => {
    if (!value.trim() || !apiKey) return;
    setLoading(true);
    const result = await aiProcess(value, aiHint || "Correct grammar, spelling and formatting for a South African medical report. Return only the corrected text.");
    onChange(result);
    setLoading(false);
  };

  return (
    <div className="fld">
      {label && <label>{label}</label>}
      <div className="ta-wrap">
        <textarea rows={rows} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder}/>
        <div className="ta-actions">
          <button className={`mic-btn ${voice.active?"recording":"idle"}`} onClick={toggleMic} title={voice.active?"Stop recording":"Start recording"}>
            {voice.active ? "‚èπ" : "üé§"}
          </button>
          {apiKey && (
            <button className="ai-btn" onClick={runAI} disabled={loading} title="AI: Grammar & formatting">
              {loading ? <span className="spin"/> : "‚ú®"}
            </button>
          )}
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ CHAPTER COMPONENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

// CH 0: Demographics
function Ch0({ r, setR }){
  const f = (k) => e => setR(p => ({ ...p, [k]: e.target.value }));
  return (
    <>
      <div className="card">
        <div className="card-title">PRACTICE DETAILS</div>
        <div className="fld-row">
          <div className="fld"><label>DOCTOR NAME</label><input value={r.drName} onChange={f("drName")} placeholder="Dr Sayed M Mia"/></div>
          <div className="fld"><label>QUALIFICATIONS</label><input value={r.quals} onChange={f("quals")} placeholder="FC Ortho (SA)"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>OUR REFERENCE</label><input value={r.ourRef} onChange={f("ourRef")} placeholder="RGML/SMM/szb/26453"/></div>
          <div className="fld"><label>ATTORNEY REFERENCE</label><input value={r.attRef} onChange={f("attRef")} placeholder="TIMOTHY/MS_BURO"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>INSTRUCTING ATTORNEY</label><input value={r.attorney} onChange={f("attorney")} placeholder="David Rossouw Attorneys"/></div>
          <div className="fld"><label>ATTORNEY CONTACT</label><input value={r.attContact} onChange={f("attContact")} placeholder="041 030 0107"/></div>
        </div>
      </div>
      <div className="card">
        <div className="card-title">PATIENT DETAILS</div>
        <div className="fld"><label>FULL NAME</label><input value={r.patientName} onChange={f("patientName")} placeholder="MOHAMUD SAID BURO"/></div>
        <div className="fld-row">
          <div className="fld"><label>ID / REF NUMBER</label><input value={r.refNum} onChange={f("refNum")} placeholder="ECZSOM01030209"/></div>
          <div className="fld"><label>GENDER</label>
            <select value={r.gender} onChange={f("gender")}>
              <option value="">Select...</option>
              <option>Male</option><option>Female</option><option>Other</option>
            </select>
          </div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>DATE OF BIRTH</label><input type="date" value={r.dob} onChange={f("dob")}/></div>
          <div className="fld"><label>CURRENT AGE</label><input value={r.age} onChange={f("age")} placeholder="47"/></div>
        </div>
        <div className="fld"><label>RESIDENTIAL ADDRESS</label><input value={r.address} onChange={f("address")} placeholder="182 Durban Road, Korsten, Gqeberha, 6001"/></div>
        <div className="fld"><label>CONTACT NUMBER</label><input value={r.contact} onChange={f("contact")} placeholder="069 899 3104"/></div>
      </div>
      <div className="card">
        <div className="card-title">ACCIDENT & EXAMINATION</div>
        <div className="fld-row">
          <div className="fld"><label>DATE OF INJURY</label><input type="date" value={r.doi} onChange={f("doi")}/></div>
          <div className="fld"><label>MECHANISM</label><input value={r.mechanism} onChange={f("mechanism")} placeholder="Motor Vehicle Accident"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>PRE-ACCIDENT OCCUPATION</label><input value={r.preOccupation} onChange={f("preOccupation")}/></div>
          <div className="fld"><label>POST-ACCIDENT OCCUPATION</label><input value={r.postOccupation} onChange={f("postOccupation")}/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>DATE OF EXAMINATION</label><input type="date" value={r.dateExam} onChange={f("dateExam")}/></div>
          <div className="fld"><label>PLACE OF EXAMINATION</label><input value={r.placeExam} onChange={f("placeExam")}/></div>
        </div>
      </div>
    </>
  );
}

// CH 1: Documents Perused
function Ch1({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">DOCUMENTS PERUSED</div>
      <p style={{fontSize:10,color:"var(--sm)",marginBottom:10}}>List documents in order (one per line or dictate).</p>
      <TA value={r.ch1} onChange={v=>setR(p=>({...p,ch1:v}))}
        rows={8} apiKey={apiKey}
        placeholder={"1. Instruction Letter\n2. Refugee Status of Client\n3. Accident Report\n4. Ambulance Voucher\n5. Hospital Records\n6. Patient Questionnaire"}/>
    </div>
  );
}

// CH 2: History
function Ch2({ r, setR, apiKey }){
  const fOcc = (k) => e => setR(p=>({...p,[k]:e.target.value}));
  return (
    <>
      <div className="card">
        <div className="card-title">2.1 OCCUPATIONAL HISTORY</div>
        <div className="fld-row">
          <div className="fld"><label>HIGHEST GRADE PASSED</label><input value={r.ch2grade||""} onChange={fOcc("ch2grade")} placeholder="Grade 7"/></div>
          <div className="fld"><label>TERTIARY EDUCATION</label><input value={r.ch2tertiary||""} onChange={fOcc("ch2tertiary")} placeholder="None"/></div>
        </div>
        <TA label="PRE-ACCIDENT OCCUPATION (detail)" value={r.ch2occ} onChange={v=>setR(p=>({...p,ch2occ:v}))}
          rows={4} apiKey={apiKey}
          placeholder="At the time of the accident, the patient was employed as..."/>
        <TA label="POST-ACCIDENT OCCUPATION (detail)" value={r.ch2postOcc||""} onChange={v=>setR(p=>({...p,ch2postOcc:v}))}
          rows={3} apiKey={apiKey}
          placeholder="Following the accident, the patient..."/>
      </div>
      <div className="card">
        <div className="card-title">2.2 PAST MEDICAL & SURGICAL HISTORY</div>
        <div className="fld-row">
          <div className="fld"><label>PREVIOUS INJURIES</label><input value={r.ch2injuries||""} onChange={fOcc("ch2injuries")} placeholder="None reported"/></div>
          <div className="fld"><label>SURGICAL HISTORY</label><input value={r.ch2surgery||""} onChange={fOcc("ch2surgery")} placeholder="None reported"/></div>
        </div>
        <div className="fld-row">
          <div className="fld"><label>MEDICAL HISTORY</label><input value={r.ch2medical||""} onChange={fOcc("ch2medical")} placeholder="None reported"/></div>
          <div className="fld"><label>CHRONIC MEDICATION</label><input value={r.ch2meds||""} onChange={fOcc("ch2meds")} placeholder="None reported"/></div>
        </div>
        <TA label="ADDITIONAL NOTES" value={r.ch2pmsx} onChange={v=>setR(p=>({...p,ch2pmsx:v}))}
          rows={3} apiKey={apiKey} placeholder="Additional medical history details..."/>
      </div>
    </>
  );
}

// CH 3: Hospital Records
function Ch3({ r, setR, apiKey }){
  const updatePrompt = (letter, val) => {
    setR(p=>({...p, ch3prompts:{...p.ch3prompts, [letter]:val}}));
  };
  return (
    <>
      <div className="card">
        <div className="card-title">GUIDED HOSPITAL RECORD PROMPTS</div>
        <p style={{fontSize:10,color:"var(--sm)",marginBottom:12}}>
          Dictate or type each section following the prompts below. Use the mic button for voice input.
        </p>
        {CH3_PROMPTS.map(p=>(
          <div key={p.letter} style={{marginBottom:14}}>
            <div className="prompt-letter">{p.letter.toUpperCase()}.</div>
            <div className="prompt-text" style={{marginBottom:6,fontSize:10,color:"var(--sm)"}}>{p.text}</div>
            <TA value={r.ch3prompts?.[p.letter]||""}
              onChange={v=>updatePrompt(p.letter,v)}
              rows={3} apiKey={apiKey}
              placeholder={`Dictate section (${p.letter})...`}/>
          </div>
        ))}
      </div>
      <div className="card">
        <div className="card-title">3.2 POST-TRAUMA FOLLOW-UP</div>
        <TA value={r.ch3||""} onChange={v=>setR(p=>({...p,ch3:v}))}
          rows={5} apiKey={apiKey}
          placeholder="The patient attended multiple follow-up appointments for..."/>
      </div>
    </>
  );
}

// CH 4: Injuries Sustained
function Ch4({ r, setR }){
  const [newInj, setNewInj] = useState("");
  const addInj = () => {
    if (!newInj.trim()) return;
    setR(p=>({...p, ch4injuries:[...(p.ch4injuries||[]), newInj.trim()]}));
    setNewInj("");
  };
  const removeInj = (i) => {
    setR(p=>({...p, ch4injuries:p.ch4injuries.filter((_,idx)=>idx!==i)}));
  };
  return (
    <div className="card">
      <div className="card-title">INJURIES SUSTAINED</div>
      <p style={{fontSize:10,color:"var(--sm)",marginBottom:10}}>These are extracted from the hospital records and listed in point form.</p>
      <ul className="inj-list" style={{marginBottom:14}}>
        {(r.ch4injuries||[]).map((inj,i)=>(
          <li key={i} className="inj-item">
            <span className="inj-dot"/>
            <span style={{flex:1,fontSize:11}}>{inj}</span>
            <button className="btn btn-ghost btn-sm" onClick={()=>removeInj(i)}>‚úï</button>
          </li>
        ))}
        {!(r.ch4injuries||[]).length && (
          <li style={{color:"var(--sm)",fontSize:10,padding:"8px 0"}}>No injuries added yet. Type below and press Add.</li>
        )}
      </ul>
      <div style={{display:"flex",gap:8}}>
        <input style={{flex:1,background:"var(--s2)",border:"1px solid var(--bd)",borderRadius:5,color:"var(--tx)",padding:"7px 10px",fontSize:11,outline:"none"}}
          value={newInj} onChange={e=>setNewInj(e.target.value)}
          onKeyDown={e=>e.key==="Enter"&&addInj()}
          placeholder="e.g. Right foot fractures of distal metatarsal bones"/>
        <button className="btn btn-ac" onClick={addInj}>Add</button>
      </div>
    </div>
  );
}

// CH 5: Current Complaints
function Ch5({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">CURRENT COMPLAINTS</div>
      <TA value={r.ch5} onChange={v=>setR(p=>({...p,ch5:v}))}
        rows={10} apiKey={apiKey}
        placeholder="Pre-accident symptoms: The patient reports no history of injury...\n\nCurrent complaints: According to the patient he experiences..."
        aiHint="Format this as a South African medico-legal report section for Current Complaints. Improve grammar and professional medical language. Return only the formatted text."/>
    </div>
  );
}

// CH 6: Clinical Evaluation
function Ch6({ r, setR, apiKey }){
  const [selRegion, setSelRegion] = useState(null);
  const updateMsk = (region, field, val) => {
    setR(p=>({...p, ch6msk:{...p.ch6msk, [region]:{...(p.ch6msk?.[region]||{}), [field]:val}}}));
  };
  const addRegion = (rg) => {
    setR(p=>({...p, examRegions:{...p.examRegions, [rg]:true}}));
    setSelRegion(rg);
  };
  const removeRegion = (rg) => {
    const nr={...r.examRegions}; delete nr[rg];
    setR(p=>({...p, examRegions:nr}));
    if (selRegion===rg) setSelRegion(null);
  };
  const activeRegions = Object.keys(r.examRegions||{}).filter(k=>r.examRegions[k]);

  return (
    <>
      <div className="card">
        <div className="card-title">6.1 GENERAL EXAMINATION</div>
        <TA value={r.ch6general||""} onChange={v=>setR(p=>({...p,ch6general:v}))}
          rows={5} apiKey={apiKey}
          placeholder={"Gait: ...\nGeneral impression: Well-kempt.\nAssistive devices: None.\nHome language: ...\nDexterity: Right-handed."}/>
      </div>
      <div className="card">
        <div className="card-title">6.2 MUSCULOSKELETAL EXAMINATION</div>
        <div style={{display:"flex",gap:12,marginBottom:14}}>
          <div style={{flex:"0 0 180px"}}>
            <div style={{fontSize:8,color:"var(--sm)",letterSpacing:"1px",marginBottom:6}}>SELECT REGION</div>
            {Object.keys(EXAM_REGIONS).map(rg=>(
              <button key={rg} className={`region-btn${activeRegions.includes(rg)?" sel":""}`}
                onClick={()=>activeRegions.includes(rg)?setSelRegion(rg):addRegion(rg)}>
                {rg}
              </button>
            ))}
          </div>
          <div style={{flex:1,minWidth:0}}>
            {selRegion ? (
              <>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10}}>
                  <div style={{fontSize:11,fontWeight:700,color:"var(--ac)"}}>{selRegion}</div>
                  <button className="btn btn-ghost btn-sm" onClick={()=>removeRegion(selRegion)}>Remove Region</button>
                </div>
                {EXAM_REGIONS[selRegion].map(field=>(
                  <TA key={field} label={field.toUpperCase()}
                    value={r.ch6msk?.[selRegion]?.[field]||""}
                    onChange={v=>updateMsk(selRegion,field,v)}
                    rows={2} apiKey={apiKey}/>
                ))}
              </>
            ) : (
              <div className="empty" style={{padding:"30px 20px"}}>
                <div style={{fontSize:24,marginBottom:8}}>ü¶¥</div>
                <div style={{fontSize:10,color:"var(--sm)"}}>Select a region from the left to begin examination prompts.</div>
              </div>
            )}
          </div>
        </div>
      </div>
      <div className="card">
        <div className="card-title">6.3 EVIDENCE OF INJURY & SPECIAL INVESTIGATIONS</div>
        <div className="fld">
          <label>6.3.1 SCARRING / DISFIGUREMENT / DEFORMITY</label>
          <p style={{fontSize:9,color:"var(--sm)",marginBottom:8}}>Capture photos using your device camera (use the camera icon on mobile/tablet).</p>
          <TA value={r.ch6scarring||""} onChange={v=>setR(p=>({...p,ch6scarring:v}))}
            rows={3} apiKey={apiKey} placeholder="Description of scarring, deformity, or disfigurement..."/>
        </div>
        <div className="fld">
          <label>6.3.2 RADIOLOGICAL EXAMINATION</label>
          <p style={{fontSize:9,color:"var(--sm)",marginBottom:8}}>Upload X-ray images and paste the radiology report below.</p>
          <TA value={r.ch6radiology||""} onChange={v=>setR(p=>({...p,ch6radiology:v}))}
            rows={6} apiKey={apiKey}
            placeholder={"Exam Date: ...\nX-RAY [REGION]\nBones: ...\nSoft tissue: ...\nOther: ..."}/>
        </div>
      </div>
    </>
  );
}

// CH 7: Diagnosis
function Ch7({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">DIAGNOSIS</div>
      <p style={{fontSize:10,color:"var(--sm)",marginBottom:10}}>
        Following thorough review of records, patient interview, clinical examination and special investigations:
      </p>
      <TA value={r.ch7} onChange={v=>setR(p=>({...p,ch7:v}))}
        rows={10} apiKey={apiKey}
        placeholder={"1. Soft tissue injury of the right leg treated conservatively.\n2. Right foot fractures resulting in:\n   a. Pain and swelling...\n   b. Tender bony deformity...\n   c. Painful and restricted range of motion..."}
        aiHint="Format this diagnosis section for a South African orthopaedic medico-legal report. Use numbered and lettered lists. Correct grammar and medical terminology. Return only the formatted text."/>
    </div>
  );
}

// CH 8: Further Management
function Ch8({ r, setR, apiKey }){
  return (
    <>
      <div className="card">
        <div className="card-title">8.1 ORTHOPAEDIC TREATMENT</div>
        <TA value={r.ch8ortho} onChange={v=>setR(p=>({...p,ch8ortho:v}))}
          rows={8} apiKey={apiKey}
          placeholder={"Right foot and ankle:\na) Referral to a podiatrist for specialized footwear.\nb) Conservative treatment with NSAIDs and analgesics at approx. R500/month.\nc) Physiotherapy at R600/session.\nd) Occupational therapy at R600/session."}/>
      </div>
      <div className="card">
        <div className="card-title">8.2 REFERRALS</div>
        <TA value={r.ch8ref} onChange={v=>setR(p=>({...p,ch8ref:v}))}
          rows={5} apiKey={apiKey}
          placeholder={"After reviewing patient records and conducting a thorough evaluation, I advise the patient be assessed by:\n1. Podiatrist\n2. Physiotherapist\n3. Occupational Therapist\n4. Industrial Psychologist"}/>
      </div>
      <div className="card">
        <div className="card-title">8.3 BURDEN OF TREATMENT</div>
        <div style={{fontSize:10,color:"var(--sm)",lineHeight:1.6}}>
          <p>Standard paragraph ‚Äî included automatically in the report:</p>
          <div style={{background:"var(--s2)",padding:10,borderRadius:5,marginTop:8,fontSize:10,color:"var(--tx)"}}>
            Side effects from regular use of NSAIDs and analgesics include but are not limited to allergic reactions, peptic ulcer disease, heartburn, gastritis, kidney and liver damage, excessive bleeding, heart problems, and toxicity. Some of these drugs can cause impaired concentration, anxiety, sleepiness, and breathing abnormalities. Careful monitoring of the use of these drugs is essential as one can become dependent on them and/or suffer harmful side effects.
          </div>
        </div>
      </div>
      <div className="card">
        <div className="card-title">8.4 ADDITIONAL EXPENSES</div>
        <div style={{fontSize:10,color:"var(--sm)",lineHeight:1.6}}>
          <div style={{background:"var(--s2)",padding:10,borderRadius:5,fontSize:10,color:"var(--tx)"}}>
            Other specialist consultation rates, consultation frequency, and further treatment costs are to be determined by the relevant specialist. Transportation costs for treatment are to be determined by the Occupational Therapist. Medical inflation rates need to be taken into consideration as determined annually.
          </div>
        </div>
      </div>
    </>
  );
}

// CH 9: Disability & Impairment
function Ch9({ r, setR, apiKey }){
  const setAdl = (type, activity, val) => {
    const k = type==="basic"?"adlBasic":"adlAdv";
    setR(p=>({...p, [k]:{...p[k], [activity]:val}}));
  };
  const updateWpi = (i, field, val) => {
    const rows = [...(r.wpiRows||[{ region:"",impairment:"",reference:"",wpi:"" }])];
    rows[i] = {...rows[i], [field]:val};
    setR(p=>({...p, wpiRows:rows}));
  };
  const addWpiRow = () => {
    setR(p=>({...p, wpiRows:[...(p.wpiRows||[]), {region:"",impairment:"",reference:"",wpi:""}]}));
  };
  const removeWpiRow = (i) => {
    setR(p=>({...p, wpiRows:p.wpiRows.filter((_,idx)=>idx!==i)}));
  };

  const renderAdl = (items, opts, type) => (
    <table className="adl-tbl">
      <thead>
        <tr>
          <th style={{width:"35%"}}>ACTIVITY</th>
          {opts.map(o=><th key={o} style={{textAlign:"center"}}>{o}</th>)}
        </tr>
      </thead>
      <tbody>
        {items.map(act=>(
          <tr key={act}>
            <td style={{fontSize:10}}>{act}</td>
            {opts.map(opt=>(
              <td key={opt}>
                <div className="adl-radio">
                  <label>
                    <input type="radio" name={`${type}_${act}`}
                      value={opt} checked={(r[type==="basic"?"adlBasic":"adlAdv"]?.[act]||"")=== opt}
                      onChange={()=>setAdl(type,act,opt)}/>
                  </label>
                </div>
              </td>
            ))}
          </tr>
        ))}
      </tbody>
    </table>
  );

  return (
    <>
      <div className="card">
        <div className="card-title">9.1 ACTIVITIES OF DAILY LIVING ‚Äî AS REPORTED BY THE PATIENT</div>
        <div style={{marginBottom:16}}>
          <div style={{fontSize:10,fontWeight:700,color:"var(--tx)",marginBottom:8}}>Basic ADL</div>
          {renderAdl(ADL_BASIC, ADL_OPTS_B, "basic")}
        </div>
        <div>
          <div style={{fontSize:10,fontWeight:700,color:"var(--tx)",marginBottom:8}}>Advanced ADL</div>
          {renderAdl(ADL_ADV, ADL_OPTS_A, "advanced")}
        </div>
      </div>
      <div className="card">
        <div className="card-title">9.2 OCCUPATIONAL EFFECTS AND LIMITATIONS</div>
        <TA value={r.ch9occ||""} onChange={v=>setR(p=>({...p,ch9occ:v}))}
          rows={8} apiKey={apiKey}
          placeholder={"The patient was employed as a general worker at the time of the accident.\nAccording to the patient his recuperation period was approximately...\n..."}/>
      </div>
      <div className="card">
        <div className="card-title">9.3 NARRATIVE TEST ‚Äî MANUAL EDIT IN FINAL REPORT</div>
        <div style={{fontSize:10,color:"var(--sm)",lineHeight:1.6,background:"var(--s2)",padding:12,borderRadius:5}}>
          <strong style={{color:"var(--gd)"}}>‚ö† This section is kept for manual editing in the final report.</strong><br/>
          The standard RAF Amendment Regulations Narrative Test text will be included automatically. Review and edit in the exported document.
        </div>
      </div>
      <div className="card">
        <div className="card-title">9.5 WHOLE PERSON IMPAIRMENT (WPI)</div>
        <table className="rom-tbl" style={{marginBottom:10}}>
          <thead>
            <tr>
              <th>REGION</th><th>IMPAIRMENT DESCRIPTION</th><th>REFERENCE</th><th>WPI %</th><th></th>
            </tr>
          </thead>
          <tbody>
            {(r.wpiRows||[{region:"",impairment:"",reference:"",wpi:""}]).map((row,i)=>(
              <tr key={i}>
                <td><input value={row.region} onChange={e=>updateWpi(i,"region",e.target.value)} placeholder="Lower Extremities"/></td>
                <td><input value={row.impairment} onChange={e=>updateWpi(i,"impairment",e.target.value)} placeholder="Right foot fracture..."/></td>
                <td><input value={row.reference} onChange={e=>updateWpi(i,"reference",e.target.value)} placeholder="P501-505, T16-2"/></td>
                <td><input value={row.wpi} onChange={e=>updateWpi(i,"wpi",e.target.value)} placeholder="8%" style={{maxWidth:60}}/></td>
                <td><button className="btn btn-ghost btn-sm" onClick={()=>removeWpiRow(i)}>‚úï</button></td>
              </tr>
            ))}
            <tr>
              <td colSpan={3} style={{fontWeight:700,fontSize:10}}>COMBINED WPI</td>
              <td style={{fontWeight:700,color:"var(--ac)"}}>
                {(r.wpiRows||[]).reduce((acc,row)=>acc+(parseFloat(row.wpi)||0),0).toFixed(0)}%
              </td>
              <td></td>
            </tr>
          </tbody>
        </table>
        <button className="btn btn-ghost btn-sm" onClick={addWpiRow}>+ Add Row</button>
      </div>
    </>
  );
}

// CH 10: Discussion
function Ch10({ r, setR, apiKey }){
  return (
    <div className="card">
      <div className="card-title">DISCUSSION</div>
      <TA value={r.ch10||""} onChange={v=>setR(p=>({...p,ch10:v}))}
        rows={12} apiKey={apiKey}
        placeholder={"Mr. [Name] was involved in a motor vehicle accident on [date].\nHe sustained [injuries] and continues to suffer from the sequelae of his injury.\nI believe that the injury he sustained has led to long-term impairment...\nTherefore, it is my professional opinion that his injuries are serious and qualify under 5.1 Serious long-term impairment or loss of a body function of the Narrative Test.\nHis Whole Person Impairment (WPI) is [X]% in accordance with the AMA Guides¬Æ 6th Edition.\nFrom an orthopaedic perspective, the injury will have no effect on his life expectancy."}
        aiHint="Write a professional Discussion section for a South African orthopaedic medico-legal RAF report based on the following notes. Correct grammar and use formal legal-medical language. Return only the text."/>
    </div>
  );
}

// ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function Preview({ r, onBack }){
  const fmt = (iso) => {
    if (!iso) return "";
    try { return new Date(iso).toLocaleDateString("en-ZA",{day:"2-digit",month:"long",year:"numeric"}); }
    catch { return iso; }
  };

  const adlTable = (title, items, opts, type) => {
    const key = type==="basic"?"adlBasic":"adlAdv";
    const rows = items.map(act=>`
      <tr>
        <td>${act}</td>
        ${opts.map(opt=>`<td style="text-align:center">${r[key]?.[act]===opt?"‚úì":""}</td>`).join("")}
      </tr>`).join("");
    return `<h3>${title}</h3>
      <table>
        <thead><tr><th>Activity</th>${opts.map(o=>`<th>${o}</th>`).join("")}</tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
  };

  const wpiRows = (r.wpiRows||[]).map(row=>`
    <tr><td>${row.region}</td><td>${row.impairment}</td><td>${row.reference}</td><td>${row.wpi}</td></tr>`).join("");
  const combinedWpi = (r.wpiRows||[]).reduce((acc,row)=>acc+(parseFloat(row.wpi)||0),0).toFixed(0);

  const prompts = CH3_PROMPTS.map(p=>{
    const val = r.ch3prompts?.[p.letter];
    return val ? `<p><strong>${p.letter.toUpperCase()}.</strong> ${val}</p>` : "";
  }).filter(Boolean).join("");

  const mskSections = Object.keys(r.examRegions||{}).filter(k=>r.examRegions[k]).map(rg=>{
    const fields = EXAM_REGIONS[rg];
    const content = fields.map(f=>{
      const val = r.ch6msk?.[rg]?.[f];
      return val ? `<p><strong>${f}:</strong> ${val}</p>` : "";
    }).filter(Boolean).join("");
    return content ? `<h3>${rg}</h3>${content}` : "";
  }).filter(Boolean).join("");

  const injuries = (r.ch4injuries||[]).map((inj,i)=>`<p>${i+1}. ${inj}</p>`).join("");

  const html = `
    <h1 style="text-align:center;font-size:16pt;">MEDICO-LEGAL REPORT</h1>
    <p style="text-align:center"><strong>Our Reference:</strong> ${r.ourRef||"[REF]"}</p>
    <p style="text-align:center"><strong>Attorney Reference:</strong> ${r.attRef||"[ATTREF]"}</p>
    <br/>
    <table>
      <tbody>
        <tr><td><strong>Patient Full Name:</strong></td><td>${r.patientName||""}</td></tr>
        <tr><td><strong>ID/Reference:</strong></td><td>${r.refNum||""}</td></tr>
        <tr><td><strong>Gender:</strong></td><td>${r.gender||""}</td></tr>
        <tr><td><strong>Date of Birth:</strong></td><td>${fmt(r.dob)}</td></tr>
        <tr><td><strong>Current Age:</strong></td><td>${r.age||""}</td></tr>
        <tr><td><strong>Residential Address:</strong></td><td>${r.address||""}</td></tr>
        <tr><td><strong>Contact Number:</strong></td><td>${r.contact||""}</td></tr>
        <tr><td><strong>Date of Injury:</strong></td><td>${fmt(r.doi)}</td></tr>
        <tr><td><strong>Mechanism of Injury:</strong></td><td>${r.mechanism||""}</td></tr>
        <tr><td><strong>Pre-Accident Occupation:</strong></td><td>${r.preOccupation||""}</td></tr>
        <tr><td><strong>Post-Accident Occupation:</strong></td><td>${r.postOccupation||""}</td></tr>
        <tr><td><strong>Date of Examination:</strong></td><td>${fmt(r.dateExam)}</td></tr>
        <tr><td><strong>Place of Examination:</strong></td><td>${r.placeExam||""}</td></tr>
        <tr><td><strong>Instructing Attorney:</strong></td><td>${r.attorney||""}</td></tr>
        <tr><td><strong>Attorney Contact:</strong></td><td>${r.attContact||""}</td></tr>
      </tbody>
    </table>

    <h2>1. DOCUMENTS PERUSED</h2>
    <div class="btext">${(r.ch1||"").replace(/\n/g,"<br/>")}</div>

    <h2>2. OCCUPATIONAL AND MEDICAL HISTORY</h2>
    <h3>2.1 Occupational History</h3>
    <p><strong>Highest grade passed:</strong> ${r.ch2grade||""}</p>
    <p><strong>Tertiary education:</strong> ${r.ch2tertiary||""}</p>
    <p><strong>Pre-accident occupation:</strong> ${(r.ch2occ||"").replace(/\n/g,"<br/>")}</p>
    <p><strong>Post-accident occupation:</strong> ${(r.ch2postOcc||"").replace(/\n/g,"<br/>")}</p>
    <h3>2.2 Past Medical and Surgical History</h3>
    <p><strong>Previous injuries:</strong> ${r.ch2injuries||""}</p>
    <p><strong>Surgical history:</strong> ${r.ch2surgery||""}</p>
    <p><strong>Medical history:</strong> ${r.ch2medical||""}</p>
    <p><strong>Chronic medication:</strong> ${r.ch2meds||""}</p>
    ${r.ch2pmsx ? `<p>${r.ch2pmsx.replace(/\n/g,"<br/>")}</p>` : ""}

    <h2>3. SUMMARY OF THE HOSPITAL RECORDS</h2>
    <h3>3.1 Management and Diagnosis</h3>
    ${prompts}
    <h3>3.2 Post-Trauma Follow-Up and Treatment</h3>
    <div class="btext">${(r.ch3||"").replace(/\n/g,"<br/>")}</div>

    <h2>4. INJURIES SUSTAINED</h2>
    ${injuries || "<p>No injuries listed.</p>"}

    <h2>5. CURRENT COMPLAINTS</h2>
    <div class="btext">${(r.ch5||"").replace(/\n/g,"<br/>")}</div>

    <h2>6. CLINICAL EVALUATION</h2>
    <h3>6.1 General Examination</h3>
    <div class="btext">${(r.ch6general||"").replace(/\n/g,"<br/>")}</div>
    <h3>6.2 Musculoskeletal Examination</h3>
    ${mskSections||"<p>No examination findings entered.</p>"}
    <h3>6.3 Evidence of Injury &amp; Special Investigations</h3>
    <h4>6.3.1 Scarring and Disfigurement/Deformity</h4>
    <div class="btext">${(r.ch6scarring||"").replace(/\n/g,"<br/>")}</div>
    <h4>6.3.2 Radiological Examination</h4>
    <div class="btext">${(r.ch6radiology||"").replace(/\n/g,"<br/>")}</div>

    <h2>7. DIAGNOSIS</h2>
    <p>Following a thorough review of the patient's available records, the patient interview, my clinical examination, and the special investigation findings, I diagnose the patient as follows:</p>
    <div class="btext">${(r.ch7||"").replace(/\n/g,"<br/>")}</div>

    <h2>8. FURTHER MANAGEMENT</h2>
    <h3>8.1 Orthopaedic Treatment</h3>
    <div class="btext">${(r.ch8ortho||"").replace(/\n/g,"<br/>")}</div>
    <h3>8.2 Referrals</h3>
    <div class="btext">${(r.ch8ref||"").replace(/\n/g,"<br/>")}</div>
    <h3>8.3 Burden of Treatment</h3>
    <p>Side effects from regular use of NSAIDs and analgesics include but are not limited to allergic reactions, peptic ulcer disease, heartburn, gastritis, kidney and liver damage, excessive bleeding, heart problems, and toxicity. Some of these drugs can cause impaired concentration, anxiety, sleepiness, and breathing abnormalities. Careful monitoring of the use of these drugs is essential as one can become dependent on them and/or suffer harmful side effects. Additionally, the burden of cost, drug dependence, regional availability of medication, and compliance of treatment could become a stressor in the patient's life.</p>
    <h3>8.4 Additional Expenses</h3>
    <p>Other specialist consultation rates, consultation frequency, and further treatment costs are to be determined by the relevant specialist. Transportation costs for treatment are to be determined by the Occupational Therapist. Medical inflation rates need to be taken into consideration as determined annually.</p>

    <h2>9. DISABILITY &amp; IMPAIRMENT</h2>
    <h3>9.1 Activities of Daily Living ‚Äî As Reported by the Patient</h3>
    ${adlTable("Basic Activities of Daily Living", ADL_BASIC, ADL_OPTS_B, "basic")}
    ${adlTable("Advanced Activities of Daily Living", ADL_ADV, ADL_OPTS_A, "advanced")}
    <h3>9.2 Occupational Effects and Limitations</h3>
    <div class="btext">${(r.ch9occ||"").replace(/\n/g,"<br/>")}</div>
    <h3>9.3 Applying the Narrative Test</h3>
    <p>The Road Accident Fund (RAF) Amendment Regulations of 2008 prescribes the use of the Narrative Test as a medical instrument to be used to determine the seriousness of an individual's injuries if the Whole Person Impairment (WPI) rating is less than 30% in accordance with the American Medical Association (AMA) Guides to the Evaluation of Permanent Impairment, and if the medical practitioner regards the injuries as serious.</p>
    <p>In accordance with the RAF4 Serious Injury Assessment Report the following criteria were considered:</p>
    <p><strong>5.1 Serious long-term impairment or loss of a body function.</strong><br/>
    <strong>5.2 Permanent serious disfigurement.</strong><br/>
    <strong>5.3 Severe long-term mental or severe long-term behavioural disturbance or disorder.</strong><br/>
    <strong>5.4 Loss of a foetus.</strong></p>
    <h3>9.5 Whole Person Impairment</h3>
    <p>Using the AMA Guides¬Æ to the Evaluation of Permanent Impairment, 6th Edition:</p>
    <table>
      <thead><tr><th>Region</th><th>Impairment</th><th>Reference</th><th>WPI</th></tr></thead>
      <tbody>
        ${wpiRows}
        <tr><td colspan="3"><strong>Combined WPI</strong></td><td><strong>${combinedWpi}%</strong></td></tr>
      </tbody>
    </table>

    <h2>10. DISCUSSION</h2>
    <div class="btext">${(r.ch10||"").replace(/\n/g,"<br/>")}</div>

    <div style="margin-top:60px;padding-top:20px;border-top:1px solid #ccc;text-align:left">
      <p>________________________________</p>
      <p><strong>${r.drName||"[PRACTITIONER NAME]"}</strong></p>
      <p><em>${r.quals||"[QUALIFICATIONS]"}</em></p>
      <p>Orthopaedic Surgeon</p>
      <p style="font-size:9pt;margin-top:12px;color:#666">
        VALIDITY: This report will remain valid for use in a court of law for a period of 2 (two) years from the date of the first consultation.
      </p>
    </div>
  `;

  const copyText = () => {
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    navigator.clipboard.writeText(tmp.textContent||tmp.innerText||"");
  };

  const exportDoc = () => {
    const full = `<!DOCTYPE html><html><head><meta charset="UTF-8">
      <style>
        body{font-family:'Times New Roman',serif;font-size:11pt;line-height:1.6;margin:2cm;}
        h1{font-size:14pt;text-align:center;} h2{font-size:11pt;border-bottom:1px solid #ccc;padding-bottom:3px;}
        h3{font-size:10pt;} table{width:100%;border-collapse:collapse;margin:10px 0;}
        th,td{border:1px solid #ccc;padding:4px 8px;font-size:9.5pt;}
        th{background:#f0f0f0;}
      </style></head><body>${html}</body></html>`;
    const blob = new Blob([full], {type:"application/msword"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `MediSync_${(r.patientName||"Report").replace(/\s+/g,"_")}.doc`;
    a.click();
  };

  return (
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <div className="ch-hdr no-print">
        <div>
          <div className="ch-title">REPORT PREVIEW</div>
          <div className="ch-sub">Read-only preview ‚Äî export to edit</div>
        </div>
        <button className="btn btn-ghost" onClick={onBack}>‚Üê Back to Editor</button>
      </div>
      <div className="prev-wrap">
        <div className="prev-page" dangerouslySetInnerHTML={{__html:html}}/>
      </div>
      <div className="prev-fabs no-print">
        <button className="fab" style={{background:"#7c3aed"}} onClick={copyText} title="Copy text">üìã</button>
        <button className="fab" style={{background:"#3d7eff"}} onClick={exportDoc} title="Export .doc">‚¨á</button>
        <button className="fab" style={{background:"#111"}} onClick={()=>window.print()} title="Print">üñ®</button>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ MAIN APP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App(){
  const [reports, setReports] = useState(() => DB.load());
  const [activeId, setActiveId] = useState(null);
  const [chapter, setChapter] = useState(0);
  const [view, setView] = useState("list"); // list | editor | preview
  const [sbOpen, setSbOpen] = useState(true);
  const [toast, setToast] = useState(null);
  const [saving, setSaving] = useState(false);
  const [apiKey, setApiKey] = useState(() => localStorage.getItem("ms_apikey")||"");
  const [showApiModal, setShowApiModal] = useState(false);
  const [query, setQuery] = useState("");

  const activeReport = reports.find(r=>r.id===activeId);

  // Auto-save
  useEffect(() => {
    if (!reports.length) return;
    setSaving(true);
    DB.save(reports);
    const t = setTimeout(()=>setSaving(false), 800);
    return ()=>clearTimeout(t);
  }, [reports]);

  const showToast = (msg) => {
    setToast(msg);
    setTimeout(()=>setToast(null), 2500);
  };

  const updateReport = (updater) => {
    setReports(prev => prev.map(r => r.id===activeId ? {...updater(r), updated:new Date().toISOString()} : r));
  };

  const createReport = () => {
    const r = newReport();
    setReports(p=>[r,...p]);
    setActiveId(r.id);
    setChapter(0);
    setView("editor");
  };

  const deleteReport = (id) => {
    if (!confirm("Delete this report? This cannot be undone.")) return;
    setReports(p=>p.filter(r=>r.id!==id));
    if (activeId===id) { setActiveId(null); setView("list"); }
  };

  const openReport = (id) => {
    setActiveId(id);
    setChapter(0);
    setView("editor");
  };

  const saveApiKey = (key) => {
    localStorage.setItem("ms_apikey", key);
    setApiKey(key);
    setShowApiModal(false);
    showToast("API key saved");
  };

  // Progress calculation
  const calcProgress = (r) => {
    const fields = [r.patientName,r.doi,r.mechanism,r.ch1,r.ch2occ,r.ch3,r.ch5,r.ch6general,r.ch7,r.ch8ortho,r.ch10];
    const filled = fields.filter(f=>f&&String(f).trim().length>0).length;
    return Math.round((filled/fields.length)*100);
  };

  const filteredReports = reports.filter(r => {
    if (!query) return true;
    const q = query.toLowerCase();
    return (r.patientName||"").toLowerCase().includes(q) ||
           (r.ourRef||"").toLowerCase().includes(q) ||
           (r.attRef||"").toLowerCase().includes(q);
  });

  const renderChapter = () => {
    if (!activeReport) return null;
    const props = { r:activeReport, setR:updateReport, apiKey };
    switch(chapter){
      case 0: return <Ch0 {...props}/>;
      case 1: return <Ch1 {...props}/>;
      case 2: return <Ch2 {...props}/>;
      case 3: return <Ch3 {...props}/>;
      case 4: return <Ch4 {...props}/>;
      case 5: return <Ch5 {...props}/>;
      case 6: return <Ch6 {...props}/>;
      case 7: return <Ch7 {...props}/>;
      case 8: return <Ch8 {...props}/>;
      case 9: return <Ch9 {...props}/>;
      case 10: return <Ch10 {...props}/>;
      default: return null;
    }
  };

  // ‚îÄ‚îÄ API KEY MODAL
  if (showApiModal) return (
    <div className="modal-bg" onClick={()=>setShowApiModal(false)}>
      <div className="modal" onClick={e=>e.stopPropagation()}>
        <div className="modal-title">ANTHROPIC API KEY</div>
        <p style={{fontSize:10,color:"var(--sm)",marginBottom:12,lineHeight:1.5}}>
          Enter your Anthropic API key to enable AI-powered grammar correction and content enhancement.
          Your key is stored locally in the browser and never sent to any server other than Anthropic.
        </p>
        <ApiKeyForm current={apiKey} onSave={saveApiKey} onCancel={()=>setShowApiModal(false)}/>
      </div>
    </div>
  );

  // ‚îÄ‚îÄ PREVIEW VIEW
  if (view==="preview" && activeReport){
    return (
      <div className="app">
        <Preview r={activeReport} onBack={()=>setView("editor")}/>
        {toast && <div className="toast">{toast}</div>}
      </div>
    );
  }

  // ‚îÄ‚îÄ LIST VIEW
  if (view==="list"){
    return (
      <div className="app">
        <header className="hdr">
          <div className="hdr-l">
            <div className="hdr-icon">üî¨</div>
            <div>
              <div className="hdr-name">MediSync <span>Ortho</span></div>
              <div className="hdr-sub">MEDICO-LEGAL ENGINE</div>
            </div>
          </div>
          <div className="hdr-r">
            <button className="btn btn-ghost btn-sm" onClick={()=>setShowApiModal(true)}>
              {apiKey ? "‚úì AI Key" : "Set AI Key"}
            </button>
            <button className="btn btn-ac" onClick={createReport}>+ New Report</button>
          </div>
        </header>
        <div style={{flex:1,overflow:"hidden",display:"flex",flexDirection:"column",padding:24,maxWidth:700,margin:"0 auto",width:"100%"}}>
          <div style={{marginBottom:16}}>
            <input className="search-inp" placeholder="Search reports by name, reference..."
              value={query} onChange={e=>setQuery(e.target.value)} style={{width:"100%"}}/>
          </div>
          {filteredReports.length===0 ? (
            <div className="empty">
              <div className="empty-icon">üìã</div>
              <div className="empty-title">{reports.length?"No results":"No Reports Yet"}</div>
              <div className="empty-sub">
                {reports.length?"Try a different search term.":"Create your first medico-legal report to get started."}
              </div>
              {!reports.length && (
                <button className="btn btn-ac" style={{marginTop:20}} onClick={createReport}>+ Create Report</button>
              )}
            </div>
          ) : (
            <div style={{flex:1,overflowY:"auto"}}>
              {filteredReports.map(rpt=>{
                const prog = calcProgress(rpt);
                return (
                  <div key={rpt.id} className="rpt-card" onClick={()=>openReport(rpt.id)}>
                    <div className="rpt-icon">üìÑ</div>
                    <div className="rpt-meta">
                      <div className="rpt-name">{rpt.patientName||"Untitled Report"}</div>
                      <div className="rpt-date">
                        {rpt.ourRef&&`${rpt.ourRef} ¬∑ `}
                        {rpt.doi&&`DOI: ${rpt.doi} ¬∑ `}
                        Updated: {new Date(rpt.updated||rpt.created).toLocaleDateString("en-ZA")}
                      </div>
                      <div className="rpt-prog">{prog}% complete</div>
                      <div className="prog-bar"><div className="prog-fill" style={{width:`${prog}%`}}/></div>
                    </div>
                    <button className="btn btn-ghost btn-sm" onClick={e=>{e.stopPropagation();deleteReport(rpt.id);}}>üóë</button>
                  </div>
                );
              })}
            </div>
          )}
        </div>
        {toast && <div className="toast">{toast}</div>}
      </div>
    );
  }

  // ‚îÄ‚îÄ EDITOR VIEW
  return (
    <div className="app">
      <header className="hdr">
        <div className="hdr-l">
          <button className="btn btn-ghost btn-sm" style={{padding:"4px 8px"}} onClick={()=>setSbOpen(p=>!p)}>‚ò∞</button>
          <div className="hdr-icon">üî¨</div>
          <div>
            <div className="hdr-name">MediSync <span>Ortho</span></div>
            <div className="hdr-sub" style={{display:"flex",alignItems:"center",gap:4}}>
              <span className={`sdot${saving?" pulse":""}`}/>
              {saving?"SAVING‚Ä¶":"SAVED"}
            </div>
          </div>
        </div>
        <div className="hdr-r">
          <button className="btn btn-ghost btn-sm" onClick={()=>{setView("list");setActiveId(null);}}>‚Üê Reports</button>
          <button className="btn btn-ghost btn-sm" onClick={()=>setShowApiModal(true)}>
            {apiKey?"‚úì AI":"Set AI Key"}
          </button>
          <button className="btn btn-ac btn-sm" onClick={()=>setView("preview")}>Preview</button>
        </div>
      </header>

      <div className="body-wrap">
        {/* SIDEBAR */}
        <nav className={`sb${sbOpen?"":" closed"}`}>
          <div className="sb-head">
            <div className="sb-lbl">CHAPTERS</div>
            {activeReport && <div style={{fontSize:8,color:"var(--sm)",marginTop:2,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{activeReport.patientName||"New Report"}</div>}
          </div>
          <div className="sb-list">
            {CHAPTERS.map(ch=>{
              const done = ch.id===0 ? !!(activeReport?.patientName) :
                           ch.id===1 ? !!(activeReport?.ch1) :
                           ch.id===2 ? !!(activeReport?.ch2occ) :
                           ch.id===3 ? !!(activeReport?.ch3||Object.keys(activeReport?.ch3prompts||{}).length) :
                           ch.id===4 ? !!(activeReport?.ch4injuries?.length) :
                           ch.id===5 ? !!(activeReport?.ch5) :
                           ch.id===6 ? !!(activeReport?.ch6general) :
                           ch.id===7 ? !!(activeReport?.ch7) :
                           ch.id===8 ? !!(activeReport?.ch8ortho) :
                           ch.id===9 ? !!(activeReport?.ch9occ) :
                           ch.id===10? !!(activeReport?.ch10) : false;
              return (
                <button key={ch.id} className={`nb${chapter===ch.id?" on":""}`} onClick={()=>setChapter(ch.id)}>
                  <span className="nb-num">{ch.id}.</span>
                  <span>{ch.short}</span>
                  {done && <span className="nb-dot"/>}
                </button>
              );
            })}
          </div>
        </nav>

        {/* MAIN */}
        <main className="main">
          <div className="ch-hdr">
            <div>
              <div className="ch-title">{CHAPTERS[chapter].title}</div>
              <div className="ch-sub">Chapter {chapter} of 10</div>
            </div>
            <div style={{display:"flex",gap:8,alignItems:"center"}}>
              {chapter>0&&<button className="btn btn-ghost btn-sm" onClick={()=>setChapter(p=>p-1)}>‚Üê Prev</button>}
              {chapter<10&&<button className="btn btn-ac btn-sm" onClick={()=>setChapter(p=>p+1)}>Next ‚Üí</button>}
            </div>
          </div>
          <div className="content">
            {activeReport ? renderChapter() : (
              <div className="empty">
                <div className="empty-icon">üìã</div>
                <div className="empty-title">No Report Selected</div>
                <div className="empty-sub">Go back and select or create a report.</div>
              </div>
            )}
          </div>
        </main>
      </div>

      {toast && <div className="toast">{toast}</div>}
    </div>
  );
}

// ‚îÄ‚îÄ API KEY FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ApiKeyForm({ current, onSave, onCancel }){
  const [val, setVal] = useState(current||"");
  return (
    <div>
      <div className="fld">
        <label>API KEY</label>
        <input type="password" value={val} onChange={e=>setVal(e.target.value)}
          placeholder="sk-ant-..." style={{fontFamily:"monospace"}}/>
      </div>
      <div style={{display:"flex",gap:8,marginTop:8}}>
        <button className="btn btn-ac" onClick={()=>onSave(val)}>Save Key</button>
        <button className="btn btn-ghost" onClick={onCancel}>Cancel</button>
        {current && <button className="btn btn-ghost" style={{color:"var(--rd)"}} onClick={()=>onSave("")}>Clear</button>}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ MOUNT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App/>);
</script>
</body>
</html>

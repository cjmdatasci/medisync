import React, { useState, useEffect, useRef, useCallback } from 'react';
import {
  Plus, FileText, Mic, MicOff, ChevronRight, ChevronLeft,
  Loader2, CheckCircle2, Clock, Stethoscope, Sparkles,
  Wand2, Lightbulb, Download, Printer, Copy, X, Menu,
  UserPlus, Table as TableIcon, Cloud, RefreshCw
} from 'lucide-react';
import { initializeApp, getApps } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc } from 'firebase/firestore';

// ── CONFIG ─────────────────────────────────────────────────────────────────
const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'medisync-ortho-v2';
const FB_CFG = (() => {
  try { return typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null; }
  catch { return null; }
})();

let db = null, auth = null;
if (FB_CFG && Object.keys(FB_CFG).length > 0) {
  try {
    const fbApp = getApps().length ? getApps()[0] : initializeApp(FB_CFG);
    auth = getAuth(fbApp);
    db = getFirestore(fbApp);
  } catch (e) { console.warn('Firebase init failed:', e); }
}

// ── AI CALL (Anthropic API via artifact proxy) ──────────────────────────────
async function callAI(system, user) {
  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1500,
        system,
        messages: [{ role: 'user', content: user }]
      })
    });
    const data = await resp.json();
    return data.content?.find(b => b.type === 'text')?.text || '';
  } catch { return ''; }
}

// ── CONSTANTS ──────────────────────────────────────────────────────────────
const CHAPTERS = [
  { id: 0, title: 'Cover Page / Demographics', type: 'form' },
  { id: 1, title: 'Ch 1: Documents Perused', type: 'dictation' },
  { id: 2, title: 'Ch 2: Occupational & Medical History', type: 'dictation' },
  {
    id: 3, title: 'Ch 3: Summary of Hospital Records', type: 'guided',
    steps: [
      'Mechanism and date of accident', 'EMS assessment on scene',
      'Transfer to hospital', 'Presentation to hospital',
      'Initial assessment findings', 'Investigations & treatment',
      'Diagnosis on admission', 'Admission & department transfer',
      'Definitive management', 'Post-op treatment & rehab',
      'Discharge & assistive devices', 'Follow-up & review'
    ]
  },
  { id: 4, title: 'Ch 4: Injuries Sustained', type: 'auto' },
  { id: 5, title: 'Ch 5: Current Complaints', type: 'dictation' },
  { id: 6, title: 'Ch 6: Clinical Evaluation', type: 'msk' },
  { id: 7, title: 'Ch 7: Diagnosis', type: 'dictation' },
  { id: 8, title: 'Ch 8: Further Treatment', type: 'dictation' },
  { id: 9, title: 'Ch 9: Disability & Impairment', type: 'adl' },
  { id: 10, title: 'Ch 10: Discussion', type: 'dictation' }
];

const MSK_REGIONS = [
  { name: 'Cervical Spine', prompts: ['Inspection', 'Palpation', 'ROM', 'Neurology', "Spurling's Test", 'Distraction Test'] },
  { name: 'Lumbar Spine', prompts: ['Inspection', 'Palpation', 'ROM', 'Neurology', 'SLR Test', 'Slump Test'] },
  { name: 'Shoulder', prompts: ['Inspection', 'Palpation', 'ROM', 'Power/Sensation/Reflexes', "Neer's Test", 'Hawkins Test', "Job's Test"] },
  { name: 'Elbow', prompts: ['Inspection', 'Palpation', 'ROM', 'Power/Sensation', 'Lateral Epicondyle', "Tinel's Sign"] },
  { name: 'Wrist & Hand', prompts: ['Inspection', 'Palpation', 'ROM', 'Grip Strength', "Finkelstein's Test", "Phalen's Test"] },
  { name: 'Hip', prompts: ['Inspection', 'Palpation', 'ROM', 'Neurology', 'FABER Test', 'Trendelenburg Sign'] },
  { name: 'Knee', prompts: ['Inspection', 'Palpation', 'ROM', 'Neurology', 'Lachman Test', "McMurray's Test", 'Valgus/Varus Stress'] },
  { name: 'Foot & Ankle', prompts: ['Inspection', 'Palpation', 'ROM (DF/PF/Inv/Ev)', 'Power', 'Sensation', 'Reflexes', 'Thompson Test'] }
];

const ADL_BASIC = ['Bowel control','Bladder control','Grooming','Toileting','Feeding','Chair to bed transfer','Indoor mobility','Dressing','Stairs','Bathing'];
const ADL_ADV   = ['Driving','Sexual function','Medical care','Money management','Writing/communication','Travelling','Shopping','Cooking','Housework','Moderate activities','Vigorous activities'];
const ADL_OPTS  = ['N/A','None','Mild','Mod','Sev'];

function emptyReport() {
  return {
    patientName: '', ref: `RGML/REF/${new Date().getFullYear()}/`, doi: '',
    gender: 'Male', dob: '', age: '', address: '', contact: '',
    preOcc: '', postOcc: '', doe: '', poe: 'RG Medlegal Rooms',
    atty: '', attyCon: '', drName: '', quals: '',
    createdAt: Date.now(), status: 'draft',
    chapters: CHAPTERS.map(c => ({ id: c.id, content: '' })),
    adl: { basic: {}, advanced: {} }
  };
}

// ── CSS ────────────────────────────────────────────────────────────────────
const CSS = `
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');
  :root {
    --bg:#0a0b0f;--s1:#111318;--s2:#17191f;--bd:#1e2129;
    --ac:#00e5b4;--ac2:#4f7cff;--gd:#f0a500;--rd:#ff4d4d;
    --tx:#dce2f0;--mt:#4a5068;--pu:#a855f7;
  }
  *{box-sizing:border-box;margin:0;padding:0;}
  html,body,#root{height:100%;background:var(--bg);color:var(--tx);font-family:'IBM Plex Mono',monospace;}
  ::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px;}
  .app{display:flex;flex-direction:column;height:100vh;overflow:hidden;}
  /* HEADER */
  .hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;
    background:var(--s1);border-bottom:1px solid var(--bd);min-height:52px;flex-shrink:0;position:relative;z-index:60;}
  .hdr-logo{display:flex;align-items:center;gap:10px;}
  .hdr-icon{background:var(--ac2);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .hdr-title{font-size:12px;font-weight:700;letter-spacing:2px;color:var(--tx);}
  .hdr-title span{color:var(--ac);}
  .hdr-sync{font-size:8px;color:var(--mt);letter-spacing:1px;display:flex;align-items:center;gap:4px;margin-top:2px;}
  .sync-dot{width:5px;height:5px;border-radius:50%;}
  .sync-dot.active{background:var(--gd);animation:pulse .8s infinite;}
  .sync-dot.done{background:var(--ac);}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
  .hdr-btns{display:flex;gap:8px;}
  /* BODY */
  .body{display:flex;flex:1;overflow:hidden;}
  /* SIDEBAR */
  .sb{width:220px;min-width:220px;background:var(--s1);border-right:1px solid var(--bd);
    display:flex;flex-direction:column;overflow:hidden;transition:width .2s,min-width .2s;}
  .sb.closed{width:0;min-width:0;}
  .sb-head{padding:14px;border-bottom:1px solid var(--bd);white-space:nowrap;}
  .sb-label{font-size:8px;color:var(--ac);letter-spacing:3px;font-weight:700;}
  .sb-sub{font-size:9px;color:var(--mt);margin-top:2px;letter-spacing:1px;}
  .sb-list{flex:1;overflow-y:auto;padding:8px;}
  .nav-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:6px;
    cursor:pointer;font-size:9px;font-weight:700;letter-spacing:1px;color:var(--mt);
    border:1px solid transparent;transition:all .1s;margin-bottom:2px;white-space:nowrap;}
  .nav-item:hover{color:var(--tx);background:var(--s2);}
  .nav-item.on{color:var(--ac);border-color:var(--ac);background:rgba(0,229,180,.06);}
  .nav-num{font-size:7px;color:var(--mt);min-width:14px;font-weight:700;}
  /* MAIN */
  .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  .content{flex:1;overflow-y:auto;padding:20px 24px 160px;}
  /* CHAPTER HEADER */
  .ch-hdr{margin-bottom:20px;}
  .ch-num{font-size:8px;color:var(--ac);letter-spacing:3px;margin-bottom:4px;}
  .ch-title{font-size:20px;font-weight:700;color:var(--tx);letter-spacing:-0.5px;}
  .ch-bar{width:24px;height:2px;background:var(--ac);margin-top:6px;border-radius:1px;}
  /* CARDS */
  .card{background:var(--s1);border:1px solid var(--bd);border-radius:8px;padding:16px;margin-bottom:12px;}
  .card.accent{border-color:var(--ac2);background:rgba(79,124,255,.03);}
  .card.gold{border-color:var(--gd);background:rgba(240,165,0,.03);}
  .card.green{border-color:var(--ac);background:rgba(0,229,180,.03);}
  .card-title{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--tx);
    margin-bottom:12px;display:flex;align-items:center;gap:8px;}
  .badge{font-size:7px;font-weight:700;letter-spacing:2px;padding:2px 6px;border-radius:3px;}
  .badge-teal{background:rgba(0,229,180,.12);color:var(--ac);}
  .badge-gold{background:rgba(240,165,0,.12);color:var(--gd);}
  .badge-pu{background:rgba(168,85,247,.12);color:var(--pu);}
  .badge-rd{background:rgba(255,77,77,.12);color:var(--rd);}
  /* FORMS */
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .fld{margin-bottom:0;}
  label{font-size:8px;font-weight:700;letter-spacing:1.5px;color:var(--mt);
    display:block;margin-bottom:4px;text-transform:uppercase;}
  input,textarea,select{background:var(--s2);border:1px solid var(--bd);color:var(--tx);
    border-radius:6px;padding:8px 10px;font-family:'IBM Plex Mono',monospace;font-size:11px;
    width:100%;outline:none;transition:border-color .12s;resize:vertical;}
  input:focus,textarea:focus,select:focus{border-color:var(--ac);}
  textarea{min-height:60px;line-height:1.6;}
  textarea.big{min-height:200px;font-size:12px;line-height:1.7;}
  /* STEP BUTTONS */
  .steps{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;}
  .step-btn{padding:8px 10px;border-radius:6px;font-size:8px;font-weight:700;
    letter-spacing:1px;cursor:pointer;border:1px solid var(--bd);
    background:var(--s2);color:var(--mt);transition:all .1s;text-align:left;
    display:flex;align-items:center;justify-content:space-between;}
  .step-btn:hover{border-color:var(--ac2);color:var(--ac2);}
  .step-btn.on{border-color:var(--ac);background:rgba(0,229,180,.08);color:var(--ac);}
  /* MSK CHIPS */
  .chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
  .chip{padding:5px 10px;border-radius:20px;font-size:8px;font-weight:700;
    letter-spacing:1px;cursor:pointer;border:1px solid var(--bd);
    background:var(--s2);color:var(--mt);transition:all .1s;white-space:nowrap;}
  .chip:hover{border-color:var(--ac2);color:var(--ac2);}
  .chip.on{border-color:var(--ac);background:rgba(0,229,180,.08);color:var(--ac);}
  .chip.has{border-color:rgba(0,229,180,.3);}
  /* MSK PROMPTS */
  .msk-prompts{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:12px;}
  .prompt-btn{padding:7px 9px;border-radius:6px;font-size:8px;font-weight:700;
    letter-spacing:1px;cursor:pointer;border:1px solid var(--bd);
    background:var(--s2);color:var(--mt);transition:all .1s;text-align:left;}
  .prompt-btn:hover{border-color:var(--pu);color:var(--pu);}
  .prompt-btn.on{border-color:var(--pu);background:rgba(168,85,247,.08);color:var(--pu);}
  /* ADL TABLE */
  .adl-table{width:100%;border-collapse:collapse;}
  .adl-table th,.adl-table td{padding:7px 8px;border-bottom:1px solid var(--bd);font-size:9px;}
  .adl-table th{color:var(--mt);font-weight:700;letter-spacing:1px;text-transform:uppercase;
    background:var(--s2);}
  .adl-table td:first-child{color:var(--tx);font-weight:700;}
  .adl-table td{text-align:center;color:var(--mt);}
  /* BOTTOM BAR */
  .bot-bar{position:absolute;bottom:0;left:0;right:0;background:var(--s1);
    border-top:1px solid var(--bd);padding:10px 16px;z-index:50;}
  .bot-inner{display:flex;align-items:center;gap:10px;max-width:900px;margin:0 auto;}
  .dic-btn{display:flex;align-items:center;justify-content:center;gap:8px;flex:1;
    padding:12px;border-radius:8px;font-family:'IBM Plex Mono',monospace;
    font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;border:none;
    transition:all .15s;}
  .dic-btn.idle{background:var(--ac2);color:#fff;box-shadow:0 2px 14px rgba(79,124,255,.35);}
  .dic-btn.idle:hover{filter:brightness(1.1);}
  .dic-btn.rec{background:var(--rd);color:#fff;animation:rec-pulse 1.4s infinite;}
  @keyframes rec-pulse{0%,100%{box-shadow:0 0 0 0 rgba(255,77,77,.5)}60%{box-shadow:0 0 0 10px rgba(255,77,77,0)}}
  .dic-btn.proc{background:var(--s2);color:var(--mt);cursor:not-allowed;}
  .nav-btn{display:flex;align-items:center;justify-content:center;
    padding:12px;border-radius:8px;border:1px solid var(--bd);
    background:var(--s2);color:var(--tx);cursor:pointer;transition:all .1s;}
  .nav-btn:hover{border-color:var(--ac);color:var(--ac);}
  .live-box{margin-top:8px;padding:10px 12px;background:rgba(255,77,77,.06);
    border:1px solid rgba(255,77,77,.2);border-radius:6px;
    font-size:10px;color:var(--rd);line-height:1.5;}
  .live-dot{display:inline-block;width:6px;height:6px;border-radius:50%;
    background:var(--rd);animation:blink .6s infinite;margin-right:6px;}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
  /* FOCUS CHIP */
  .focus-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
    border-radius:20px;font-size:8px;font-weight:700;letter-spacing:1px;
    background:rgba(0,229,180,.1);border:1px solid var(--ac);color:var(--ac);}
  /* BUTTONS */
  .btn{display:inline-flex;align-items:center;gap:6px;padding:7px 13px;
    border-radius:6px;font-family:'IBM Plex Mono',monospace;font-size:9px;font-weight:700;
    letter-spacing:1px;cursor:pointer;border:none;transition:all .1s;}
  .btn-teal{background:var(--ac);color:#0a0b0f;}.btn-teal:hover{filter:brightness(1.1);}
  .btn-ghost{background:var(--s2);color:var(--tx);border:1px solid var(--bd);}
  .btn-ghost:hover{border-color:var(--ac);color:var(--ac);}
  .btn-gold{background:rgba(240,165,0,.1);color:var(--gd);border:1px solid rgba(240,165,0,.2);}
  .btn-gold:hover{background:rgba(240,165,0,.18);}
  .btn-pu{background:rgba(168,85,247,.1);color:var(--pu);border:1px solid rgba(168,85,247,.2);}
  .btn-pu:hover{background:rgba(168,85,247,.18);}
  .btn-rd{background:rgba(255,77,77,.1);color:var(--rd);border:1px solid rgba(255,77,77,.2);}
  .btn:disabled{opacity:.4;cursor:not-allowed;}
  /* DASHBOARD */
  .dash{flex:1;overflow-y:auto;padding:24px;}
  .dash-head{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:24px;}
  .dash-title{font-size:24px;font-weight:700;letter-spacing:-1px;color:var(--tx);}
  .dash-sub{font-size:8px;color:var(--mt);letter-spacing:2px;margin-top:4px;}
  .report-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;}
  .new-card{background:rgba(79,124,255,.05);border:1px dashed var(--ac2);
    border-radius:8px;padding:20px;cursor:pointer;display:flex;align-items:center;
    justify-content:center;font-size:10px;font-weight:700;letter-spacing:2px;
    color:var(--ac2);min-height:100px;transition:all .1s;}
  .new-card:hover{background:rgba(79,124,255,.1);}
  .rpt-card{background:var(--s1);border:1px solid var(--bd);border-radius:8px;
    padding:16px;cursor:pointer;transition:all .12s;}
  .rpt-card:hover{border-color:var(--ac);transform:translateY(-1px);}
  .rpt-name{font-size:14px;font-weight:700;color:var(--tx);margin-bottom:4px;letter-spacing:-0.5px;}
  .rpt-ref{font-size:8px;color:var(--mt);letter-spacing:1px;}
  .rpt-foot{display:flex;align-items:center;justify-content:space-between;
    margin-top:10px;padding-top:10px;border-top:1px solid var(--bd);}
  .tag{font-size:7px;font-weight:700;letter-spacing:1px;padding:2px 8px;
    border-radius:3px;background:rgba(0,229,180,.08);color:var(--ac);}
  /* PREVIEW */
  .preview{flex:1;overflow-y:auto;background:#eee;padding:32px;}
  .preview-doc{max-width:760px;margin:0 auto;background:#fff;padding:60px;
    font-family:'Libre Baskerville',serif;font-size:10.5pt;line-height:1.7;color:#111;
    box-shadow:0 8px 48px rgba(0,0,0,.2);}
  .preview-doc h1{font-size:14pt;text-align:center;text-transform:uppercase;
    font-weight:700;margin-bottom:8px;}
  .preview-doc h2{font-size:11pt;text-decoration:underline;text-transform:uppercase;
    font-weight:700;margin:18px 0 6px;}
  .preview-doc h3{font-size:10.5pt;font-weight:700;margin:10px 0 4px;}
  .preview-doc p,.preview-doc div.body-text{margin:3px 0;}
  .preview-doc table{border-collapse:collapse;width:100%;margin:6px 0;}
  .preview-doc td,.preview-doc th{border:1px solid #aaa;padding:4px 7px;font-size:10pt;}
  .preview-doc th{background:#f0f0f0;}
  .preview-toolbar{position:sticky;top:0;background:rgba(17,19,24,.95);
    border-bottom:1px solid var(--bd);padding:8px 18px;display:flex;
    align-items:center;justify-content:space-between;z-index:50;}
  .preview-actions{position:fixed;bottom:20px;right:20px;display:flex;
    flex-direction:column;gap:8px;z-index:50;}
  .action-btn{width:48px;height:48px;border-radius:50%;border:none;cursor:pointer;
    display:flex;align-items:center;justify-content:center;transition:all .12s;
    box-shadow:0 4px 16px rgba(0,0,0,.3);}
  .action-btn:hover{transform:scale(1.1);}
  /* NOTIF */
  .notif{position:fixed;top:60px;left:50%;transform:translateX(-50%);
    background:var(--s1);border:1px solid var(--bd);border-radius:6px;
    padding:8px 16px;font-size:9px;font-weight:700;letter-spacing:1px;
    display:flex;align-items:center;gap:8px;z-index:999;
    box-shadow:0 8px 24px rgba(0,0,0,.4);}
  .notif.success{border-color:var(--ac);color:var(--ac);}
  .notif.error{border-color:var(--rd);color:var(--rd);}
  .notif.info{border-color:var(--ac2);color:var(--ac2);}
  /* OVERLAY */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);
    display:flex;align-items:center;justify-content:center;z-index:200;}
  .spinner-box{background:var(--s1);border:1px solid var(--bd);border-radius:8px;
    padding:32px;text-align:center;}
  .spinner-box p{font-size:9px;color:var(--mt);letter-spacing:2px;margin-top:10px;}
  /* AUTH */
  .auth-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;}
  .auth-box{background:var(--s1);border:1px solid var(--bd);border-radius:8px;
    padding:36px;width:340px;}
  .auth-logo{font-size:8px;color:var(--ac);letter-spacing:3px;font-weight:700;margin-bottom:8px;}
  .auth-box h2{font-size:18px;font-weight:700;margin-bottom:4px;}
  .auth-sub{font-size:9px;color:var(--mt);letter-spacing:1px;margin-bottom:20px;}
  .auth-err{background:rgba(255,77,77,.08);border:1px solid rgba(255,77,77,.2);
    border-radius:6px;padding:8px;font-size:9px;color:var(--rd);margin-bottom:12px;line-height:1.5;}
  .auth-switch{text-align:center;margin-top:12px;font-size:9px;color:var(--mt);}
  .auth-link{color:var(--ac);cursor:pointer;margin-left:4px;}
`;

// ── AUTH COMPONENT ─────────────────────────────────────────────────────────
function AuthScreen({ onAuth }) {
  const [mode, setMode] = useState('login');
  const [email, setEmail] = useState('');
  const [pass, setPass] = useState('');
  const [err, setErr] = useState('');
  const [busy, setBusy] = useState(false);

  const submit = async () => {
    if (!auth) { onAuth({ uid: 'local', email: 'local' }); return; }
    setErr(''); setBusy(true);
    try {
      if (mode === 'login') {
        const { data, error } = await auth.signInWithPassword?.({ email, password: pass }).catch(() => ({}));
        if (error) throw error;
        onAuth(data?.user);
      } else {
        const { data, error } = await auth.signUp?.({ email, password: pass }).catch(() => ({}));
        if (error) throw error;
        if (data?.user && data?.session) onAuth(data.user);
        else setErr('Account created — check your email for a confirmation link, then sign in.');
      }
    } catch (e) {
      let msg = e?.message || 'Authentication error';
      if (msg.toLowerCase().includes('email not confirmed'))
        msg = 'Email not confirmed. Check your inbox (and spam) for the confirmation link.';
      setErr(msg);
    }
    setBusy(false);
  };

  return (
    <div className="auth-wrap">
      <div className="auth-box">
        <div className="auth-logo">▸ MEDISYNC</div>
        <h2>MedLegal Engine</h2>
        <div className="auth-sub">{mode === 'login' ? 'SIGN IN TO YOUR ACCOUNT' : 'CREATE ACCOUNT'}</div>
        {err && <div className="auth-err">{err}</div>}
        {!auth && (
          <div className="auth-err" style={{ borderColor: 'var(--gd)', color: 'var(--gd)' }}>
            No database configured — running in local mode.
          </div>
        )}
        {auth ? <>
          <div className="fld" style={{ marginBottom: 10 }}>
            <label>Email</label>
            <input type="email" value={email} onChange={e => setEmail(e.target.value)}
              placeholder="doctor@example.com" onKeyDown={e => e.key === 'Enter' && submit()} />
          </div>
          <div className="fld" style={{ marginBottom: 14 }}>
            <label>Password</label>
            <input type="password" value={pass} onChange={e => setPass(e.target.value)}
              placeholder="Password" onKeyDown={e => e.key === 'Enter' && submit()} />
          </div>
          <button className="btn btn-teal" style={{ width: '100%', justifyContent: 'center', padding: '10px' }}
            onClick={submit} disabled={busy || !email || !pass}>
            {busy ? 'Please wait...' : mode === 'login' ? 'Sign In' : 'Create Account'}
          </button>
          <div className="auth-switch">
            {mode === 'login'
              ? <>No account?<span className="auth-link" onClick={() => { setMode('signup'); setErr(''); }}>Sign up</span></>
              : <>Have an account?<span className="auth-link" onClick={() => { setMode('login'); setErr(''); }}>Sign in</span></>
            }
          </div>
        </> : (
          <button className="btn btn-teal" style={{ width: '100%', justifyContent: 'center', padding: '10px' }}
            onClick={() => onAuth({ uid: 'local', email: 'local' })}>
            Continue in Local Mode
          </button>
        )}
      </div>
    </div>
  );
}

// ── MAIN APP ───────────────────────────────────────────────────────────────
export default function App() {
  const [view, setView] = useState('loading'); // loading | auth | dashboard | editor | preview
  const [user, setUser] = useState(null);
  const [reports, setReports] = useState([]);
  const [reportData, setReportData] = useState(null);
  const [currentChapter, setCurrentChapter] = useState(0);
  const [sbOpen, setSbOpen] = useState(true);
  const [activeRegion, setActiveRegion] = useState(null);
  const [focusedPrompt, setFocusedPrompt] = useState(null);
  const [isRecording, setIsRecording] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [liveText, setLiveText] = useState('');
  const [isSyncing, setIsSyncing] = useState(false);
  const [notif, setNotif] = useState({ show: false, msg: '', type: 'info' });

  const recRef = useRef(null);
  const accRef = useRef('');
  const isRecRef = useRef(false);
  const dataRef = useRef(null);
  const saveTimerRef = useRef(null);
  const secRef = useRef(0);

  useEffect(() => { secRef.current = currentChapter; }, [currentChapter]);

  // AUTH
  useEffect(() => {
    if (!auth) { setView('auth'); return; }
    const tryToken = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token)
          await signInWithCustomToken(auth, __initial_auth_token);
        else
          await signInAnonymously(auth);
      } catch {}
    };
    tryToken();
    const unsub = onAuthStateChanged(auth, u => {
      if (u) { setUser(u); setView('dashboard'); }
      else setView('auth');
    });
    return () => unsub();
  }, []);

  // FIREBASE REPORTS LISTENER
  useEffect(() => {
    if (!user || !db) return;
    const col = collection(db, 'artifacts', APP_ID, 'public', 'data', 'reports');
    return onSnapshot(col, snap => {
      const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      setReports(docs.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)));
    });
  }, [user]);

  // AUTO-SAVE
  useEffect(() => {
    if (!reportData || !reportData.id) return;
    dataRef.current = reportData;
    if (!db) return; // local mode: no save
    setIsSyncing(true);
    clearTimeout(saveTimerRef.current);
    saveTimerRef.current = setTimeout(async () => {
      try {
        await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'reports', reportData.id), reportData);
      } catch {}
      setIsSyncing(false);
    }, 1500);
    return () => clearTimeout(saveTimerRef.current);
  }, [reportData]);

  const notify = (msg, type = 'success') => {
    setNotif({ show: true, msg, type });
    setTimeout(() => setNotif(p => ({ ...p, show: false })), 3000);
  };

  // ── CHAPTER CONTENT HELPERS ──────────────────────────────────────────────
  const getChapterContent = useCallback((id) => {
    return reportData?.chapters?.find(c => c.id === id)?.content || '';
  }, [reportData]);

  const setChapterContent = useCallback((id, text) => {
    setReportData(prev => {
      if (!prev) return prev;
      const next = { ...prev, chapters: prev.chapters.map(c => c.id === id ? { ...c, content: text } : c) };
      dataRef.current = next;
      return next;
    });
  }, []);

  // ── DICTATION ────────────────────────────────────────────────────────────
  const finalizeDictation = useCallback(async (raw) => {
    if (!raw.trim()) return;
    const chapterId = secRef.current;
    const fp = focusedPrompt;
    setIsProcessing(true);

    const chapterTitle = CHAPTERS[chapterId]?.title || '';
    const sectionNote = fp ? ` (Focused section: ${fp})` : '';

    const corrected = await callAI(
      'You are a medical grammar scribe. Fix ONLY spelling, grammar and punctuation. NEVER change clinical facts, terminology, measurements or observations. Return ONLY the corrected text with no explanation or preamble.',
      `Chapter: "${chapterTitle}"${sectionNote}\n\nText to correct:\n${raw}`
    );

    const finalText = (corrected || raw).trim();
    const prefix = fp ? `[${fp.toUpperCase()}]:\n` : '';

    setChapterContent(chapterId, prev => {
      const existing = (prev || '').trim();
      return existing ? `${existing}\n\n${prefix}${finalText}` : `${prefix}${finalText}`;
    });

    setFocusedPrompt(null);
    notify('Dictation synced');
    setIsProcessing(false);
  }, [focusedPrompt, setChapterContent]);

  // Override setChapterContent to support functional updates
  const setChapterContentFull = useCallback((id, updaterOrValue) => {
    setReportData(prev => {
      if (!prev) return prev;
      const current = prev.chapters.find(c => c.id === id)?.content || '';
      const newVal = typeof updaterOrValue === 'function' ? updaterOrValue(current) : updaterOrValue;
      const next = { ...prev, chapters: prev.chapters.map(c => c.id === id ? { ...c, content: newVal } : c) };
      dataRef.current = next;
      return next;
    });
  }, []);

  const finalizeFixed = useCallback(async (raw) => {
    if (!raw.trim()) return;
    const chapterId = secRef.current;
    const fp = focusedPrompt;
    setIsProcessing(true);

    const chapterTitle = CHAPTERS[chapterId]?.title || '';
    const sectionNote = fp ? ` (Focused section: ${fp})` : '';

    const corrected = await callAI(
      'You are a medical grammar scribe. Fix ONLY spelling, grammar and punctuation. NEVER change clinical facts, terminology, measurements or observations. Return ONLY the corrected text with no explanation or preamble.',
      `Chapter: "${chapterTitle}"${sectionNote}\n\nText to correct:\n${raw}`
    );

    const finalText = (corrected || raw).trim();
    const prefix = fp ? `[${fp.toUpperCase()}]:\n` : '';

    setChapterContentFull(chapterId, (existing) => {
      const prev = (existing || '').trim();
      return prev ? `${prev}\n\n${prefix}${finalText}` : `${prefix}${finalText}`;
    });

    setFocusedPrompt(null);
    notify('Dictation synced ✓');
    setIsProcessing(false);
  }, [focusedPrompt, setChapterContentFull]);

  const toggleRec = useCallback(() => {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) { notify('Speech recognition requires Chrome or Edge', 'error'); return; }

    if (isRecRef.current) {
      isRecRef.current = false;
      setIsRecording(false);
      recRef.current?.stop();
      return;
    }

    const rec = new SR();
    rec.continuous = true;
    rec.interimResults = true;
    rec.lang = 'en-ZA';

    rec.onstart = () => { setLiveText(''); };
    rec.onresult = (e) => {
      let fin = '', interim = '';
      for (let i = e.resultIndex; i < e.results.length; i++) {
        if (e.results[i].isFinal) fin += e.results[i][0].transcript + ' ';
        else interim += e.results[i][0].transcript;
      }
      if (fin) accRef.current += fin;
      setLiveText(accRef.current + interim);
    };
    rec.onerror = (e) => {
      isRecRef.current = false;
      setIsRecording(false);
      const msgs = {
        'not-allowed': 'Mic blocked — click the lock icon in your address bar → Microphone → Allow',
        'no-speech': 'No speech detected',
        'network': 'Network error with speech service',
        'audio-capture': 'No microphone found'
      };
      notify(msgs[e.error] || `Mic error: ${e.error}`, 'error');
    };
    rec.onend = () => {
      if (isRecRef.current) { try { rec.start(); } catch {} return; }
      const text = accRef.current.trim();
      accRef.current = '';
      setLiveText('');
      setIsRecording(false);
      if (text) finalizeFixed(text);
    };

    accRef.current = '';
    isRecRef.current = true;
    setIsRecording(true);
    recRef.current = rec;
    try { rec.start(); }
    catch (e) { notify('Could not start microphone: ' + e.message, 'error'); isRecRef.current = false; setIsRecording(false); }
  }, [finalizeFixed]);

  // ── AI HELPERS ───────────────────────────────────────────────────────────
  const aiExtractInjuries = async () => {
    const ch3 = getChapterContent(3);
    if (!ch3.trim()) { notify('Complete Chapter 3 first', 'error'); return; }
    setIsProcessing(true);
    const res = await callAI(
      'You are an orthopaedic medico-legal specialist. Extract all injuries from the hospital records text. Format as a clean bullet list using • characters. Include each injury on its own line. Be precise and clinical.',
      ch3
    );
    if (res) setChapterContentFull(4, res.trim());
    setIsProcessing(false);
    notify('Injuries extracted ✓');
  };

  const aiSuggestDiagnosis = async () => {
    const ch6 = getChapterContent(6);
    if (!ch6.trim()) { notify('Complete Chapter 6 first', 'error'); return; }
    setIsProcessing(true);
    const res = await callAI(
      'You are an orthopaedic medico-legal specialist. Based on these clinical examination findings, provide a formal numbered diagnosis list with sub-bullets for functional outcomes. Use precise clinical terminology appropriate for a South African RAF medico-legal report.',
      ch6
    );
    if (res) setChapterContentFull(7, res.trim());
    setIsProcessing(false);
    notify('Diagnoses suggested ✓');
  };

  const aiDraftDiscussion = async () => {
    const ctx = [
      `Patient: ${reportData?.patientName || 'Unknown'}`,
      `Mechanism: ${reportData?.ref || ''}`,
      `Hospital Records: ${getChapterContent(3)}`,
      `Injuries: ${getChapterContent(4)}`,
      `Clinical Examination: ${getChapterContent(6)}`,
      `Diagnosis: ${getChapterContent(7)}`,
      `Further Treatment: ${getChapterContent(8)}`,
      `Occupational Effects: ${getChapterContent(9)}`
    ].join('\n\n');

    setIsProcessing(true);
    const res = await callAI(
      'You are a senior orthopaedic medico-legal expert writing a Discussion section for a South African Road Accident Fund (RAF) medico-legal report. Write 6-8 formal paragraphs covering: mechanism of injury, injuries sustained and hospital management, current clinical findings, long-term impairment and functional loss, qualification under Narrative Test criterion 5.1 (serious long-term impairment or loss of body function), prognosis and life expectancy. Use authoritative clinical language appropriate for court use.',
      ctx
    );
    if (res) setChapterContentFull(10, res.trim());
    setIsProcessing(false);
    notify('Discussion drafted ✓');
  };

  // ── REPORT MANAGEMENT ───────────────────────────────────────────────────
  const startNewReport = async () => {
    setIsProcessing(true);
    const initial = emptyReport();
    if (db) {
      try {
        const col = collection(db, 'artifacts', APP_ID, 'public', 'data', 'reports');
        const ref = await addDoc(col, { ...initial, createdBy: user?.uid });
        setReportData({ id: ref.id, ...initial, createdBy: user?.uid });
      } catch {
        setReportData({ id: 'local_' + Date.now(), ...initial });
      }
    } else {
      setReportData({ id: 'local_' + Date.now(), ...initial });
    }
    setCurrentChapter(0);
    setActiveRegion(null);
    setFocusedPrompt(null);
    setView('editor');
    setIsProcessing(false);
  };

  const openReport = (r) => {
    setReportData(r);
    setCurrentChapter(0);
    setActiveRegion(null);
    setFocusedPrompt(null);
    setView('editor');
  };

  // ── EXPORT ───────────────────────────────────────────────────────────────
  const exportDoc = () => {
    const name = (reportData?.patientName || 'PATIENT').replace(/\s+/g, '_').toUpperCase();
    const chapHtml = CHAPTERS.filter(c => c.id > 0).map(c => {
      const content = getChapterContent(c.id) || 'Pending.';
      return `<h2>${c.title}</h2><div class="body">${content.replace(/\n/g, '<br/>')}</div>`;
    }).join('');

    const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
<style>body{font-family:'Times New Roman',serif;font-size:11pt;margin:1in;color:#000;line-height:1.6;}
h1{text-align:center;text-transform:uppercase;font-size:14pt;text-decoration:underline;margin-bottom:20pt;}
h2{font-size:11pt;text-transform:uppercase;text-decoration:underline;margin-top:16pt;margin-bottom:6pt;}
.body{margin-left:10pt;white-space:pre-wrap;margin-bottom:14pt;}
table{border-collapse:collapse;width:100%;}td,th{border:1px solid #999;padding:4pt;}
</style></head><body>
<h1>MEDICO-LEGAL REPORT</h1>
<table style="margin-bottom:20pt"><tbody>
<tr><td><b>Our Reference:</b></td><td>${reportData?.ref || '—'}</td></tr>
<tr><td><b>Patient Name:</b></td><td><b>${reportData?.patientName || '—'}</b></td></tr>
<tr><td><b>Date of Injury:</b></td><td>${reportData?.doi || '—'}</td></tr>
<tr><td><b>Date of Examination:</b></td><td>${reportData?.doe || '—'}</td></tr>
</tbody></table>
${chapHtml}
<div style="margin-top:60pt;text-align:center">
  <p>________________________________</p>
  <p><b>${reportData?.drName || '[PRACTITIONER NAME]'}</b></p>
  <p><i>${reportData?.quals || '[QUALIFICATIONS]'}</i></p>
  <p>Orthopaedic Surgeon</p>
  <p style="font-size:9pt;margin-top:16pt;border-top:1px solid #ccc;padding-top:8pt">
    VALIDITY: This report will remain valid for use in a court of law for 2 (two) years from the date of first consultation.
  </p>
</div>
</body></html>`;

    const blob = new Blob([html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${name}_MEDLEGAL.doc`;
    a.click(); URL.revokeObjectURL(url);
    notify('Document exported ✓');
  };

  const copyHtml = () => {
    const text = CHAPTERS.filter(c => c.id > 0).map(c =>
      `${c.title}\n${getChapterContent(c.id) || '—'}`
    ).join('\n\n---\n\n');
    navigator.clipboard.writeText(text).then(() => notify('Copied to clipboard ✓'));
  };

  // ── RENDER CHAPTER CONTENT ───────────────────────────────────────────────
  const renderChapter = () => {
    const ch = CHAPTERS[currentChapter];
    const content = getChapterContent(ch.id);

    if (currentChapter === 0) {
      return (
        <div className="card">
          <div className="card-title"><span className="badge badge-teal">FORM</span>Patient & Case Details</div>
          <div className="form-grid">
            {[
              ['patientName', 'Patient Full Name'], ['ref', 'Our Reference'],
              ['doi', 'Date of Injury'], ['doe', 'Date of Examination'],
              ['dob', 'Date of Birth'], ['age', 'Current Age'],
              ['contact', 'Contact Number'], ['atty', 'Instructing Attorney'],
              ['attyCon', 'Attorney Contact'], ['poe', 'Place of Examination'],
              ['preOcc', 'Pre-Accident Occupation'], ['postOcc', 'Post-Accident Occupation'],
              ['drName', 'Practitioner Name'], ['quals', 'Qualifications']
            ].map(([k, l]) => (
              <div key={k} className="fld">
                <label>{l}</label>
                <input value={reportData?.[k] || ''} onChange={e => setReportData(p => ({ ...p, [k]: e.target.value }))} />
              </div>
            ))}
            <div className="fld">
              <label>Gender</label>
              <select value={reportData?.gender || 'Male'} onChange={e => setReportData(p => ({ ...p, gender: e.target.value }))}>
                <option>Male</option><option>Female</option><option>Other</option>
              </select>
            </div>
            <div className="fld">
              <label>Residential Address</label>
              <textarea rows={2} value={reportData?.address || ''} onChange={e => setReportData(p => ({ ...p, address: e.target.value }))} />
            </div>
          </div>
        </div>
      );
    }

    if (currentChapter === 9) {
      return (
        <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
          {[['Basic ADL', ADL_BASIC, 'basic'], ['Advanced ADL', ADL_ADV, 'advanced']].map(([title, items, type]) => (
            <div key={type} className="card">
              <div className="card-title"><span className="badge badge-teal">ADL</span>{title}</div>
              <div style={{ overflowX: 'auto' }}>
                <table className="adl-table">
                  <thead>
                    <tr>
                      <th style={{ textAlign: 'left', minWidth: 160 }}>Activity</th>
                      {ADL_OPTS.map(o => <th key={o} style={{ minWidth: 50 }}>{o}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {items.map(act => (
                      <tr key={act}>
                        <td style={{ textAlign: 'left' }}>{act}</td>
                        {ADL_OPTS.map(o => (
                          <td key={o}>
                            <input type="radio"
                              name={`${type}_${act}`} value={o}
                              checked={(reportData?.adl?.[type]?.[act] || 'None') === o}
                              onChange={() => setReportData(p => ({
                                ...p,
                                adl: { ...p.adl, [type]: { ...(p.adl?.[type] || {}), [act]: o } }
                              }))}
                              style={{ accentColor: 'var(--ac)', cursor: 'pointer' }}
                            />
                          </td>
                        ))}
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          ))}
          <div className="card">
            <div className="card-title"><span className="badge badge-teal">9.2</span>Occupational Effects & Limitations</div>
            <textarea className="big" value={content}
              onChange={e => setChapterContentFull(9, e.target.value)}
              placeholder="Dictate or type occupational effects and limitations..." />
          </div>
        </div>
      );
    }

    return (
      <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
        {/* Step selector for Ch3 */}
        {ch.id === 3 && ch.steps && (
          <div className="card accent">
            <div className="card-title"><span className="badge badge-teal">TARGET</span>Select Sub-Section for Dictation</div>
            <div className="steps">
              {ch.steps.map(s => (
                <button key={s} className={`step-btn ${focusedPrompt === s ? 'on' : ''}`}
                  onClick={() => { setFocusedPrompt(s); notify(`Focus: ${s}`); }}>
                  {s}
                  {focusedPrompt === s && <CheckCircle2 size={10} />}
                </button>
              ))}
            </div>
          </div>
        )}

        {/* MSK region selector for Ch6 */}
        {ch.type === 'msk' && (
          <div className="card accent">
            <div className="card-title"><span className="badge badge-teal">MSK</span>Select Region</div>
            <div className="chips">
              {MSK_REGIONS.map(r => {
                const hasData = content.includes(`[${r.name.toUpperCase()}`);
                return (
                  <div key={r.name}
                    className={`chip ${activeRegion?.name === r.name ? 'on' : ''} ${hasData ? 'has' : ''}`}
                    onClick={() => { setActiveRegion(r); setFocusedPrompt(null); }}>
                    {r.name}{hasData ? ' ✓' : ''}
                  </div>
                );
              })}
            </div>
            {activeRegion && (
              <div>
                <div style={{ fontSize: 8, color: 'var(--mt)', letterSpacing: '1px', marginBottom: 8 }}>
                  SELECT EXAMINATION PROMPT
                </div>
                <div className="msk-prompts">
                  {activeRegion.prompts.map(p => (
                    <button key={p} className={`prompt-btn ${focusedPrompt === p ? 'on' : ''}`}
                      onClick={() => { setFocusedPrompt(p); notify(`Focus: ${activeRegion.name} — ${p}`); }}>
                      {p}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* AI action buttons */}
        {(ch.id === 4 || ch.id === 7 || ch.id === 10) && (
          <div className="card gold">
            <div className="card-title"><span className="badge badge-gold">AI</span>Smart Actions</div>
            <div style={{ display: 'flex', gap: 8, flexWrap: 'wrap' }}>
              {ch.id === 4 && (
                <button className="btn btn-gold" onClick={aiExtractInjuries} disabled={isProcessing}>
                  <Sparkles size={12} /> Auto-Extract from Ch. 3
                </button>
              )}
              {ch.id === 7 && (
                <button className="btn btn-pu" onClick={aiSuggestDiagnosis} disabled={isProcessing}>
                  <Lightbulb size={12} /> AI Suggest Diagnoses
                </button>
              )}
              {ch.id === 10 && (
                <button className="btn btn-gold" onClick={aiDraftDiscussion} disabled={isProcessing}>
                  <Wand2 size={12} /> AI Draft Discussion
                </button>
              )}
            </div>
          </div>
        )}

        {/* Main content textarea — CONTROLLED, always reflects state */}
        <div className="card">
          <div className="card-title" style={{ marginBottom: 6 }}>
            <span className="badge badge-teal">CONTENT</span>
            {focusedPrompt && (
              <span className="focus-chip">
                <div style={{ width: 5, height: 5, borderRadius: '50%', background: 'var(--ac)', animation: 'blink .6s infinite' }} />
                {activeRegion ? `${activeRegion.name} — ${focusedPrompt}` : focusedPrompt}
              </span>
            )}
          </div>
          <textarea
            className="big"
            value={content}
            onChange={e => setChapterContentFull(ch.id, e.target.value)}
            placeholder={`Dictate or type content for ${ch.title}...`}
            style={{ minHeight: 280 }}
          />
        </div>
      </div>
    );
  };

  // ── PREVIEW RENDER ────────────────────────────────────────────────────────
  const renderPreview = () => {
    const adlTableHtml = (title, items, type) => {
      const rows = items.map(act => {
        const val = reportData?.adl?.[type]?.[act] || 'None';
        return `<tr><td>${act}</td>${ADL_OPTS.map(o => `<td style="text-align:center">${val === o ? '✓' : ''}</td>`).join('')}</tr>`;
      }).join('');
      return `<h3>${title}</h3><table><thead><tr><th>Activity</th>${ADL_OPTS.map(o => `<th>${o}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>`;
    };

    return (
      <div className="preview">
        <div className="preview-toolbar">
          <div style={{ fontSize: 10, color: 'var(--mt)', letterSpacing: '2px' }}>
            REPORT PREVIEW — {reportData?.patientName || 'PATIENT'}
          </div>
          <button className="btn btn-ghost" onClick={() => setView('editor')}>
            <ChevronLeft size={12} /> Back to Editor
          </button>
        </div>
        <div className="preview-doc">
          <div style={{ display: 'flex', justifyContent: 'space-between', borderBottom: '2px solid #111', paddingBottom: 16, marginBottom: 24 }}>
            <div style={{ fontSize: 28, fontWeight: 700, fontStyle: 'italic', color: '#bbb', letterSpacing: -2 }}>[PRACTICE LOGO]</div>
            <div style={{ textAlign: 'right', fontSize: '9pt' }}>
              <div style={{ fontWeight: 700, fontSize: '11pt' }}>{reportData?.drName || '[PRACTITIONER NAME]'}</div>
              <div style={{ fontStyle: 'italic' }}>{reportData?.quals || '[QUALIFICATIONS]'}</div>
            </div>
          </div>
          <h1>Medico-Legal Report</h1>
          <table style={{ marginBottom: 20 }}><tbody>
            {[['Our Reference', reportData?.ref], ['Attorney Reference', ''], ['Patient Full Name', reportData?.patientName],
              ['Date of Birth', reportData?.dob], ['Age', reportData?.age], ['Gender', reportData?.gender],
              ['Residential Address', reportData?.address], ['Contact', reportData?.contact],
              ['Date of Injury', reportData?.doi], ['Mechanism', 'Motor Vehicle Accident'],
              ['Pre-Accident Occupation', reportData?.preOcc], ['Post-Accident Occupation', reportData?.postOcc],
              ['Date of Examination', reportData?.doe], ['Place of Examination', reportData?.poe],
              ['Instructing Attorney', reportData?.atty], ['Attorney Contact', reportData?.attyCon]
            ].map(([k, v]) => v !== undefined ? (
              <tr key={k}><td style={{ fontWeight: 700, width: '200px', padding: '3px 6px', border: '1px solid #bbb' }}>{k}:</td>
                <td style={{ padding: '3px 6px', border: '1px solid #bbb' }}>{v || '—'}</td></tr>
            ) : null)}
          </tbody></table>

          {CHAPTERS.filter(c => c.id > 0).map(c => (
            <div key={c.id} style={{ marginBottom: 16 }}>
              <h2>{c.title}</h2>
              {c.id === 9 ? (
                <div dangerouslySetInnerHTML={{ __html: adlTableHtml('Basic Activities of Daily Living', ADL_BASIC, 'basic') + adlTableHtml('Advanced Activities of Daily Living', ADL_ADV, 'advanced') }} />
              ) : (
                <div style={{ whiteSpace: 'pre-wrap', paddingLeft: 12 }}>{getChapterContent(c.id) || 'No content entered.'}</div>
              )}
            </div>
          ))}

          <div style={{ marginTop: 60, paddingTop: 20, borderTop: '1px solid #ccc', textAlign: 'center' }}>
            <p>________________________________</p>
            <p><strong>{reportData?.drName || '[PRACTITIONER NAME]'}</strong></p>
            <p><em>{reportData?.quals || '[QUALIFICATIONS]'}</em></p>
            <p>Orthopaedic Surgeon</p>
            <p style={{ fontSize: '9pt', marginTop: 12, color: '#666' }}>
              VALIDITY: This report will remain valid for use in a court of law for 2 (two) years from the date of first consultation.
            </p>
          </div>
        </div>
        <div className="preview-actions">
          <button className="action-btn" style={{ background: '#7c3aed' }} onClick={copyHtml} title="Copy text">
            <Copy size={20} color="white" />
          </button>
          <button className="action-btn" style={{ background: 'var(--ac2)' }} onClick={exportDoc} title="Export .doc">
            <Download size={20} color="white" />
          </button>
          <button className="action-btn" style={{ background: '#111' }} onClick={() => window.print()} title="Print">
            <Printer size={20} color="white" />
          </button>
        </div>
      </div>
    );
  };

  // ── MAIN RENDER ───────────────────────────────────────────────────────────
  if (view === 'loading') return (
    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100vh', background: 'var(--bg)' }}>
      <Loader2 size={24} color="var(--ac)" style={{ animation: 'spin 1s linear infinite' }} />
      <style>{`@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}`}</style>
    </div>
  );

  if (view === 'auth') return (
    <>
      <style>{CSS}</style>
      <AuthScreen onAuth={u => { setUser(u); setView('dashboard'); }} />
    </>
  );

  return (
    <>
      <style>{CSS}</style>
      <div className="app">
        {/* HEADER */}
        <header className="hdr">
          <div className="hdr-logo">
            {view === 'editor' && (
              <button className="btn btn-ghost" style={{ padding: '5px 8px' }} onClick={() => setSbOpen(p => !p)}>
                <Menu size={14} />
              </button>
            )}
            <div className="hdr-icon"><Stethoscope size={16} color="white" /></div>
            <div>
              <div className="hdr-title">MediSync <span>Ortho</span></div>
              <div className="hdr-sync">
                <div className={`sync-dot ${isSyncing ? 'active' : 'done'}`} />
                {isSyncing ? 'SYNCING' : db ? 'CLOUD SAVED' : 'LOCAL MODE'}
              </div>
            </div>
          </div>
          <div className="hdr-btns">
            {view === 'editor' && (
              <button className="btn btn-ghost" style={{ fontSize: 9 }} onClick={() => setView('preview')}>
                <FileText size={12} /> Preview
              </button>
            )}
            {view === 'preview' && (
              <button className="btn btn-ghost" style={{ fontSize: 9 }} onClick={() => setView('editor')}>
                <ChevronLeft size={12} /> Editor
              </button>
            )}
            {(view === 'editor' || view === 'preview') && (
              <button className="btn btn-ghost" style={{ fontSize: 9 }}
                onClick={() => { setView('dashboard'); setReportData(null); }}>
                Exit
              </button>
            )}
          </div>
        </header>

        {/* BODY */}
        <div className="body" style={{ flex: 1, overflow: 'hidden' }}>
          {view === 'dashboard' && (
            <div className="dash">
              <div className="dash-head">
                <div>
                  <div className="dash-title">Patient Reports</div>
                  <div className="dash-sub">MEDLEGAL WORKFLOW SYSTEM</div>
                </div>
                <button className="btn btn-teal" onClick={startNewReport} disabled={isProcessing}>
                  <UserPlus size={13} /> New Report
                </button>
              </div>
              <div className="report-grid">
                <div className="new-card" onClick={startNewReport}>
                  + NEW CASE
                </div>
                {reports.map(r => (
                  <div key={r.id} className="rpt-card" onClick={() => openReport(r)}>
                    <div style={{ fontSize: 8, color: 'var(--ac)', letterSpacing: '1px', marginBottom: 8 }}>
                      CASE #{r.id.slice(-6).toUpperCase()}
                    </div>
                    <div className="rpt-name">{r.patientName || 'Unnamed Patient'}</div>
                    <div className="rpt-ref">{r.ref || 'No reference'}</div>
                    <div className="rpt-foot">
                      <span className="tag">{r.doi ? `DOI: ${r.doi}` : new Date(r.createdAt).toLocaleDateString('en-ZA')}</span>
                      <ChevronRight size={12} color="var(--mt)" />
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {view === 'editor' && reportData && (
            <>
              {/* SIDEBAR */}
              <aside className={`sb ${sbOpen ? '' : 'closed'}`}>
                <div className="sb-head">
                  <div className="sb-label">▸ MEDISYNC</div>
                  <div className="sb-sub">ACTIVE CHAPTERS</div>
                </div>
                <div className="sb-list">
                  {CHAPTERS.map((c, i) => (
                    <div key={i}
                      className={`nav-item ${currentChapter === i ? 'on' : ''}`}
                      onClick={() => { setCurrentChapter(i); setFocusedPrompt(null); setActiveRegion(null); }}>
                      <span className="nav-num">{String(i).padStart(2, '0')}</span>
                      {c.title.replace(/^Ch \d+: /, '')}
                    </div>
                  ))}
                </div>
              </aside>

              {/* MAIN EDITOR */}
              <div className="main" style={{ position: 'relative' }}>
                <div className="content">
                  <div className="ch-hdr">
                    <div className="ch-num">CHAPTER {currentChapter.toString().padStart(2, '0')}</div>
                    <div className="ch-title">{CHAPTERS[currentChapter].title}</div>
                    <div className="ch-bar" />
                  </div>
                  {renderChapter()}
                </div>

                {/* BOTTOM DICTATION BAR */}
                <div className="bot-bar">
                  <div className="bot-inner">
                    <button className="nav-btn" onClick={() => setCurrentChapter(p => Math.max(0, p - 1))}>
                      <ChevronLeft size={16} />
                    </button>
                    <button
                      className={`dic-btn ${isProcessing ? 'proc' : isRecording ? 'rec' : 'idle'}`}
                      onClick={isProcessing ? undefined : toggleRec}
                      disabled={isProcessing}>
                      {isProcessing
                        ? <><Loader2 size={14} style={{ animation: 'spin 1s linear infinite' }} /> Processing...</>
                        : isRecording
                          ? <><MicOff size={14} /> Stop & Sync</>
                          : <><Mic size={14} /> Dictate Findings</>
                      }
                    </button>
                    <button className="nav-btn"
                      onClick={() => currentChapter < 10 ? setCurrentChapter(p => p + 1) : setView('preview')}
                      style={{ background: currentChapter === 10 ? 'var(--ac2)' : undefined,
                               borderColor: currentChapter === 10 ? 'var(--ac2)' : undefined,
                               color: currentChapter === 10 ? '#fff' : undefined }}>
                      <ChevronRight size={16} />
                    </button>
                  </div>
                  {isRecording && (
                    <div className="live-box" style={{ maxWidth: 700, margin: '6px auto 0' }}>
                      <span className="live-dot" />
                      {focusedPrompt ? <strong>{activeRegion ? `${activeRegion.name} — ` : ''}{focusedPrompt}: </strong> : ''}
                      {liveText || 'Listening — speak now...'}
                    </div>
                  )}
                </div>
              </div>
            </>
          )}

          {view === 'preview' && reportData && renderPreview()}
        </div>

        {/* NOTIFICATION */}
        {notif.show && (
          <div className={`notif ${notif.type}`}>
            <CheckCircle2 size={12} />
            {notif.msg}
          </div>
        )}

        {/* PROCESSING OVERLAY */}
        {isProcessing && (
          <div className="overlay">
            <div className="spinner-box">
              <Loader2 size={36} color="var(--ac)" style={{ animation: 'spin 1s linear infinite' }} />
              <p>SYNTHESISING</p>
            </div>
          </div>
        )}
        <style>{`@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}`}</style>
      </div>
    </>
  );
}
